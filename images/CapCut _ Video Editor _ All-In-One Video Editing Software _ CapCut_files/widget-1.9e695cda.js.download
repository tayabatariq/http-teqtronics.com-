"use strict";(globalThis.__LOADABLE_LOADED_CHUNKS__=globalThis.__LOADABLE_LOADED_CHUNKS__||[]).push([["8966"],{150818:function(e,t,i){i.d(t,{Z:function(){return n}});let n={"canvas-empty":"canvas-empty-LscmyR",canvasEmpty:"canvas-empty-LscmyR","dashed-lines":"dashed-lines-sqtY6v",dashedLines:"dashed-lines-sqtY6v",dropzone:"dropzone-P8h2MQ",dashed:"dashed-bxlIX7",active:"active-hvhFif","file-cover":"file-cover-wvRqfj",fileCover:"file-cover-wvRqfj","file-cover-image":"file-cover-image-hLQVwG",fileCoverImage:"file-cover-image-hLQVwG","file-cover-spin":"file-cover-spin-jgwnUO",fileCoverSpin:"file-cover-spin-jgwnUO","readonly-empty":"readonly-empty-NbbwQV",readonlyEmpty:"readonly-empty-NbbwQV","readonly-empty-text":"readonly-empty-text-QkHSYW",readonlyEmptyText:"readonly-empty-text-QkHSYW","is-empty-canvas":"is-empty-canvas-ftAUcw",isEmptyCanvas:"is-empty-canvas-ftAUcw","is-empty-canvas__original":"is-empty-canvas__original-lkoHN3",isEmptyCanvasOriginal:"is-empty-canvas__original-lkoHN3","placeholder-upload-inner":"placeholder-upload-inner-p_bcEP",placeholderUploadInner:"placeholder-upload-inner-p_bcEP","upload-active":"upload-active-yQYIxd",uploadActive:"upload-active-yQYIxd",flowLight:"flowLight-VYyIpS"}},974954:function(e,t,i){i.d(t,{Z:function(){return n}});let n={"player-progress-slider":"player-progress-slider-Fg9NNu",playerProgressSlider:"player-progress-slider-Fg9NNu","player-progress-slider-bar":"player-progress-slider-bar-OdLZuV",playerProgressSliderBar:"player-progress-slider-bar-OdLZuV"}},631175:function(e,t,i){i.d(t,{Z:function(){return n}});let n={"editor-widget-modal":"editor-widget-modal-gvIdXB",editorWidgetModal:"editor-widget-modal-gvIdXB"}},570175:function(){},74361:function(){},17886:function(e,t,i){i.d(t,{Z:function(){return n}});let n={"move-template-slot-toast":"move-template-slot-toast-BWMLmk",moveTemplateSlotToast:"move-template-slot-toast-BWMLmk","more-handle":"more-handle-YO1zOI",moreHandle:"more-handle-YO1zOI"}},86042:function(){},893426:function(){},918702:function(e,t,i){i.d(t,{Z:function(){return n}});let n={"timeline-loading":"timeline-loading-Jz2dQ2",timelineLoading:"timeline-loading-Jz2dQ2","image-wrapper":"image-wrapper-fwQfeT",imageWrapper:"image-wrapper-fwQfeT","timeline-loading-text":"timeline-loading-text-HB57E3",timelineLoadingText:"timeline-loading-text-HB57E3"}},848094:function(e,t,i){e.exports=i.p+"static/audio_metrics_v1.4.ac4d7f0c.model"},182982:function(e,t,i){e.exports=i.p+"static/en.ttf.6a6701a3.zip"},400989:function(e){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAflSURBVHgBxVpbiFVVGN5n5jjOjDoXiDALskhDIwqFKCEsuwdRJPSQ5JMPkVGWDwZBRg9hBF1ACgNDoh6itCKhh6RI6C3sMmUkFQV2oR4yKec+p+/bZ3+n7/yz9jlnBrMF3/z77Fl7rf9b/2Vd9q5kp6HUarUhiBXAWmAdcCmwFBgE+lgFGAVOAD8BXwOHgSPA0UqlMp79XwXKdwFrgaeAb2rzK5PAEWA3sCI7k6UgcC3wETBKbWZmZnJMT0/nmJqaamBycjKH31M9PUegjANvAOvZRzbHUplLZXRwIcRu4Aagit+8l0GRTNcRxXMZ3Ce/7urqyq8JvxZQJoA3gUfx+4dOdeuYCJTZAfEIMOQEIpwYZaOjfxXNCbRCUcaAbXhmTyf6tSUChc6CeA7YxN+uNNyjIam4fjuZps5s5Lu7uxuSylNWq9WGpYzQXuAB3D+VzZcIFGHmeQ3YICtIWfh6ExEn59YQGVnDyYiA5IIFC3Kpe3I9lA+BO3F9Ys5EoMA5EO8Ca32UqSjhRHjthGLcNHWYcC8pLiKUtI4sVOB9PLYZ8teOiaDzfohDwFWRgEiUEXEy0cViwPvIyxIi0tPT0yBkrnYQ2IhnJzol8jrEXU7ClS+T0dVSlkm5lZORVUjEIeugvAC5NepcTZB4KEUiKoy5IXntMZLKaE4kkqGy7IPSB0OWLOreh3tf4t6LpRZBheVZffnQ6ySoaCSjeyk386QQiUixGOgi4u5F9Pb2ZosWLcoWLlzYcDWU48B6tPP9LIsUs+mzTiLCRz4SjG6luIlZreirEStKuyLiLkb4M5bJzgOexL27IWeia10P3Opu4bHhFnESXi8SiNkslclioLuL6XnVc8IoG4E1wCcNIoU1tgM9KRIxW0VL+LXfS5FoNVFGZWkR9qVnwhxTxTPbcX8TrSKLrKZFPGWWpduUwmWkUrM+FU6RcQuJiIJedRkvjBVlNZTbgUuAERG5l23EbOPKpBSN7hTdzTOPFPKFZJQkKanY8QEgkb6+vtxSRT3udW7OiRST34aUNXwpkkqzUj5aINZJzSeSvrDUb89sap+FBEiEVuG9wiW34F9PVwu3WqnGNXrtlIsWE+ky10ot72MWcx1EXumcpEhgbGwsJ6dJkrrj/+fz6gqgOxJIKdmKWCqOVNdHOhJwC0U4EY4+iYyOjjasxP/TBVFuJJGrfTTKRjzO2GWkPHZS2SqlfIpInEypMK1BIhMTE40BKsoqElmhhrzTqGS8F1NrREy7bpkY5NHdYrxSksT4+HgOWd5cciWJLPMGU0q1+l9UuuxaBKKM7ub33W1pEVqCkGsZkYtIZDBmjHYKlflzJJd6riwe4mCy+PNxTRdWCEtJpD824g1Hi3RCIrpoyrIpa6T6SWU/17Eog6llfKnSnYxmai6K7uWBmooN79/r+slLKPkS5ZSs4grF6/hwJ5nHU3ocyWiFFAld+yrZNlheTpLICRFRhTK/9XsutbTwa5GILiYSrYiojp7n0sR3igmr/E4ivwHLUiMeAqpJ+fjbz61EZmZmptTHnVQkoHb1P+3hnUTQ9xiJfApc7srEiilCvsvThEVl/RiHMmY/t1a0TiRGcDYXibjHNx2Pch9y2El4pQTzWWQ9AH2T5B27hXyjpjkhtWUWad8KxwE03b6gRT7zChGuLDtoRaRY9zSNrNeRdX0Jk7K29NFg+GD61ri4PwUcIpFvaRpgtY+oK+d7ghgLIsh6ngToDt6eDg5SFnAicU/Cdvx41c+7Cj1GeGjH7eJfePAtyNXRNdiRx0HKGupAbuCZT4qx+MDIxTw1OxlPucxYCnbGC/cjTg7lHf7RhPgqsB0P9zoJXadmZztkzkuxN2gKXHcrJQK1F90rztYiTSL9/f2NYyERKQbmJKrucyLHcPNj4Dp1VLbKFRGPByej0VRx1/Ms5vvxVKzoLFgEBgYGssHBwfya94s+3obOPzaI8BQCjTyBf66HrMqnnYCPlBd3MW0/RUQkpKjHm6Ss6BZRoHPkSWTJkiXZ0NBQToQWKeKD57/PNAbRFDqMhg5C3uEBKsuwRNO78tECnig0b3i8xflC9URCcUG3IoHh4eHcGuZW+4DPG/r46NbqrxKOotEhnV9pM1OW8+N2113FFW610XJLiKyCe/HixTkJkqF7FZMjXy1cKbdqskjR0C9odAca26Pgjb5bSbyo8f1zao1Vtt6K84cvDqkw3UhuRctYbNzvJGYRKRR9CR1cjAcelnvFEYuptGwfEq1TtkD0trXCVZCTiFyqSBi7UHf/LL2zRKnV3xu+gs5vUWDKtYRW+42U0jEzpaysTCVr0Ao6kCtIvIfqt6HudEdEio6GIQ5CgXV+GCcSqXeIKeWldLRCXDWLBMHYoEUIW44wEd1TKXmP2O5lKMkcgLzG5xYn4iTK3CdlhUjCY0PLEFvzHUD1Laj7R5munbye5sz3PORWVzg1YbZzoVYk/LWbr26Bnai+q5J4bzgnIkZoMwS/O1maykTtgjlFQgkjvkcs6hwHHgQOdKLfXD/hWA7xGLAJ1z3tgjnlSpGILzSL31yWvww8zukg+y8LFFwD7Af+BmZ9VDMdPqyJmE58VAOcQlN7gcuyM1lq9a+EeBK+E/iqVv9kaT5lBNgGXFCbx1dBKnNyrTbEzoW4Kau/QVqV1c+UzwYGAObhPwEuLb7L6hu5EeADuM/P2Wko/wCRjuFQs90z8wAAAABJRU5ErkJggg=="},959264:function(e,t,i){i.d(t,{Z:function(){return n}}),i(772322),i(218571);let n="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTAgNEMwIDEuNzkwODYgMS43OTA4NiAwIDQgMEgxMkMxNC4yMDkxIDAgMTYgMS43OTA4NiAxNiA0VjEyQzE2IDE0LjIwOTEgMTQuMjA5MSAxNiAxMiAxNkg0QzEuNzkwODYgMTYgMCAxNC4yMDkxIDAgMTJWNFoiIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjAuNCIvPgo8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTExLjg3NTkgMy43OTA2OEMxMS44MTIxIDMuNjg3NjcgMTEuNjk5NiAzLjYyNSAxMS41Nzg0IDMuNjI1SDQuNDIxMjdDNC4zMDAxIDMuNjI1IDQuMTg3NTUgMy42ODc2NyA0LjEyMzc0IDMuNzkwNjhMMi40NTg3MyA2LjQ3ODI5QzIuMzczIDYuNjE2NjcgMi4zOTM5OSA2Ljc5NTg3IDIuNTA5MzYgNi45MTA3TDcuNzUyOTMgMTIuMTI5M0M3Ljg4OTQ4IDEyLjI2NTIgOC4xMTAxOCAxMi4yNjUyIDguMjQ2NzMgMTIuMTI5M0w4LjM2NzYxIDEyLjAwOUM4LjQ5NjM4IDExLjg4MDggOC41MDU3NSAxMS42NzU0IDguMzg4MzEgMTEuNTM2OEM4LjEzODM0IDExLjI0MTcgNy45MTM3OSAxMC45ODI1IDcuNzYyMzggMTAuODA5MUM3LjM0OTcgMTAuMzM2NCA3LjM3NDc0IDkuNjI1NTUgNy44MTg0MSA5LjE4Mjg2QzguMjI4MjYgOC43NzM5MiA4Ljg3MzAyIDguNzE5NDggOS4zNDU2MyA5LjA1MzkxTDkuODQ3NDUgOS40MDkwMUM5Ljk4NzIyIDkuNTA3OTIgMTAuMTc3NyA5LjQ5MDkyIDEwLjMwMDMgOS4zNzEzM0MxMS4wMTY4IDguNjcyMDUgMTIuMDQ4NCA3Ljc4ODExIDEzLjMyIDcuMDMwMzhDMTMuMzM2MiA3LjAyMDc0IDEzLjM1MjUgNy4wMTE1OSAxMy4zNjg5IDcuMDAyOTJDMTMuNDA1OCA2Ljk4MzQ2IDEzLjQ0MDcgNi45NjAwOSAxMy40NzAyIDYuOTMwNjhMMTMuNDkwMyA2LjkxMDdDMTMuNjA1NyA2Ljc5NTg3IDEzLjYyNjcgNi42MTY2NyAxMy41NDA5IDYuNDc4MjlMMTEuODc1OSAzLjc5MDY4Wk05LjU4NTAyIDEwLjc5NzRDOS43MzkgMTAuNjQ0MSA5LjcxNzYzIDEwLjM4OTEgOS41NDAzIDEwLjI2MzZMOC44NDAyIDkuNzY4MTdDOC43MTUyNSA5LjY3OTc2IDguNTQ0OCA5LjY5NDE1IDguNDM2NDQgOS44MDIyNkM4LjMxODYgOS45MTk4NCA4LjMxMjA1IDEwLjEwODIgOC40MjE1MyAxMC4yMzM2TDguNDcwODIgMTAuMjkwMkM4LjU0MzA3IDEwLjM3MzEgOC42Mjg1MiAxMC40NzE3IDguNzIzMjMgMTAuNTgxN0M4LjgzODAzIDEwLjcxNSA4Ljk2NjQ0IDEwLjg2NTIgOS4xMDE0NiAxMS4wMjVDOS4xNjQxMiAxMS4wOTkxIDkuMjc2NzcgMTEuMTA0MSA5LjM0NTU3IDExLjAzNTdMOS41ODUwMiAxMC43OTc0Wk0xMC40ODk3IDguMTA2ODRDMTAuNDg5NyA3LjE4NDAyIDkuNTE1OTEgNi4xOTE5NyA4LjU0Njg4IDYuMTkxOTdDOS41MjYzMSA2LjE5MTk3IDEwLjQ4OTcgNS4yMTgzNiAxMC40ODk3IDQuMjU2ODRDMTAuNDg5NyA1LjIxNzkzIDExLjQ2NjQgNi4xOTE5NyAxMi40MTQ3IDYuMTkxOTdDMTEuNDY2NCA2LjE5MTk3IDEwLjQ4OTcgNy4xODkyMiAxMC40ODk3IDguMTA2ODRaIiBmaWxsPSIjRUZGMUYyIi8+CjxwYXRoIGQ9Ik0xNC4wMTk0IDcuODY3NThDMTMuOTgwMSA3Ljc2ODMzIDEzLjg2MTkgNy43MjY5OSAxMy43NzAyIDcuNzgxNjJDMTIuMDUxMSA4LjgwNTk0IDEwLjc4OSAxMC4wODE5IDEwLjIwNzMgMTAuNzMzNUw4Ljg0MjQzIDkuNzY3NzRDOC43MTc0OCA5LjY3OTMzIDguNTQ3MDMgOS42OTM3MiA4LjQzODY3IDkuODAxODNDOC4zMjA4NCA5LjkxOTQxIDguMzE0MjggMTAuMTA3OCA4LjQyMzc2IDEwLjIzMzJDOC43NjAyOCAxMC42MTg3IDkuNDY3MDIgMTEuNDM3OSAxMC4wMTY4IDEyLjE0MDVDMTAuMTY1MiAxMi4zMyAxMC40NTcgMTIuMzI0NiAxMC41OTU4IDEyLjEyNzlDMTEuNDM0MiAxMC45Mzg5IDEyLjM2MzggOS43Nzg3MyAxNC4wMDM0IDguMTEzMjVDMTQuMDUyMSA4LjA2MzggMTQuMDY3NyA3Ljk4OTczIDE0LjA0MjIgNy45MjUyTDE0LjAxOTQgNy44Njc1OFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo="},10879:function(e,t,i){i.d(t,{Z:function(){return n}}),i(772322),i(218571);let n="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTAgNEMwIDEuNzkwODYgMS43OTA4NiAwIDQgMEgxMkMxNC4yMDkxIDAgMTYgMS43OTA4NiAxNiA0VjEyQzE2IDE0LjIwOTEgMTQuMjA5MSAxNiAxMiAxNkg0QzEuNzkwODYgMTYgMCAxNC4yMDkxIDAgMTJWNFoiIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjAuNCIvPgo8ZyBjbGlwLXBhdGg9InVybCgjY2xpcDBfMTIyOV84NDMzNTcpIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xMS41NDQ5IDMuNjI1QzExLjY4MzQgMy42MjUgMTEuODEyMSAzLjY5NjYyIDExLjg4NSAzLjgxNDM0TDEzLjUxNDQgNi40NDQ1NEMxMy42MTI0IDYuNjAyNjggMTMuNTg4NCA2LjgwNzQ4IDEzLjQ1NjUgNi45Mzg3MUw4LjI3NjM5IDEyLjA5NDJDOC4xMjAzNCAxMi4yNDk1IDcuODY4MTEgMTIuMjQ5NSA3LjcxMjA2IDEyLjA5NDJMMi41MzE5IDYuOTM4NzFDMi40MDAwNSA2LjgwNzQ4IDIuMzc2MDcgNi42MDI2OCAyLjQ3NDA0IDYuNDQ0NTRMNC4xMDM0NyAzLjgxNDM0QzQuMTc2NCAzLjY5NjYyIDQuMzA1MDIgMy42MjUgNC40NDM1IDMuNjI1SDExLjU0NDlaTTEwLjExNDggOC44ODk5OEMxMC4xMTQ4IDcuNzY0MDEgOC45MjY2IDYuNTUzNTQgNy43NDQyMyA2LjU1MzU0QzguOTM5MjkgNi41NTM1NCAxMC4xMTQ4IDUuMzY1NiAxMC4xMTQ4IDQuMTkyMzhDMTAuMTE0OCA1LjM2NTA2IDExLjMwNjUgNi41NTM1NCAxMi40NjM2IDYuNTUzNTRDMTEuMzA2NSA2LjU1MzU0IDEwLjExNDggNy43NzAzNiAxMC4xMTQ4IDguODg5OThaIiBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwLjkiLz4KPC9nPgo8ZGVmcz4KPGNsaXBQYXRoIGlkPSJjbGlwMF8xMjI5Xzg0MzM1NyI+CjxyZWN0IHdpZHRoPSIxNCIgaGVpZ2h0PSIxNCIgZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEgMSkiLz4KPC9jbGlwUGF0aD4KPC9kZWZzPgo8L3N2Zz4K"},517847:function(e,t,i){i.d(t,{W:function(){return r}});var n,r=((n={}).Mouse="mouse",n.Hand="hand",n)},450029:function(e,t,i){i.d(t,{G:function(){return r}});var n,r=((n={})[n.Default=0]="Default",n[n.Mask=1]="Mask",n[n.Video=2]="Video",n[n.Tracking=3]="Tracking",n)},329076:function(e,t,i){i.d(t,{m:function(){return a}});var n=i(334769),r=i(218571);function a(e){let t=(0,n.F)(e);return(0,r.useCallback)(e=>t.draftView.getSegmentById(e),[t])}},58236:function(e,t,i){i.d(t,{s:function(){return I}});var n=i(789786),r=i(772322),a=i(183609),s=i(446835),o=i(199908),l=i(356515),d=i(896413),c=i(108692),u=i(484829),h=i(797913),g=i(402655),m=i(781566),f=i(426336),p=i(254336),v=i(374904),_=i(230689),S=i(801497),y=i(150564),x=i(692474),b=i(493362),M=i(257118);let T=`${v.NF.image.accept},${v.NF.video.accept}`;class I extends g.JT{_setAsOverlay(e){let t=this._mainDraftService.dataSdk.draftView.getCanvasConfig();(0,b.jQ)({dataSdk:this._mainDraftService.dataSdk,renderManager:this._mainEditorWidgetService.renderManager,selectedSegment:this._selection.getSelectedSingleSegment(),timelineManager:this._mainEditorWidgetService.timelineManager,selection:this._mainEditorWidgetService.selection,canvasSize:[t.width,t.height],pos:e})}get _shouldShowFill(){var e,t,i,n,r;let{clip:a}=this._selection.getSelectedSingleSegment()||{},s=!!(null!==(r=null==a?void 0:null===(e=a.transform)||void 0===e?void 0:e.x)&&void 0!==r?r:null==a?void 0:null===(t=a.transform)||void 0===t?void 0:t.y);return!!((null==a?void 0:null===(i=a.scale)||void 0===i?void 0:i.x)===1&&(null==a?void 0:null===(n=a.scale)||void 0===n?void 0:n.y)===1)&&!s}get _shouldShowRestore(){let e=this._selection.getSelectedSingleSegment();if(e&&(0,M.U3)(e)){let{matting:t}=e.material;return t.flag}return!1}removeBackground(){let e=this._selection.getSelectedSingleSegment();if(!e||!(0,M.U3)(e))return;let{matting:t}=e.material,{dataSdk:i}=this._mainDraftService;if(null==t?void 0:t.path)return i.api.video.setMatting({segId:e.id,path:t.path});this._mainEditorWidgetService.digitalHumanGenerateManager.generate({segment:e,applyToAll:!1,digitalHumanService:this._digitalHumanService})}restoreBackground(){let e=this._selection.getSelectedSingleSegment();if(e&&(0,M.U3)(e)){var t;let{matting:i}=e.material,{dataSdk:n}=this._mainDraftService;n.api.video.clearMatting({segId:e.id,path:null!==(t=null==i?void 0:i.path)&&void 0!==t?t:""})}}constructor(e,t,i,n,a,d,c,u,h){super(),this._selection=t,this._addSegmentManager=i,this._uploadManager=n,this._mainEditorWidgetService=a,this._mainDraftService=d,this._containerService=c,this._digitalHumanService=u,this._videoConfigurationService=h,this._addOverlay=async e=>{var t;let i=Array.from(null!==(t=e.target.files)&&void 0!==t?t:[]),n=this._selection.getSelectedSingleSegment(),{dataSdk:r}=this._mainDraftService,a=r.draftView.getAllTracks(),s=n?n.trackRenderIndex:a.findLastIndex(e=>e.type===f.pNd.TrackTypeVideo);if(0===(0,l.f)(i).length)return;let o=s+1,d=this._mainEditorWidgetService.timelineManager.tracksManager.addVideoPlaceholderTrackWithIndex(o);this._mainEditorWidgetService.timelineManager.timelineInteract.setEnableTimelineRefresh(!1);let c=await this._uploadManager.localFilesUpload(i,{uploadReportParams:{action_type:p.jm.CLICK_ADD,material_source:p.O9.LOCAL,position:p.cg.ADD_OVERLAY}});try{let e=await c[0];if(this._mainEditorWidgetService.timelineManager.tracksManager.removePlaceholderTrack(d),e.success){let{model:t}=e;await (0,x.vB)(this._addSegmentManager,this._mainEditorWidgetService.renderManager,e.resourceType,t,o,()=>{let e=r.draftView.getTrackByIndex(o);(null==e?void 0:e.segments[0])&&r.api.segment.scale([{segmentId:e.segments[0].id,x:.5,y:.5}])})}}catch(e){this._mainEditorWidgetService.timelineManager.tracksManager.removePlaceholderTrack(d),console.error("upload fail")}finally{this._mainEditorWidgetService.timelineManager.timelineInteract.setEnableTimelineRefresh(!0,!0)}},this._setFit=()=>{let e=this._selection.getSelectedSingleSegment();if(!e)return;let{dataSdk:t}=this._mainDraftService,i=t.api.batch.batchStart();t.api.segment.scale([{segmentId:e.id,x:1,y:1}]),t.api.segment.rotate([{segmentId:e.id,rotation:0}]),t.api.segment.translate([{segmentId:e.id,x:0,y:0}]),t.api.batch.batchEnd(i)},this._setFill=()=>{var e,t;let i=this._selection.getSelectedSingleSegment();if(!i||!(0,f.hey)(i))return;let{dataSdk:n}=this._mainDraftService,r=i.id,a=null===(e=i.material)||void 0===e?void 0:e.width,s=null===(t=i.material)||void 0===t?void 0:t.height,{width:o,height:l}=this._mainDraftService.dataSdk.draftView.getCanvasConfig(),d=a/s,c=o/l,u=1;u=d>c?o/a:l/s;let h=a*u,g=s*u,m=1;m=d>c?l/g:o/h;let p=n.api.batch.batchStart();n.api.segment.translate([{segmentId:r,x:0,y:0}]),n.api.segment.scale([{segmentId:r,x:m,y:m,isKeyframe:!0}]),n.api.batch.batchEnd(p)},this._getWidgetMenuConfig=()=>{let e=this._selection.getSelectedSingleSegment();if(!(e&&(0,f.hey)(e))||(0,f.duj)(e)||this._selection.isInSubDraftContext())return null;let t=(0,o.u)(this._containerService,"toolbar"),i=(0,M.U3)(e),n=(0,f.ot2)(e)&&this._digitalHumanService.isSegmentLoading(e.id),a=[{type:"icon",order:12,icon:(0,r.jsx)(y.thM,{}),tooltip:S.oc.t("web_overlay_button_add",{},"Add overlay"),children:(0,r.jsx)(m.b,{accept:T,onClick:i=>{i.stopPropagation(),t("add_overlay",e);let n=this._mainDraftService.dataSdk.draftView.getAllTracks();(0,b.tY)(n)&&(this._mainEditorWidgetService.timelineManager.timelineUI.toast.normal(S.oc.t("no_web_spce_web_tracks",{},"\u89C6\u9891\u8F68\u9053\u5DF2\u6EE1\uFF0C\u65E0\u6CD5\u6DFB\u52A0\u5230\u76EE\u6807\u4F4D\u7F6E")),i.preventDefault())},onChange:async e=>{await this._addOverlay(e),e.target.value=""},multiple:!1})},{type:"icon",order:12,icon:this._shouldShowFill?(0,r.jsx)(y.xOY,{}):(0,r.jsx)(y.rcY,{}),tooltip:this._shouldShowFill?S.oc.t("web_overlay_button_fill",{},"Fill"):S.oc.t("web_overlay_hover_text_fit_screen",{},"Fit screen"),onClick:()=>{this._shouldShowFill?(t("fill_to_canvas",e),this._setFill()):(t("fit_to_canvas",e),this._setFit())}},{type:"dropdown",order:10,icon:(0,r.jsx)(y.TBO,{}),tooltip:S.oc.t("web_overlay_text_switch",{},"Overlay"),items:[{icon:(0,r.jsx)(y.TBO,{}),tooltip:S.oc.t("web_overlay_hover_text_bottom_right",{},"Bottom right"),onClick:()=>{t("bottom_right",e),this._setAsOverlay("bottomRight")}},{icon:(0,r.jsx)(y.R5i,{}),tooltip:S.oc.t("web_overlay_hover_text_bottom_left",{},"Bottom left"),onClick:()=>{t("bottom_left",e),this._setAsOverlay("bottomLeft")}},{icon:(0,r.jsx)(y.tYz,{}),tooltip:S.oc.t("web_overlay_hover_text_top_left",{},"Top left"),onClick:()=>{t("top_left",e),this._setAsOverlay("topLeft")}},{icon:(0,r.jsx)(y.K2B,{}),tooltip:S.oc.t("web_overlay_hover_text_top_right",{},"Top right"),onClick:()=>{t("top_right",e),this._setAsOverlay("topRight")}}],isShowArrow:!0,needDivider:!0}],s=this._videoConfigurationService.getAppConfigurationValue("toolbar.digitalHuman.enableMatting");return i&&s&&a.unshift({type:"icon",order:12,icon:this._shouldShowRestore?(0,r.jsx)(y.XUJ,{}):(0,r.jsx)(y.pqr,{}),disabled:n,tooltip:n?"":this._shouldShowRestore?S.oc.t("remove_bg_restore_hovertext",{},"Restore background"):S.oc.t("remove_bg_toggle_name",{},"Remove background"),onClick:()=>{this._shouldShowRestore?(t("restore_background",e),this.restoreBackground()):(t("remove_background",e),this.removeBackground())}}),{items:a}},this._getContextMenuConfig=e=>{let t=(0,o.u)(this._containerService,null!=e?e:"material");return[{order:7,type:"subMenu",icon:y.TBO,shouldShow:s.NY,title:S.oc.t("web_overlay_text_switch",{},"Overlay"),subMenuItems:[{type:"menu",icon:y.TBO,shouldShow:s.NY,title:S.oc.t("web_overlay_hover_text_bottom_right",{},"Bottom right"),onClick:()=>{t("bottom_right",this._selection.getSelectedSingleSegment()),this._setAsOverlay("bottomRight")}},{type:"menu",icon:y.R5i,shouldShow:s.NY,title:S.oc.t("web_overlay_hover_text_bottom_left",{},"Bottom left"),onClick:()=>{t("bottom_left",this._selection.getSelectedSingleSegment()),this._setAsOverlay("bottomLeft")}},{type:"menu",icon:y.tYz,shouldShow:s.NY,title:S.oc.t("web_overlay_hover_text_top_left",{},"Top left"),onClick:()=>{t("top_left",this._selection.getSelectedSingleSegment()),this._setAsOverlay("topLeft")}},{type:"menu",icon:y.K2B,shouldShow:s.NY,title:S.oc.t("web_overlay_hover_text_top_right",{},"Top right"),onClick:()=>{t("top_right",this._selection.getSelectedSingleSegment()),this._setAsOverlay("topRight")}}]},{order:8,type:"menu",icon:y.thM,shouldShow:e=>(0,s.NY)(e)||(0,s.pO)(e),title:S.oc.t("web_overlay_button_add",{},"Add overlay"),onClick:e=>{let i=this._selection.getSelectedSingleSegment();i?t("add_overlay",i):t("add_overlay",void 0,"canvas");let n=this._mainDraftService.dataSdk.draftView.getAllTracks();(0,b.tY)(n)&&(this._mainEditorWidgetService.timelineManager.timelineUI.toast.normal(S.oc.t("no_web_spce_web_tracks",{},"\u89C6\u9891\u8F68\u9053\u5DF2\u6EE1\uFF0C\u65E0\u6CD5\u6DFB\u52A0\u5230\u76EE\u6807\u4F4D\u7F6E")),e.preventDefault())},isFileUploader:!0,onFileChange:this._addOverlay}]},e.registerContribution({id:"canvas-overlay",getWidgetMenuConfig:this._getWidgetMenuConfig,getContextMenuConfig:this._getContextMenuConfig})}}I=(0,n.gn)([(0,n.fM)(4,d.a),(0,n.fM)(5,c.n),(0,n.fM)(6,_.t),(0,n.fM)(7,u.BA),(0,n.fM)(8,h.J),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",["undefined"==typeof ICanvasManager?Object:ICanvasManager,"undefined"==typeof ISelection?Object:ISelection,void 0===a.O?Object:a.O,"undefined"==typeof IEditorWidgetFileUploadManager?Object:IEditorWidgetFileUploadManager,void 0===d.a?Object:d.a,void 0===c.n?Object:c.n,void 0===_.t?Object:_.t,void 0===u.BA?Object:u.BA,void 0===h.J?Object:h.J])],I)},708354:function(e,t,i){i.d(t,{j:function(){return a}});var n=i(218571),r=i(95565);function a(e){let{editorUtil:t,enabled:i,rect:a,getWrapSize:s,resizeScale:o}=e,l=(0,n.useContext)(r.e),[d,c]=(0,n.useState)({}),[u,h]=(0,n.useState)({}),g=(0,n.useRef)(a);g.current=a;let m=(0,n.useCallback)((e,t)=>{let i=s();if(!i)return{left:`${e}%`,top:`${t}%`};let n=g.current,r=(n.width*e/100+n.x)*o,a=(n.height*t/100+n.y)*o,l=Math.max(r,0),d=Math.max(a,0);return{left:`${Math.min(l,i.width)}px`,top:`${Math.min(d,i.height)}px`}},[s,o]),f=(0,n.useCallback)(async()=>{if(!i)return;let e=await t.textGetCursorRect(),n=(e.x+1)*50,r=Math.max((e.y+1)*50,0),a=Math.min(100*e.w,100),s=Math.min(100*e.h,100);c({left:`${n}%`,bottom:`${r}%`,width:`${a}%`,height:`${s}%`}),h(m(n,100-r))},[i,t,m,c,h]);return(0,n.useEffect)(()=>{let e=l.onDidChangePageFrame(f);return()=>{e.dispose()}},[t,l,f]),{cursorStyle:d,inputStyle:u}}},183765:function(e,t,i){i.d(t,{f:function(){return n}});let n=(0,i(218571).createContext)(void 0)},917350:function(e,t,i){i.d(t,{B:function(){return s}});var n=i(591010),r=i(587892),a=i(402655);class s extends a.JT{getSelectedSegmentsIds(){return this._selection.getSelectedSegmentsIds()}getPrevSelectedSingleSegmentId(){return this._prevSelectedSingleSegmentId}getSelectedSegmentChildIndex(){return this._selection.getSelectedSegmentChildIndex()}get mutableVideos(){return this._segmentSelection.observeData.mutableVideos}get segmentId(){return this._segmentSelection.observeData.segmentId}get segment(){return this._segmentSelection.observeData.segment}get segmentMutable(){return this._segmentSelection.observeData.segmentMutable}get nestedSelectedSegmentIds(){return this._segmentSelection.observeData.nestedSelectedSegmentIds}get previewSelectedSegmentIds(){return this._segmentSelection.observeData.previewSelectedSegmentIds}get expandedSegmentId(){return this._segmentSelection.observeData.expandedSegmentId}get subDraftSegmentId(){return this._segmentSelection.observeData.subDraftSegmentId}get draftId(){return this._segmentSelection.observeData.draftId}get subDraftId(){return this._segmentSelection.observeData.subDraftId}get topLevelSelectedSegmentIds(){return this._segmentSelection.observeData.topLevelSelectedSegmentIds}get batchReplacingSegmentId(){return this._segmentSelection.observeData.batchReplacingSegmentId}get subDraftSegments(){return this._segmentSelection.observeData.subDraftSegments}get didSelected(){return this._didSelected}_handleSetSegmentsCommonLogic(e){this._didSelected=!0,this._onChangeDidSelected.fire(this._didSelected),this._onChangeDidSelected.dispose();let t=e.getSelectedSegmentsIds();1===t.length?this._prevSelectedSingleSegmentId=t[0]:this._prevSelectedSingleSegmentId=null}selectSegments(e,t,i){let r=e.filter(e=>this._dataSdk.draftView.getSegmentById(e));if(0===e.length||0!==r.length)return this._handleSetSegmentsCommonLogic(this._selection),this._segmentSelection.setSelectedData({segmentIds:e,selectedSegmentChildIndex:t},n.k.Canvas,i)}selectPrepareSegments(e,t){return this._handleSetSegmentsCommonLogic(this._prepareSelection),this._segmentSelection.setPrepareSelectedData({segmentIds:e,selectedSegmentChildIndex:t},n.k.Canvas)}selectChildByIndex(e){return this._selection.setSelectedSegmentChildIndex(e)}selectFaceId(e){this._selection.setSelectedFaceId(e)}reset(){(this._selection.getSelectedSegmentsIds().length>0||this._selection.getSelectedTransitionIds().length>0)&&this._segmentSelection.setSelectedData({},n.k.Canvas)}constructor(e,t,i,n,a){super(),this._selection=e,this._prepareSelection=t,this._segmentSelection=i,this._dataSdk=n,this._prevSelectedSingleSegmentId=null,this._didSelected=!1,this._onChangeDidSelected=this._register(new r.Q),this.onChangeDidSelected=this._onChangeDidSelected.event,a.actionSelectedSegmentIdsSet(e.getSelectedSegmentsIds()),a.actionSelectedSegmentChildIndexSet(e.getSelectedSegmentChildIndex()),a.actionCurrentFaceIdSet(e.getSelectedFaceId()),this._register(e.onSelectedSegmentChildIndexChange(e=>{a.actionSelectedSegmentChildIndexSet(e)})),this._register(e.onChange(e=>{let{selectedData:t}=e;this._didSelected=!0,this._onChangeDidSelected.fire(this._didSelected),this._onChangeDidSelected.dispose();let{segmentIds:i,selectedSegmentChildIndex:n}=t;a.actionSelectedSegmentIdsSet(i),a.actionSelectedSegmentChildIndexSet(n)})),this._register(t.onChange(e=>{let{selectedData:t}=e,{segmentIds:i,selectedSegmentChildIndex:n}=t;a.actionSelectedSegmentIdsSet(i),a.actionSelectedSegmentChildIndexSet(n)})),this._register(e.onSelectedFaceIdChange(e=>{a.actionCurrentFaceIdSet(null!=e?e:null)}))}}},498638:function(e,t,i){i.d(t,{j:function(){return a}});var n=i(504826),r=i(260963);class a{actionTemplateIdSet(e){this.templateId=e}actionTemplateTypeSet(e){this.templateType=e}actionTemplateInfoSet(e,t){this.infos[e]=t}actionMutableVideosMapSet(e){this.mutableVideosMap=e}actionMutableTextsMapSet(e){this.mutableTextsMap=e}actionMutableAudiosMapSet(e){this.mutableAudiosMap=e}actionDisableInteractAddSegmentSet(e){this.disableInteractAddSegment=e}actionDisableInteractForPublishTemplateSet(e){this.disableInteractForPublishTemplate=e}actionDisableInteractForMutableSegmentSet(e){this.disableInteractForMutableSegment=e}get disableInteractFromTemplate(){return this.disableInteractAddSegment||this.disableInteractForPublishTemplate||this.disableInteractForMutableSegment}get selectedSingleSegmentId(){return 1===this.selectedSegmentIds.length?this.selectedSegmentIds[0]:null}get segmentMutable(){let e=this.selectedSingleSegmentId;if(e){if(this.mutableVideosMap[e])return{type:"video",mutable:this.mutableVideosMap[e]};if(this.mutableTextsMap[e])return{type:"text",mutable:this.mutableTextsMap[e]};if(this.mutableAudiosMap[e])return{type:"audio",mutable:this.mutableAudiosMap[e]}}return null}get templateInfo(){return this.infos[this.templateId]}actionSelectedSegmentIdsSet(e){this.selectedSegmentIds=e}actionIsAnyWidgetClicked(){this.isAnyWidgetClicked=!0}constructor(){this.templateId="",this.templateType=n.WY.NORMAL,this.infos={},this.mutableVideosMap={},this.mutableTextsMap={},this.mutableAudiosMap={},this.selectedSegmentIds=[],this.isAnyWidgetClicked=!1,this.disableInteractAddSegment=!1,this.disableInteractForPublishTemplate=!1,this.disableInteractForMutableSegment=!1,(0,r.ky)(this,{},{autoBind:!0})}}},588336:function(e,t,i){i.d(t,{Q:function(){return n}});function n(e,t){let i=e.sort((e,t)=>{var i,n;return(null!==(i=e.order)&&void 0!==i?i:0)-(null!==(n=t.order)&&void 0!==n?n:0)}).slice();for(let e of i)e.isShow=e.shouldShow(t),e.isShow&&e.subMenuItems&&e.subMenuItems.forEach(e=>{e.isShow=e.shouldShow(t)});return i}},284749:function(e,t,i){i.d(t,{V:function(){return r}});var n=i(218571);function r(e){let[t,i]=(0,n.useState)(!1);return(0,n.useMemo)(()=>{let{uploadManager:n}=e.modules;return{isUploading:t,uploadFromLocal:async(e,t)=>{i(!0);try{let r=await n.localFilesUpload(e,t);return Promise.all(r.map(e=>e.catch(()=>null))).then(()=>{i(!1)}),r}catch(e){return i(!1),[]}},uploadFromThirdParty:n.thirdpartyFileUpload.bind(n),thirdpartyUploadSuccessEvent:n.thirdpartyUploadSuccessEvent}},[e.modules.uploadManager,t])}},447938:function(e,t,i){i.d(t,{Z:function(){return _}});var n=i(772322);i(17435);var r=i(629913),a=i(783122),s=i(230689),o=i(801497),l=i(568998),d=i(105789),c=i.n(d),u=i(670933),h=i(218571),g=i(734328),m=i(890392),f=i(937802),p=i(695324),v=i(797913);let _=(0,u.Pi)(e=>{let{disabled:t,hasLogin:i,onImportThirdFile:d,thirdpartyLogin:u}=e,_=(0,f.G)(s.t),S=(0,f.G)(v.J),y=S.getAppConfigurationValue("upload.fromGoogleDrive.disable"),x=S.getAppConfigurationValue("upload.fromDropbox.disable"),b=(0,h.useCallback)((e,t)=>{if(e.stopPropagation(),!i){u(t);return}(0,p.b)(_,{relatedEvent:p.Z.ClickImport}),d(t)},[i,u,d]),M=(0,h.useMemo)(()=>i?o.oc.t("db_web",{},"Dropbox"):o.oc.t("available_after_login",{},"\u767B\u5F55\u540E\u5373\u53EF\u4F7F\u7528"),[i]),T=(0,h.useMemo)(()=>i?o.oc.t("gd_web",{},"Google Drive"):o.oc.t("available_after_login",{},"\u767B\u5F55\u540E\u5373\u53EF\u4F7F\u7528"),[i]);return(0,n.jsx)("div",{className:g.Z.placeholderThirdFileFooter,children:(0,n.jsxs)("div",{className:g.Z.thirdSiteContainer,"data-ssr-i18n-key":"upload_via","data-ssr-i18n-value":o.oc.t("upload_via"),children:[!y&&(0,n.jsx)(r.Z,{position:"top",content:T,disabled:t,children:(0,n.jsx)("span",{className:c()(g.Z.thirdSiteIcon,{[g.Z.disabled]:t}),onClick:e=>{if(!t)(0,p.b)(_,{relatedEvent:p.Z.ClickImport}),(0,m.rf)(_,{click_type:m.ps.GOOGLE_DRIVE,position:m.Af.BOTTOM}),b(e,a.b.GOOGLE_DRIVE)},children:(0,n.jsx)(l.YTE,{})})}),!x&&(0,n.jsx)(r.Z,{position:"top",content:M,disabled:t,children:(0,n.jsx)("span",{className:c()(g.Z.thirdSiteIcon,{[g.Z.disabled]:t}),onClick:e=>{if(!t)(0,p.b)(_,{relatedEvent:p.Z.ClickImport}),(0,m.rf)(_,{click_type:m.ps.DROPBOX,position:m.Af.BOTTOM}),b(e,a.b.DROPBOX)},children:(0,n.jsx)(l.v__,{})})})]})})})},629243:function(e,t,i){i.d(t,{Z:function(){return g}});var n=i(772322),r=i(584341),a=i(446352),s=i(729596),o=i(105789),l=i.n(o),d=i(670933),c=i(218571),u=i(893958);let h="?mm:ss:ff",g=(0,d.f3)("store","canvasManager")((0,d.Pi)(e=>{let{store:t,disabled:i}=e,{progress:o,duration:d,firstFrameInfo:g,videoPreviewStatus:m,videoPreviewProgress:f,videoPreviewDuration:p}=t,v=(0,c.useMemo)(()=>{let e;return e=(e=m===a.bC.OnDisplay||m===a.bC.Playing?Math.min(Number(f),Number(p)):s.h.usToMs(o))<0?0:e,(0,r.ci)(e,h,30,!0)},[o,m,f,p]),_=(0,c.useMemo)(()=>{if(m===a.bC.OnDisplay||m===a.bC.Playing)return(0,r.ci)(Number(p),h,30,!0);if(g){var e,t;return(0,r.ci)(null!==(t=null==g?void 0:null===(e=g.draft_info)||void 0===e?void 0:e.duration)&&void 0!==t?t:0,h,30,!0)}return(0,r.ci)(s.h.usToMs(d),h,30,!0)},[d,m,p,g]);return(0,n.jsxs)("div",{className:l()(u.Z.playerTime,{[u.Z.disabled]:i}),children:[(0,n.jsx)("span",{className:u.Z.playerTimeText,children:v}),(0,n.jsx)("span",{className:u.Z.divider}),(0,n.jsx)("span",{className:u.Z.playerTimeText,children:_})]})}))},653525:function(e,t,i){i.d(t,{a:function(){return o}});var n=i(772322),r=i(424369),a=i(218571),s=i(246098);let o=e=>{let[t,i]=(0,a.useState)(!1),o=(0,a.useCallback)(()=>{i(!1)},[i]);(0,a.useEffect)(()=>(document.addEventListener("mousedown",o),()=>{document.removeEventListener("mousedown",o)}),[o]);let l=(0,s.G)(e),d=(0,a.useMemo)(()=>t?(0,n.jsx)(r.x,{config:l}):null,[l,t]);return{isContextMenuVisible:t,contextMenu:d,showContextMenu:()=>{setTimeout(()=>{i(!0)},10)},hideContextMenu:o}}},243201:function(e,t,i){i.d(t,{m:function(){return o}});var n=i(218571),r=i(937802),a=i(896413),s=i(108692);function o(e){let{displaySize:t,widgetRectangle:i,isMultiWidget:o,parentRect:l}=e,d=(0,n.useRef)(null),[c,u]=t,h=(0,r.G)(a.a),g=(0,r.G)(s.n),m=(0,n.useMemo)(()=>{if(!o)return g.dataSdk.draftView.getSegmentByIdRecursive(i.id)},[o,i.id]),f=(0,n.useMemo)(()=>{if(o&&i.subRects.length){let e=[];return i.subRects.forEach(t=>{let i=g.dataSdk.draftView.getSegmentById(t.id);i&&e.push(i)}),e}return[]},[o,i]);return{transformVideoTrackingRect:async(e,t)=>{var i,n,r,a,s,o,g,p,v,_,S,y,x,b;let M=m?m.videoTracking:void 0;if((null==M?void 0:M.enableVideoTracking)&&(null===(i=M.trackers)||void 0===i?void 0:i.length)>0){let i=null!==(p=null==l?void 0:l.x)&&void 0!==p?p:0,f=null!==(v=null==l?void 0:l.y)&&void 0!==v?v:0,x=((t.x-i)*2+t.width)/c-1,b=1-((t.y-f)*2+t.height)/u,M=await (null===(g=h.renderManager.infoSticker)||void 0===g?void 0:g.getTrackingBaseLineTRS(null!==(_=null==m?void 0:m.id)&&void 0!==_?_:"",h.playerManager.status.progress,{positionX:x,positionY:b,scaleX:null!==(S=e.scaleX)&&void 0!==S?S:null==m?void 0:null===(n=m.clip)||void 0===n?void 0:n.scale.x,scaleY:null!==(y=e.scaleY)&&void 0!==y?y:null==m?void 0:null===(r=m.clip)||void 0===r?void 0:r.scale.y,rotation:null==m?void 0:null===(a=m.clip)||void 0===a?void 0:a.rotation,flipX:null==m?void 0:null===(s=m.clip)||void 0===s?void 0:s.flip.horizontal,flipY:null==m?void 0:null===(o=m.clip)||void 0===o?void 0:o.flip.vertical,alpha:1},null==l?void 0:l.id));M&&(e.translateX=M.positionX,e.translateY=M.positionY,d.current=e)}else if(f.length){let i=f.filter(e=>{var t;let{enableVideoTracking:i,trackers:n}=null!==(t=e.videoTracking)&&void 0!==t?t:{};return i&&(null==n?void 0:n.length)}),n=null!==(x=null==l?void 0:l.x)&&void 0!==x?x:0,r=null!==(b=null==l?void 0:l.y)&&void 0!==b?b:0;await Promise.all(i.map(async i=>{var a,s,o,d,g,m,f;let p=t.subRects.find(e=>e.id===i.id),v=((p.x-n)*2+p.width-n)/c-1,_=1-((p.y-r)*2+p.height-r)/u,S=await (null===(m=h.renderManager.infoSticker)||void 0===m?void 0:m.getTrackingBaseLineTRS(null!==(f=i.id)&&void 0!==f?f:"",h.playerManager.status.progress,{positionX:v,positionY:_,scaleX:null==i?void 0:null===(a=i.clip)||void 0===a?void 0:a.scale.x,scaleY:null==i?void 0:null===(s=i.clip)||void 0===s?void 0:s.scale.y,rotation:null==i?void 0:null===(o=i.clip)||void 0===o?void 0:o.rotation,flipX:null==i?void 0:null===(d=i.clip)||void 0===d?void 0:d.flip.horizontal,flipY:null==i?void 0:null===(g=i.clip)||void 0===g?void 0:g.flip.vertical,alpha:1},null==l?void 0:l.id)),y=e.subRects.find(e=>e.id===i.id);return S&&y&&(y.translateX=S.positionX,y.translateY=S.positionY),S})),d.current=e}else d.current=null},lastedApplyRect:d}}},169180:function(e,t,i){i.d(t,{c:function(){return p},u:function(){return S}});var n=i(772322);i(17435),i(931598),i(701840);var r=i(629913),a=i(16464),s=i(794571),o=i(334769),l=i(298991),d=i(150564),c=i(105789),u=i.n(c),h=i(218571),g=i(883700),m=i(675279),f=i(260963);function p(e,t,i,n,r){let a=(0,h.useRef)([]),s=(0,o.F)(t),[l,d]=(0,h.useState)(performance.now());return(0,h.useEffect)(()=>(0,f.EH)(()=>{let{widgetMenuUpdateTrigger:t}=e;t&&r&&d(performance.now())}),[r]),(0,h.useMemo)(()=>{if(0===n.length||!n.includes(i.id)||!s.draftView.getSegmentById(i.id)||!r)return{items:[]};a.current.length=0;let e=t.getWidgetMenuConfig(i.id),o=null,l=!1,d=[];for(let t of e){if(t.isConicLoading&&(l=!0),t.customMenu){o=t.customMenu,t.deps?a.current=t.deps:a.current.length=0;break}d.push(...t.items);t.deps&&a.current.push(...t.deps)}return{customMenu:o,items:d,isConicLoading:l}},[i.id,n,a.current,r,l])}function v(){return(0,n.jsx)(s.Z,{type:"vertical",className:g.Z.divider})}function _(e){e.stopPropagation()}function S(e){let{canvasStore:t,active:i,customMenu:s,deps:o=[],items:c,playerRef:f,canvasCoverRef:p,widgetRef:S,widgetMenuContainerRef:y,isConicLoading:x}=e,b=e.items.reduce((e,t)=>("icon"===t.type?(e.menuItemCount++,e.totalCount++):"dropdown"===t.type&&(e.dropdownCount++,e.totalCount++),e),{menuItemCount:0,dropdownCount:0,totalCount:0});(0,h.useEffect)(()=>(y.current&&y.current.addEventListener("mousedown",_),()=>{var e;null===(e=y.current)||void 0===e||e.removeEventListener("mousedown",_)}),[y.current]);let{position:M,forceUpdateOffset:T}=(0,m.$)({canvasStore:t,playerRef:f,canvasCoverRef:p,widgetRef:S,widgetMenuContainerRef:y,deps:o,active:i});return(0,h.useLayoutEffect)(()=>{T()},[i,b.totalCount]),{menu:i&&(b.totalCount>0||s)&&(0,n.jsxs)("div",{className:u()(g.Z.segmentWidgetMenu,{[g.Z.segmentWidgetMenuLoading]:x}),style:{...M},onClick:e=>{e.stopPropagation(),(0,l.HM)()},onMouseDown:e=>{e.stopPropagation(),(0,l.HM)()},ref:y,onContextMenu:e=>{e.stopPropagation(),e.preventDefault()},children:[x&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:g.Z.conic}),(0,n.jsx)("div",{className:g.Z.conicMask})]}),null!=s?s:c.sort((e,t)=>{var i,n;return(null!==(i=t.order)&&void 0!==i?i:0)-(null!==(n=e.order)&&void 0!==n?n:0)}).map((e,t,i)=>{switch(e.type){case"icon":return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.Z,{disabled:!e.tooltip,content:e.tooltip,position:"bottom",children:(0,n.jsxs)("div",{className:u()(g.Z.segmentWidgetToolbarButton,e.className,{[g.Z.disabled]:e.disabled}),onClick:t=>{var i;if(e.disabled){t.stopPropagation();return}null===(i=e.onClick)||void 0===i||i.call(e,t)},children:[e.icon,e.children]},t)}),e.needDivider&&t!==i.length-1?v():null]});case"dropdown":var s,o;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.Z,{disabled:!e.tooltip,content:e.tooltip,position:"bottom",children:(0,n.jsx)(a.Z,{trigger:"click",droplist:null!==(o=e.customDropList)&&void 0!==o?o:(0,n.jsx)("div",{className:g.Z.iconDroplistWrapper,children:null===(s=e.items)||void 0===s?void 0:s.map(e=>(0,n.jsx)(r.Z,{disabled:!e.tooltip,content:e.tooltip,position:"bottom",children:(0,n.jsx)("div",{className:g.Z.segmentWidgetToolbarButton,onClick:e.onClick,children:e.icon})},`dropdown-${t}`))}),triggerProps:{popupAlign:{bottom:12}},children:(0,n.jsxs)("div",{className:u()(g.Z.iconDropdownButtonWrapper,{[g.Z.withArrow]:e.isShowArrow}),children:[(0,n.jsx)("div",{className:g.Z.segmentWidgetToolbarButton,children:e.icon},t),e.isShowArrow&&(0,n.jsx)("div",{className:g.Z.iconDropdownButtonArrow,children:(0,n.jsx)(d.MJ0,{})})]})})}),e.needDivider&&t!==i.length-1?v():null]});default:return null}})]}),menuPosition:M}}},472602:function(e,t,i){i.d(t,{P:function(){return r}});var n=i(632555);function r(e){return(0,n.vX)(e.centerX,[-1,1])&&(0,n.vX)(e.centerY,[-1,1])&&e.width>0&&e.height>0}},772664:function(e,t,i){i.d(t,{Z:()=>Q});var n=i("772322"),r=i("544633"),a=i("514536"),s=i("465482"),o=i("800793"),l=i("697667"),d=i("563431"),c=i("591010"),u=i("154711"),h=i("157604"),g=i("710763"),m=i("177975"),f=i("695324"),p=i("937802"),v=i("426336"),_=i("230689"),S=i("374704"),y=i("159726"),x=i("522600"),b=i("983418"),M=i("218571"),T=i("670933"),I=i("105789"),k=i.n(I),D=i("654033"),C=i("334769"),w=i("949222");let E={widgetMulti:"widget-multi-atCHO6",active:"active-OZZHv1",isBoxSelecting:"is-box-selecting-o49Lcr"};var A=i("54949"),R=i("108692"),P=i("860660");let L=(0,T.f3)("store","canvasManager")((0,T.Pi)(e=>{let t=(0,p.G)(_.t),i=(0,p.G)(R.n),{store:r,canvasManager:a,rectangles:s,displaySize:l,resizeScale:d,isMultiSelection:c,isScaling:u,isTranslating:g,isRotating:m,onRotateHoverChange:f,isBoxSelecting:v,onIsScalingChange:x,onIsRotatingChange:b,onIsTranslatingChange:T,onRectChange:I,disableInteract:L}=e,{isPlaying:N,progress:B,selectedSegmentIds:O}=r,j=(0,C.F)(a),[U,V]=(0,M.useState)(0),[F,z]=(0,M.useState)(""),W=(0,M.useRef)(!1),Y=(0,M.useRef)(!1),K=(0,M.useRef)(!1),Z=(0,M.useRef)(s),G=(0,M.useRef)(O);Z.current=s,G.current=O;let H=(0,o.SK)(),X=(0,M.useRef)(""),Q=(0,M.useRef)(""),q=(0,M.useRef)(1),J=(0,M.useRef)(new Map),$=(0,w.O)(j),ee=(0,M.useCallback)(e=>{z(e.target.id),x(!0),W.current=!0},[]),{run:et,cancel:ei}=(0,S.j)((e,t,i)=>{N&&a.modules.playerController.pause(),null==i||i(),I(t),!X.current&&(X.current=j.api.batch.batchStart(!0)),$.onDragPoint(e),Y.current=!0},16),en=(0,M.useCallback)((e,n)=>{if(ei(),W.current=!1,n.timestamp=Date.now(),x(!1),I(void 0),Y.current){var a,s;let n=(null!==(a=e.scaleX)&&void 0!==a?a:1)<q.current;q.current=null!==(s=e.scaleX)&&void 0!==s?s:1,$.onDragPoint(e),r.actionPlayerWidgetUpdateTriggerSet(),(0,A.a)(t,{action:n?A.N.ZOOM_IN:A.N.ZOOM_OUT,batch_cnt:O.length,...(0,P.KG)(O.map(e=>i.dataSdk.draftView.getSegmentById(e)))}),(0,h.LB)(t,{action:h.x3.Scale,segmentIds:O,actionType:h.D1.Canvas})}X.current&&(j.api.batch.batchEnd(X.current),X.current=""),Y.current=!1;let o=j.api.undoRedo.getTopItemId();J.current.set(o,n)},[O]),{run:er,cancel:ea}=(0,S.j)((e,t,i,n)=>{W.current=!0,T(!0,n),N&&a.modules.playerController.pause(),null==i||i(),I(t),!X.current&&(X.current=j.api.batch.batchStart(!0)),$.onTranslate(e),Y.current=!0},16),es=(0,M.useCallback)((e,n,a,s)=>{ea(),W.current=!1,n.timestamp=Date.now(),T(!1,!0),T(!1,!1),I(void 0),Y.current&&($.onTranslate(e),r.actionPlayerWidgetUpdateTriggerSet(),(0,A.a)(t,{action:A.N.MOVE,batch_cnt:O.length,...(0,P.KG)(O.map(e=>i.dataSdk.draftView.getSegmentById(e)))}),(0,h.LB)(t,{action:h.x3.Position,segmentIds:O,actionType:a?h.D1.Canvas:h.D1.Shortcut,...null!=s?s:{}})),X.current&&(j.api.batch.batchEnd(X.current),X.current=""),Y.current=!1;let o=j.api.undoRedo.getTopItemId();J.current.set(o,n)},[T,Y,$.onTranslate,O]),eo=(0,M.useCallback)(()=>{b(!0),W.current=!0},[]),{run:el,cancel:ed}=(0,S.j)((e,t,i)=>{N&&a.modules.playerController.pause(),null==i||i(),I(t),K.current=!0,!Q.current&&(Q.current=j.api.batch.batchStart(!0)),$.onRotate(e),Y.current=!0},16),ec=(0,M.useCallback)((e,n)=>{ed(),W.current=!1,n.timestamp=Date.now(),b(!1),I(void 0),Y.current&&($.onRotate(e),r.actionPlayerWidgetUpdateTriggerSet(),(0,A.a)(t,{action:A.N.ROTATE,batch_cnt:O.length,...(0,P.KG)(O.map(e=>i.dataSdk.draftView.getSegmentById(e)))}),(0,h.LB)(t,{action:h.x3.Rotate,segmentIds:O,actionType:h.D1.Canvas})),Q.current&&(j.api.batch.batchEnd(Q.current),Q.current=""),Y.current=!1;let a=j.api.undoRedo.getTopItemId();J.current.set(a,n)},[b,Y,$.onRotate,O]),eu=(0,M.useCallback)(e=>{!H&&a.modules.selectionManager.selectSegments([e])},[H]),eh=(0,M.useMemo)(()=>{if(!c)return null;let e=j.api.undoRedo.getTopItemId();if(J.current.has(e)){let t=J.current.get(e);return t.timestamp=Date.now(),{...t}}let t=Z.current.filter(e=>G.current.includes(e.id));if(!t.length)return null;let i=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER,s=0;t.forEach(e=>{let t=[e.x+e.width/2,e.y+e.height/2],o=(0,D.a)([e.x,e.y],-e.rotate,t),l=(0,D.a)([e.x+e.width,e.y],-e.rotate,t),d=(0,D.a)([e.x,e.y+e.height],-e.rotate,t),c=(0,D.a)([e.x+e.width,e.y+e.height],-e.rotate,t);i=Math.min(i,o[0],l[0],d[0],c[0]),n=Math.min(n,o[1],l[1],d[1],c[1]),r=Math.max(r,o[0],l[0],d[0],c[0]),a=Math.max(a,o[1],l[1],d[1],c[1]),s=Math.max(s,e.originalWidth)});let o=r-i,d=a-n,[u,h]=l,g={id:"multi-select",type:"Container",x:i,y:n,width:o,height:d,originalX:(u-o)/2,originalY:(h-d)/2,originalHeight:d/o*s,originalWidth:s,rotate:0,timestamp:U,scale:{},transform:{},subRects:t.map(e=>({id:e.id,type:e.type,x:e.x,y:e.y,width:e.width,height:e.height,rotate:e.rotate,originalWidth:e.width,originalHeight:e.height,initialWidth:e.originalWidth,initialHeight:e.originalHeight,originalX:e.originalX,originalY:e.originalY}))};return J.current.set(e,g),g},[U,l,c]);return(0,M.useEffect)(()=>{!W.current&&(J.current.clear(),V(Date.now()))},[O]),(0,M.useEffect)(()=>{K.current=!1},[B,O]),(0,M.useEffect)(()=>{V(Date.now())},[s]),(0,n.jsx)(n.Fragment,{children:eh&&(0,n.jsx)(y.Z,{className:k()(E.widgetMulti,{[E.active]:c,[E.isBoxSelecting]:v}),style:{zIndex:H?0:1},store:r,canvasManager:a,rectangle:eh,onRotateHoverChange:f,isMultiWidget:!0,displaySize:l,disableInteract:L,scale:d,widgetActive:c,isScaling:u,isTranslating:g,isRotating:m,isBoxSelecting:v,pointActiveId:F,onSetPointActiveId:z,onDragPointStart:ee,onDragPoint:et,onDragPointEnd:en,onDrag:er,onDragEnd:es,onRotateStart:eo,onRotate:el,onRotateEnd:ec,onSubRectClick:eu},"multi-select")})}));var N=i("97181"),B=i("953032"),O=i("593946"),j=i("99195"),U=i("211901"),V=i("446352"),F=i("896413"),z=i("260963"),W=i("779944"),Y=i("663811"),K=i("334825"),Z=i("997151"),G=i("821004"),H=i("315529"),X=i("722169");let Q=(0,T.f3)("store","canvasManager")((0,T.Pi)(e=>{var t;let{store:i,canvasManager:T,playerRef:I,canvasCoverRef:k,disabled:D,displaySize:w,resizeScale:E,getWrapperSize:A,isBoxSelecting:R=!1,isTemplate:P=!1}=e,Q=(0,C.F)(T),q=(0,N.H)(T),J=(0,p.G)(_.t),$=(0,p.G)(H.J),{canvasResizing:ee,canvasRectangles:et,disabledRectangleIdsSet:ei,disableInteract:en,isDraggingMaterial:er,isMultiSelection:ea,isPlaying:es,selectedSegmentIds:eo,selectedSingleSegmentId:el,selectedSegmentChildIndex:ed,widgetInteractivityStatus:ec,atomicDisableInteractivity:eu,isDisabledSelectWidget:eh}=i,{expandedSegmentId:eg,batchReplacingSegmentId:em,nestedSelectedSegmentIds:ef,previewSelectedSegmentIds:ep,topLevelSelectedSegmentIds:ev,subDraftSegmentId:e_}=T.modules.selectionManager,eS=(0,s.mU)(),ey=(0,M.useRef)(new Map),ex=(0,M.useCallback)(()=>{es&&T.modules.playerController.pause()},[es]),eb=(0,p.G)(_.t),eM=(0,M.useCallback)(e=>{(0,u.c)(J,{action:e,panel:"player"}),eS&&(0,h.LB)(eb,{action:h.x3.EditText,segmentIds:[eS.id],actionType:h.D1.Canvas})},[J,eS]),{subWidgetStyle:eT}=(0,W.k)(P),[eI,ek]=(0,M.useState)(!1),[eD,eC]=(0,M.useState)(!1),[ew,eE]=(0,M.useState)(!1),[eA,eR]=(0,M.useState)(!1),eP=(0,M.useRef)(!1),eL=(0,M.useRef)(!1),eN=(0,M.useRef)(l.Ow.normal),eB=(0,M.useCallback)(e=>{eN.current=e},[]),eO=(0,M.useRef)(),ej=(0,M.useRef)(),eU=(0,M.useRef)(),eV=eD||ew,{selectedWidgetRectangle:eF,getSegmentRectangles:ez}=function(e,t,i,n){let{failedSegments:r,selectedSingleSegmentId:a}=e,{rectangles:s,selectedWidgetRectangle:o,getSegmentRectangles:l}=(0,U.K)({store:e,canvasManager:t,enable:n,displaySize:i,segmentId:a,failedSegments:r}),d=(0,O.default)(s);(0,M.useEffect)(()=>{if(!!n&&s!==d)e.actionCanvasRectanglesSet(s)},[n,s]);let c=(0,p.G)(F.a),{run:u}=(0,B.default)(e.actionPlayerWidgetUpdateTriggerSet,50,[]);return(0,M.useEffect)(()=>{let e=c.renderManager.onFrameRender(u);return()=>{null==e||e.dispose()}},[]),(0,M.useEffect)(()=>(0,z.U5)(()=>e.progress,()=>{e.videoPreviewStatus!==V.bC.None&&u()}),[]),(0,j.Q)(()=>{e.actionPlayerWidgetUpdateTriggerSet()}),{selectedWidgetRectangle:o,getSegmentRectangles:l}}(i,T,w,!D&&!eI&&!eV&&!eA),eW=Object.keys(ep).length>0,eY=e_&&eW,eK=null!==(t=null!=em?em:eg)&&void 0!==t?t:eY?e_:void 0,eZ=(0,M.useMemo)(()=>{var e,t;return eK?null!==(t=null===(e=et.find(e=>{let{id:t}=e;return t===eK}))||void 0===e?void 0:e.subRects)&&void 0!==t?t:[]:et},[et,eK]),eG=(0,M.useMemo)(()=>eK?[et.find(e=>{let{id:t}=e;return t===eK})]:[],[et,eK]),eH=(0,o.SK)(),{isTextEditing:eX,editingTextSegmentId:eQ,initialCursorPos:eq,actionSetIsShowAttributeByCanvasClick:eJ,handleWidgetClick:e$}=(0,Y.x)(T),e0=(0,K.y)(Q,T),e1=(0,M.useRef)(!1),e2=(0,r.default)(function(e,t,n){var r,a,s,o,l,u,h,m;let f=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(eh||"path"===e.target.tagName)return;let p=t===el,v=null!==(s=null==n?void 0:null===(r=n.at(-1))||void 0===r?void 0:r.subRects)&&void 0!==s?s:eZ,_=null==A?void 0:A(),S=null!==(o=null==_?void 0:_.left)&&void 0!==o?o:0,y={x:S,y:null!==(l=null==_?void 0:_.top)&&void 0!==l?l:0},{clientX:x,clientY:b}=e,M=v.length,I=t,k=!1,D=null!==(u=null===(a=Q.draftView.getSegmentById(I))||void 0===a?void 0:a.trackRenderIndex)&&void 0!==u?u:0;if(e.target instanceof HTMLElement&&!e.target.dataset.lifting)for(let e=M-1;e>=0;e--){let t=v[e],i=(0,d.jy)(t,y,E,6);if((0,d.fG)(i,{x:x,y:b})){let e=null!==(m=null===(h=Q.draftView.getSegmentById(t.id))||void 0===h?void 0:h.trackRenderIndex)&&void 0!==m?m:0;if(p&&I!==t.id){if(!(e>D))continue;k=!0}if(I=t.id,!p||k)break}}let C=[I];if(!(null==n?void 0:n.length)&&eH){let e="select";C=[...eo,I],eo.includes(I)&&(e="unselect",C=eo.filter(e=>e!==I)),(0,g.r)(eb,(0,g.T)({ids:i.selectedSegmentIds,action:e,draftView:Q.draftView}))}k&&!f?e1.current=!0:(e1.current=!1,q.actionTextEditingExitEdit(),ex(),T.modules.selectionManager.selectSegments(C,p?ed:void 0,c.U.Click))}),e4=(0,M.useCallback)((e,t,i)=>{e2(e,t,i)},[e2]),e3=(0,r.default)((e,t,i)=>{if(eP.current){e1.current=!1;return}if(e1.current)e2(e,t.id,i,!0);else{let i=t.id===T.modules.selectionManager.getPrevSelectedSingleSegmentId();e$({event:e,rect:t,repeat:i,resizeScale:E,isPlaying:es,getWrapperSize:A,reportTextEdit:eM}),(0,m.gM)(J,{optionType:m.P6.Select})}}),e6=(0,r.default)((e,t)=>{T.modules.selectionManager.selectSegments([t],ed,c.U.DoubleClick)}),e9=(0,M.useRef)(""),e5=(0,M.useCallback)(()=>{ex(),ek(!0),eP.current=!1,$.record("scale")},[]),{run:e8,cancel:e7}=(0,S.j)(async(e,t,n)=>{i.actionCurrentWidgetRectangleSet(t),!e9.current&&(e9.current=Q.api.batch.batchStart(!0)),eP.current=!0,(null==t?void 0:t.type)==="SegmentText"&&e.fixedWidth?(null==n||n(),await e0.onWidgetDragSide(e,{shouldRefresh:!1})):(e0.onWidgetDragPoint(e,{shouldRefresh:!1}),null==n||n()),eL.current=!0},16),te=(0,r.default)(async e=>{e7(),ek(!1),(0,m.gM)(J,{optionType:m.P6.Scale}),(0,h.LB)(eb,{action:h.x3.Scale,segmentIds:[e.id],actionType:h.D1.Canvas}),eL.current&&((0,f.b)(J,{relatedEvent:f.Z.ClickNewTextConfirm}),(null==e?void 0:e.type)==="SegmentText"&&e.fixedWidth?(await e0.onWidgetDragSide(e,{shouldRefresh:!0}),eM(l.ZK.Stretch)):(e0.onWidgetDragPoint(e,{shouldRefresh:!0}),(null==e?void 0:e.type)==="SegmentText"&&eM(l.ZK.Scale))),e9.current&&(Q.api.batch.batchEnd(e9.current),e9.current=""),eL.current=!1,$.stop("scale")}),tt=(0,M.useRef)(""),ti=(0,M.useCallback)(()=>{ex(),eP.current=!1,$.record("translate"),e1.current=!1},[]),{run:tn,cancel:tr}=(0,S.j)((e,t,n,r)=>{r?eC(!0):eE(!0),i.actionCurrentWidgetRectangleSet(t),!tt.current&&(tt.current=Q.api.batch.batchStart(!0)),eP.current=eP.current||e.translateX>0||e.translateY>0,e0.onWidgetDrag(e),null==n||n(),eL.current=!0},16),ta=(0,M.useCallback)((e,t,i,n)=>{tr(),(0,f.b)(J,{relatedEvent:f.Z.ClickNewTextConfirm}),(0,h.LB)(eb,{action:h.x3.Position,actionType:i?h.D1.Canvas:h.D1.Shortcut,segmentIds:[e.id],...null!=n?n:{}}),eC(!1),eE(!1),eS&&(0,v.Ftn)(eS)&&eM(l.ZK.Move),(0,m.gM)(J,{optionType:m.P6.Move}),eL.current&&e0.onWidgetDrag(e,{shouldRefresh:!0}),tt.current&&(Q.api.batch.batchEnd(tt.current),tt.current=""),eL.current=!1,i&&$.stop("translate")},[eS]),ts=(0,M.useRef)(""),to=(0,M.useCallback)(()=>{ex(),eR(!0),$.record("rotate")},[]),{run:tl,cancel:td}=(0,S.j)((e,t,n)=>{i.actionCurrentWidgetRectangleSet(t),!ts.current&&(ts.current=Q.api.batch.batchStart(!0)),e0.onWidgetRotate(e),null==n||n(),eL.current=!0},16),tc=(0,M.useCallback)(e=>{td(),(0,f.b)(J,{relatedEvent:f.Z.ClickNewTextConfirm}),(0,h.LB)(eb,{action:h.x3.Rotate,segmentIds:[e.id],actionType:h.D1.Canvas}),eR(!1),eS&&(0,v.Ftn)(eS)&&eM(l.ZK.Rotate),(0,m.gM)(J,{optionType:m.P6.Rotate}),eL.current&&e0.onWidgetRotate(e,{shouldRefresh:!0}),ts.current&&(Q.api.batch.batchEnd(ts.current),ts.current=""),eL.current=!1,$.stop("rotate")},[eS]),tu=(eI||eV)&&!en,th=(0,r.default)(e=>{let{val:t,newRect:n}=e;t?(i.actionIsRotateWidgetHoveredSet(!0),i.actionCurrentWidgetRectangleSet(n)):(i.actionIsRotateWidgetHoveredSet(!1),!eL.current&&i.actionCurrentWidgetRectangleSet())}),tg=(0,r.default)((e,t,i)=>{if(eS&&(0,v.Q2R)(eS)&&eF){if(T.modules.selectionManager.getPrevSelectedSingleSegmentId()!==(null==eS?void 0:eS.id))return;T.modules.selectionManager.selectChildByIndex(t);let e=t===T.modules.selectionManager.getSelectedSegmentChildIndex();i.detail>1?T.modules.workbenchController.openTextBasicPanel():e}}),tm=(0,M.useCallback)(()=>{T.modules.selectionManager.selectChildByIndex(-1)},[T]),tf=(0,M.useCallback)(e=>e?document.querySelector(`[data-widget-id="${e}"]`):null,[]),tp=(0,M.useCallback)(e=>{let t=tf(e);t?(eO.current=t,ej.current=Array.from(t.querySelectorAll(":scope > span"))):(eO.current=void 0,ej.current=void 0)},[tf]),tv=(0,M.useCallback)(e=>{let t=eO.current,i=ej.current;if(t&&(null==i?void 0:i.length)&&(t!==e.target||t.dataset.lifting)){let{clientX:n,clientY:r}=e,a=i.some(e=>(0,d.nS)(e.getBoundingClientRect(),{x:n,y:r}));a&&t!==e.target?(t.style.setProperty("z-index","3"),t.dataset.lifting="true"):!a&&t.dataset.lifting&&(t.style.removeProperty("z-index"),delete t.dataset.lifting);return}let n=(0,d.sc)(k,w,e);if(!n)return;let r=(()=>{if(0===ev.length)return[];if(1===ev.length){var e,t;return null!==(t=null===(e=eZ.find(e=>e.id===ev[0]))||void 0===e?void 0:e.subRects)&&void 0!==t?t:[]}return[]})(),a=1/0,s="";for(let e of r){let t=(0,d.wg)(n,e);t>=-2&&t<=4&&t<a&&(a=t,s=e.id)}if(eU.current!==s){let e=tf(eU.current);if(e&&(e.style.removeProperty("z-index"),delete e.dataset.lifting),s){let e=tf(s);e&&(e.style.setProperty("z-index","3"),e.dataset.lifting="true")}eU.current=s}},[eZ,ev,tf,k,w]);(0,a.default)("mousemove",tv,{target:k.current});let t_=(0,M.useCallback)((0,X.memoize)(e=>t=>{t?ey.current.set(e,t):ey.current.delete(e)}),[ey]),tS=(0,M.useCallback)(e=>{(0,m.R)(eb,e)},[eb]),ty=(0,Z.r)();return(0,n.jsxs)(n.Fragment,{children:[!D&&!ee&&!es&&(0,n.jsx)(L,{isMultiSelection:ea,rectangles:eZ,resizeScale:E,displaySize:w,onRotateHoverChange:e=>{let{val:t,newRect:n}=e;i.actionIsRotateWidgetHoveredSet(t),t?i.actionCurrentWidgetRectangleSet(n):!eL.current&&i.actionCurrentWidgetRectangleSet()},isScaling:eI,isTranslating:eD,isRotating:eA,isBoxSelecting:R,onIsRotatingChange:e=>{eR(e)},onIsScalingChange:e=>{ek(e)},onIsTranslatingChange:(e,t)=>{t?eC(e):eE(e)},onRectChange:e=>{i.actionCurrentWidgetRectangleSet(e)},disableInteract:en}),!D&&eZ.map(e=>{let t=Object.hasOwnProperty.call(ef,e.id),r=Object.hasOwnProperty.call(ep,e.id),a=!ea&&!ee&&(t||r)&&(!es||!!i.fixedRectangle),s=t_(e.id);return(0,n.jsx)(y.Z,{ref:s,store:i,canvasManager:T,rectangle:e,rectangles:eZ,ancestorRects:eG,displaySize:w,scale:E,isBoxSelecting:R,widgetActive:a,isChildSelected:!!e.subRects.find(e=>eo.includes(e.id)),selectedSegmentIds:eo,selectedSubRectIndex:ed,subWidgetStyle:eT,disabled:ei.has(e.id),disableInteract:!ec||!t&&r,atomicDisableInteract:eu,onDidAtomicDisableInteract:tS,shouldScaleAroundCenter:eu.disableDrag,onMouseDown:e4,isDraggingMaterial:er,isTranslating:eD,isRotating:eA,isInMultiWidget:ea&&eo.includes(e.id),onClick:e3,onDoubleClick:e6,isScaling:eI,onDragPointStart:e5,onDragPoint:e8,onDragPointEnd:te,onDragStart:ti,onDrag:tn,onDragEnd:ta,onRotateStart:to,onRotate:tl,onRotateEnd:tc,onRotateHoverChange:th,onSubRectClick:tg,onClickOutsideSubRects:tm,onRotateButtonPositionChange:eB,onActive:tp,onIllegalUpdateParams:ty,playerRef:I,canvasCoverRef:k,getSegmentRectangles:ez},e.id)}),(0,n.jsx)(x.Z,{store:i,enable:tu&&P,displaySize:w,resizeScale:E}),(0,n.jsx)(b.Z,{store:i,enable:tu,rectangles:eZ,displaySize:w,resizeScale:E}),eX&&eS&&eQ===eS.id&&(0,v.Ftn)(eS)&&eF&&!en&&q.renderRichTextEditor({segment:eS,selectedSegmentChildIndex:ed,rect:eF,resizeScale:E,displayCursor:!eA&&!eI,initialCursorPos:eq,isTemplate:P,getWrapSize:A,actionSetIsShowAttributeByCanvasClick:eJ,canvasManager:T}),(0,n.jsx)(G.Z,{isRotating:eA,rotateButtonPositionRef:eN})]})}))},265471:function(e,t,i){i.d(t,{Z:function(){return l}});var n=i(772322);i(225572);var r=i(97257),a=i(537783),s=i(150564);i(855157);var o=i(218571);function l(e){let{xgplayerErrorObj:t}=e,{i18n:i}=(0,a.$)(),l=(0,o.useCallback)(()=>i.t("web_alert_toast_refresh",{},"Something went wrong. Refresh the page and try again."),[!0,t]);return(0,n.jsxs)("div",{className:"xgplayer-error__wrapper",children:[(0,n.jsx)(s.CVx,{className:"xgplayer-error__icon"}),(0,n.jsx)("p",{className:"xgplayer-error__tips",children:l()}),(0,n.jsx)(r.Z,{className:"xgplayer-error__button-refresh",onClick:()=>location.reload(),children:i.t("REFRESH",{},"Refresh")})]})}},110645:function(e,t,i){i.d(t,{Hw:function(){return a},Nb:function(){return l},SR:function(){return r},TZ:function(){return s},gF:function(){return o}});var n=i(382094);let r=1,a={[n.j.Microsecond]:1000000n,[n.j.Millisecond]:1000n,[n.j.Second]:1n},s={[n.j.Microsecond]:1e6,[n.j.Millisecond]:1e3,[n.j.Second]:1},o=3e3;function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.j.Millisecond;return"bigint"==typeof e?e*a[t]:e*s[t]}},436731:function(e,t,i){i.d(t,{h:function(){return s}});var n=i(800788),r=i(722169);function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,i=requestIdleCallback(e,{timeout:t});return{dispose:()=>(0,r.partial)((0,r.once)(cancelIdleCallback),i)}}function s(e){return function(t,i,r){let s=r.value;return(0,n.ZB)(s,`method ${String(i)}: not initialized`),r.value=function(){for(var t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];return a.apply(this,[s.bind(this,...i),null==e?void 0:e.timeout])},r}}},892045:function(e,t,i){i.d(t,{m:function(){return u}});var n=i(789786),r=i(260963),a=i(999268),s=i(402655),o=i(768303),l=i(718494),d=i(979627),c=i(481558);class u extends s.JT{get size(){return this._queue.length}get status(){return this._status}get _shouldLock(){return this._concurrent<=this._current}get _shouldUnlock(){return!this._shouldLock&&this._mutex.isLocked()}get _shouldExecute(){return this.size&&this._status<=o.l.Running}get _shouldSuspend(){return this.status===o.l.Paused}_setStatus(e){(0,r.z)(()=>this._status=e)}async execute(){if(!this._shouldExecute)return console.log(d.U,"[queue] queue destroyed or no task anymore"),this._complete();this._shouldLock&&(console.log(d.U,"[queue] await concurrent lock"),await this._mutex.lock(),console.log(d.U,"[queue] concurrent released")),this._shouldSuspend&&(console.log(d.U,"[queue] await suspend lock"),await this._suspendMutex.lock(),console.log(d.U,"[queue] suspend lock release"));let e=this._queue[0];return e?(this._current++,this._currentTask=e,this._setStatus(o.l.Running),e.run(e.context),console.log(d.U,"[queue] running task"),(0,c.h)(()=>this._status===o.l.Idle,!1)):this._complete()}enqueue(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];this._queue.push(...Array.isArray(e)?e:[e]),Array.isArray(e)?e.forEach(this._register.bind(this)):this._register(e),t&&this._status<o.l.Running&&this.execute()}dequeue(e){if(e.status===l.h.Running)return null;let t=this._queue.indexOf(e);if(t<0)return null;let[i]=this._queue.splice(t,1);return i}pause(){this._status===o.l.Running&&this._setStatus(o.l.Paused)}resume(){this._status===o.l.Paused&&(this._setStatus(o.l.Idle),this._suspendMutex.unLock(),console.log(d.U,"[queue] release suspend lock"))}clear(){this._queue.length=0,this.dispose()}destroy(){this.clear(),this._setStatus(o.l.Destroyed)}deffer(e,t){let i=setTimeout(()=>{this.enqueue(e),clearTimeout(i)},t.timeout)}defferCurrentTask(e){let t=this._queue.shift();t&&(t.dispose(),this.deffer(t,e))}constructor(e){var t;super(),this._status=o.l.Idle,this._queue=[],this._mutex=new a.L,this._suspendMutex=new a.L,this._current=0,this._currentTask=null,this._next=()=>{console.log(d.U,"[queue] trying next task"),this._queue.shift(),this._current--,this.execute(),this._shouldUnlock&&(console.log(d.U,"[queue] concurrent release lock"),this._mutex.unLock())},this._complete=()=>(this._queue.length=0,this._setStatus(o.l.Idle),console.log(d.U,"[queue] completed"),(0,c.h)(()=>this._status===o.l.Idle,!1)),this._concurrent=null!==(t=e.concurrent)&&void 0!==t?t:1,(0,r.rC)(this)}}(0,n.gn)([r.LO],u.prototype,"_status",void 0)},890629:function(e,t,i){i.d(t,{M:function(){return p}});var n=i(426336),r=i(425427),a=i(174130),s=i(481558),o=i(440489),l=i(305707),d=i(431650),c=i(382094),u=i(795375),h=i(979627),g=i(110645),m=i(159277),f=i(608877);class p extends a.g{get cachedMutablePolyInfo(){return!this._cachedMutablePolyInfo.length&&(this._cachedMutablePolyInfo=this._timelineManager.current.segmentManager.getAllMutablePolyInfo()),this._cachedMutablePolyInfo}get cachedMutableVideos(){if(!this._cachedMutableVideos.length){let e=this._dataSdk.draftView.getDraftId();this._cachedMutableVideos=this._dataSdk.cutSame.getMutableVideos(e)}return this._cachedMutableVideos}get cachedMutableTexts(){if(!this._cachedMutableTexts.length){let e=this._dataSdk.draftView.getDraftId();this._cachedMutableTexts=this._dataSdk.cutSame.getMutableTexts(e)}return this._cachedMutableTexts}get _waitRenderManagerReady(){return(0,s.h)(()=>this._renderManager.current)}get _waitTimelineManagerReady(){return(0,s.h)(()=>this._timelineManager.current)}get _isTemplateEditor(){return(0,r.JY)(this._videoEnvironmentService)}async _getOrCreateGeneratorInstance(e){if(!this.shouldUpdateGenerator(e))return this._generators.get(e.resourceKey);this.onSegmentFullUpdate.fire(e.resourceKey);let t=this._dataSdk.draftView.getCanvasConfig(),i=new o.r({timeRange:e.timeRange,singleFrameHeight:t.height,singleFrameWidth:t.width}),n=await this._waitRenderManagerReady,r=new f.O(e,n,i);return this._register(r),this._generators.set(e.resourceKey,r),r}async _reduceChangesToScreenshotUpdates(){await this._waitTimelineManagerReady;let e=this._changes.map(this._transformOperationToMutableSegmentUpdate).map(this._reduceScreenshotUpdates);await Promise.all(e),this._cachedMutablePolyInfo=[],this._cachedMutableVideos=[],this._cachedMutableTexts=[],this._changes.length=0}async _reduceUpdatesToScreenshotTasks(){if(!(0,r.JY)(this._videoEnvironmentService))return{renderMutableList:[]};let e=(await this._waitTimelineManagerReady).segmentManager.getAllMutablePolyInfo();return{renderMutableList:this._dataSdk.cutSame.getMutableVideos().filter(e=>e.filled).filter(t=>!e.some(e=>{var i;return null===(i=e.children)||void 0===i?void 0:i.some(e=>e.id===t.segmentId)})).map(this._formatRenderMutableSegmentParams).filter(Boolean)}}capable(e){var t;return(null===(t=l.gi.from(e))||void 0===t?void 0:t.trigger)===m.a.Mutable}constructor(e,t,i,a,s){super(a,e,s),this._timelineManager=t,this._videoEnvironmentService=i,this._cachedMutablePolyInfo=[],this._cachedMutableVideos=[],this._cachedMutableTexts=[],this._transformOperationToMutableSegmentUpdate=async e=>{if(await this._waitTimelineManagerReady,!(0,r.JY)(this._videoEnvironmentService))return[];let t=e[n.u4I.SEGMENT].filter(e=>{let{type:t,item:i}=e;return t===n.C8.UPDATE&&"id"in i||(t===n.C8.DELETE||t===n.C8.ADD)&&(0,n.Ftn)(i.segment)});return t.length?t.flatMap(e=>{let t=this.cachedMutableVideos.filter(e=>!this.cachedMutablePolyInfo.some(t=>{var i;return null===(i=t.children)||void 0===i?void 0:i.some(t=>t.id===e.segmentId)}));if((e.type===n.C8.DELETE||e.type===n.C8.ADD)&&(0,n.Ftn)(e.item.segment)){let{targetTimerange:{start:i,duration:r}}=e.item.segment,a=t.filter(e=>n.pMA.max([e.targetStart,i],"bigint")<n.pMA.min([e.targetStart+e.targetDuration,i+r],"bigint"));return a.length?a.map(e=>{let t=l.gi.from(e);return d.$.from(t)}):null}for(let i of[...this.cachedMutableVideos,...this.cachedMutableTexts]){if(!("id"in e.item)||i.segmentId===e.item.id)switch(!0){case(0,n.Ub2)(i):{let{targetStart:e,targetDuration:r}=i,a=t.filter(t=>n.pMA.max([t.targetStart,e],"bigint")<n.pMA.min([t.targetStart+t.targetDuration,e+r],"bigint"));if(!a.length)continue;return a.map(e=>{let t=l.gi.from(e);return d.$.from(t)})}case(0,n.OvQ)(i):{let e=l.gi.from(i);return d.$.from(e)}}}return null}).filter(Boolean):[]},this._reduceScreenshotUpdates=async e=>{let t=await e;if(!t)return null;t.forEach(e=>{var t,i;let{recordable:n,timeRanges:r}=e,a=null!==(i=null===(t=this._updates.get(n.resourceKey))||void 0===t?void 0:t.timeRanges)&&void 0!==i?i:[];r.push(...a),this._updates.set(n.resourceKey,e),console.log(h.U,"[listener] mutable-poly got updates",e)})},this._formatRenderMutableSegmentParams=e=>{var t;let{id:i,targetStart:n,targetDuration:r}=e,a=this._updates.get(i);return(null==a?void 0:null===(t=a.timeRanges)||void 0===t?void 0:t.length)?{id:i,interval:g.TZ[c.j.Millisecond],timeRange:{startTime:(0,u.BC)(n)+100,endTime:(0,u.BC)(n+r)+100}}:null}}}},101172:function(e,t,i){i.d(t,{W:function(){return m}});var n=i(789786),r=i(989719),a=i(800788),s=i(621249),o=i(436731),l=i(718494),d=i(994483),c=i(820359),u=i(200462),h=i(979627),g=i(159277);class m extends d.h{run(e){return new Promise(t=>{(0,a.ZB)(e,"can not find screenshot context"),this._resolve=t;let i=this.timestamps.map(e=>({time:e,callbackData:Number(e)}));!this.timestamps.length&&this._complete(e),this._register(e.editor.onGetFrames(t=>t.taskId===this._taskId&&this._onProgress(t,e))),this._taskId=e.editor.getCombinationVideoFrames(this.recordable.resourceKey,i,this.singleFrameWidth,this.singleFrameHeight),this._register({dispose:()=>{this._taskId&&e.editor.cancelGetVideoFrames(this._taskId)}}),console.log(h.U,`[task] running combination task id:${this.recordable.resourceKey} timestamp: ${this.timestamps}`)})}constructor(e){super(),this._resolve=r.Z,this._complete=e=>{console.log(h.U,`[task] combination task id:${this.recordable.resourceKey} finished`),this._setStatus(l.h.Completed),this.dispose(),this._resolve(),e.onComplete()},this._onProgress=(e,t)=>{let i=this.default;if(e.imageData){let t=new ImageData(e.imageData,e.width,e.height);i=new c.Sd({imageData:t,width:e.width,height:e.height,timestamp:BigInt(e.callbackData)})}let n=new u.N({completed:!0,sprites:i?[i]:[],resourceKey:this.recordable.resourceKey,trigger:g.a.Combination,segmentId:this.recordable.resourceKey});null==t||t.onProgress(n);let r=this.timestamps.shift();console.log(h.U,`[task] combination task id:${this.recordable.resourceKey} did timestamp: ${r} ${e.callbackData}`),e.finished&&this._complete(t)},this.run=this.run.bind(this),this.timestamps=e.timestamps,this.recordable=e.recordable,this.singleFrameHeight=e.singleFrameHeight,this.singleFrameWidth=e.singleFrameWidth,this.default=e.default,this.context=e.context}}(0,n.gn)([(0,o.h)(),(0,s.K)(),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",["undefined"==typeof ICombinationScreenshotContext?Object:ICombinationScreenshotContext]),(0,n.w6)("design:returntype",void 0)],m.prototype,"run",null)},117206:function(e,t,i){i.d(t,{O:function(){return m}});var n=i(789786),r=i(989719),a=i(800788),s=i(621249),o=i(436731),l=i(994483),d=i(718494),c=i(820359),u=i(200462),h=i(979627),g=i(159277);class m extends l.h{run(e){return new Promise(t=>{(0,a.ZB)(e,"can not find screenshot context"),this._resolve=t;let i=this.timestamps.map(e=>({time:e,callbackData:Number(e)}));!this.timestamps.length&&this._complete(e),this._register(e.editor.onGetFrames(t=>t.taskId===this._taskId&&this._onProgress(t,e))),this.recordable.subDraft&&this.recordable.segmentId?this._taskId=e.editor.getCombinationVideoFrames(this.recordable.segmentId,i,this.singleFrameWidth,this.singleFrameHeight):this._taskId=e.editor.getVideoFrames(i,this.singleFrameWidth,this.singleFrameHeight),this._register({dispose:()=>{this._taskId&&e.editor.cancelGetVideoFrames(this._taskId)}}),console.log(h.U,`[task] running mutable-poly task id:${this.recordable.resourceKey} timestamp: ${this.timestamps}`)})}constructor(e){super(),this._resolve=r.Z,this._complete=e=>{console.log(h.U,`[task] mutable-poly task id:${this.recordable.resourceKey} finished`),this._setStatus(d.h.Completed),this.dispose(),this._resolve(),e.onComplete()},this._onProgress=(e,t)=>{let i=this.default;if(e.imageData){let t=new ImageData(e.imageData,e.width,e.height);i=new c.Sd({imageData:t,width:e.width,height:e.height,timestamp:BigInt(e.callbackData)})}let n=new u.N({completed:!0,sprites:i?[i]:[],resourceKey:this.recordable.resourceKey,trigger:g.a.MutablePoly});null==t||t.onProgress(n);let r=this.timestamps.shift();console.log(h.U,`[task] mutable-poly task id:${this.recordable.resourceKey} did timestamp: ${r} ${e.callbackData}`),e.finished&&this._complete(t)},this.run=this.run.bind(this),this.timestamps=e.timestamps,this.singleFrameHeight=e.singleFrameHeight,this.singleFrameWidth=e.singleFrameWidth,this.default=e.default,this.context=e.context,this.recordable=e.recordable}}(0,n.gn)([(0,o.h)(),(0,s.K)(),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",["undefined"==typeof IMutablePolySegmentScreenshotContext?Object:IMutablePolySegmentScreenshotContext]),(0,n.w6)("design:returntype",void 0)],m.prototype,"run",null)},330699:function(e,t,i){i.d(t,{D:function(){return r}});var n=i(697549);function r(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],{onSuccess:r,onError:a,onCancel:s,onDelete:o,onMd5Set:l}=null!=t?t:{};return new n.W(e,{onSuccess:r,onError:a,onCancel:s,onDelete:o,onMd5Set:l},i)}},829144:function(e,t,i){i.d(t,{S9:function(){return g},SE:function(){return c},gx:function(){return m},h6:function(){return u},lt:function(){return h}});var n=i(690613),r=i(783122),a=i(426020),s=i(966697),o=i(127830),l=i(820193),d=i(330699);function c(e){switch(e){case r.b.GOOGLE_DRIVE:return(0,n.oW)(s.d.GoogleDrive);case r.b.DROPBOX:return(0,n.oW)(s.d.DropBox);default:return(0,n.wf)(-1,"transformThirdpartyPlatformTypeToEnterFromParams should not be called with invalid platform")}}let u={[a.YB.Video]:o._g.UserVideo,[a.YB.Image]:o._g.UserPhoto,[a.YB.Audio]:o._g.UserAudio,[a.YB.File]:o._g.UserFile};function h(e,t){let i=u[t.fileType],n=(0,l.nQ)(e,i,t);return{resourceKey:n.value.key,resourceType:i,resource:n}}function g(e,t,i){return{...h(e,t),file:i}}function m(e){let{resourceService:t,tasks:i,fileList:n}=e;return i.map((e,i)=>e.ok?new Promise((r,a)=>{let s=e.value,o=e=>{var t;a(null!==(t=null==e?void 0:e.msg)&&void 0!==t?t:"upload failure")};(0,d.D)(s,{onSuccess:()=>{let e=s.getModel(),a=g(t,e,n[i]);r({success:!0,model:e,fromFolderId:s.fromFolderId,...a})},onError:o,onCancel:o,onDelete:o})}):Promise.reject())}},490513:function(e,t,i){i.d(t,{u:function(){return a}});var n=i(320271),r=i(249656);let a=e=>{switch(e){case n.U_.VoiceChange:return r.C3.MetaTypeAudioEffect;case n.U_.TextTemplate:return r.C3.MetaTypeTextTemplate;case n.U_.Filter:return r.C3.MetaTypeFilter;case n.U_.Effects:return r.C3.MetaTypeVideoEffect;case n.U_.Default:return r.C3.MetaTypeSticker;case n.U_.Flower:return r.C3.MetaTypeTextEffect;case n.U_.Bubble:return r.C3.MetaTypeTextShape;case n.U_.Transitions:return r.C3.MetaTypeTransition;case n.U_.Canvas:return r.C3.MetaTypeCanvasImage;case n.U_.Text:case n.U_.Sticker:return r.C3.MetaTypeAnimation;case n.U_.Video:return r.C3.MetaTypeVideoAnimation;case n.U_.Fonts:return r.C3.MetaTypeText;case n.U_.AutoBeauty:case n.U_.AutoBeautyBody:case n.U_.AutoBeautyMakeup:case n.U_.AutoBeautyShape:return r.C3.MetaTypeFigure;case n.U_.FaceProp:return r.C3.MetaTypeFaceEffect;default:return r.C3.MetaTypeAll}}},217471:function(e,t,i){i.d(t,{Z:function(){return o}});var n=i(772322),r=i(141913),a=i(670933);let s=(0,r.PS)(()=>i.e("7372").then(i.bind(i,474709))),o=(0,a.f3)("store")((0,a.Pi)(e=>{let{store:t}=e,{isModalVisible:i,isLoginMaskVisible:a}=t;if(!i)return null;if(!0===a)return(0,n.jsx)(r.Xf,{fallback:null,children:(0,n.jsx)(s,{})});return null}))},445684:function(e,t,i){i.d(t,{P:function(){return o}});var n=i(789786),r=i(108692),a=i(800788),s=i(426336);class o{get dataSdk(){return this._mainDraftService.dataSdk}multiTrackCrop(e){this._mainDraftService.dataSdk.api.video.crop(e)}getSegmentById(e){return this._mainDraftService.dataSdk.draftView.getSegmentById(e)}multiTrackTrim(e,t){(0,a.Y2)(e);let{sourceStartTime:i,volume:n,videoInfo:r}=t,o=this._mainDraftService.dataSdk.draftView.getSegmentById(e);if(o&&(0,s.hey)(o)){if(r)return this._replaceSegmentManager.replaceVideo({type:r.type,value:r.value,segmentIds:[o.id],sourceStartTime:i,sourceDuration:o.sourceTimerange.duration,targetStartTime:o.targetTimerange.start,targetDuration:o.targetTimerange.duration});this._mainDraftService.dataSdk.api.video.setMaterial({segIds:[e],video:{duration:o.material.duration,path:o.material.path,volume:n,sourceStartTime:i,sourceDuration:o.sourceTimerange.duration}})}}getRelationVideoGroup(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._mainDraftService.dataSdk.draftView.getDraftId(),{draftIdToRelationVideoGroup:t}=this._mainDraftService.dataSdk.cutSame;return t[e]}getMutableVideos(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._mainDraftService.dataSdk.draftView.getDraftId();return this._mainDraftService.dataSdk.cutSame.draftIdToMutableVideos[e]}setMutableVideos(e,t){if(!this._renderManager.isResetting){let i=[];e.forEach(e=>{let t=this._renderManager.resourceRecords.getRecordBySegmentPath(e.path);if(t){var n;let r=s.HHr.parse(this._renderManager.getMediaFileInfoSync(t.resPath,null!==(n=t.decryptKey)&&void 0!==n?n:""));i.push({...e,originalPath:t.segmentPath,rotation:r.rotation,mediaType:r.type})}}),this._mainDraftService.dataSdk.api.template.setMutableVideos({videos:i,draftId:t})}}updateRenderManager(e){this._renderManager=e}constructor(e,t,i){this._renderManager=e,this._replaceSegmentManager=t,this._mainDraftService=i}}o=(0,n.gn)([(0,n.fM)(2,r.n),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",["undefined"==typeof RenderManager?Object:RenderManager,"undefined"==typeof ReplaceSegmentManager?Object:ReplaceSegmentManager,void 0===r.n?Object:r.n])],o)},265829:function(e,t,i){i.d(t,{q:()=>S});var n=i("789786"),r=i("948328"),a=i("420072"),s=i("315201"),o=i("433140"),l=i("627084"),d=i("200247"),c=i("127830"),u=i("800788"),h=i("684685"),g=i("810883"),m=i("242785");let f=async(e,t,i)=>{switch(t){case c._g.Video:return new Promise((t,i)=>{e.onReady(i=>{let{originVideo:n,duration:r}=i,{url:a}=e.getVideoResolutionInfo();t({decryptKey:"",url:a,headers:{},width:n.width,height:n.height,previewUrl:i.coverUrl,duration:r,value:i})}),e.onError(e=>{i(e)})});case c._g.UserVideo:{let t=await e.isSupportFastImport();return new Promise((i,n)=>{if(t){var r,a;let t=e.value;i({decryptKey:"",url:t.uploading.blobUrl,headers:{},width:t.width,height:t.height,duration:t.duration,previewUrl:null!==(a=null===(r=t.cover)||void 0===r?void 0:r.url)&&void 0!==a?a:"",value:t})}else{let t=e.getUserVideoResourceToken();e.onReady(e=>{var n,r,a,s,o;let{width:l,height:d,cover:c,url:u,duration:h}=e;i({decryptKey:null===(n=t.value)||void 0===n?void 0:n.decryptKey,url:null!==(s=null!==(a=null==t?void 0:null===(r=t.value)||void 0===r?void 0:r.url)&&void 0!==a?a:u)&&void 0!==s?s:"",headers:{},width:l,height:d,duration:h,previewUrl:null!==(o=null==c?void 0:c.url)&&void 0!==o?o:"",value:e})}),e.onError(e=>{n(e)})}})}default:throw Error(`resource type should be ${c._g.Video} or ${c._g.UserVideo}`)}};var p=i("798184");let v=async(e,t)=>{switch(t){case c._g.Gif:{let t=e.getGifResourceToken();return new Promise((e,i)=>{t.onReady(t=>{let{buffer:i}=t,n=new Blob([i]),r=URL.createObjectURL(n);e({decryptKey:"",url:r,headers:{},previewUrl:r})}),t.onError(e=>{i(e)}),t.start()})}case c._g.Photo:return new Promise((t,i)=>{let n=e.getCoverResourceToken();n.onReady(e=>{let{buffer:i}=e,n=new Blob([i]),r=URL.createObjectURL(n);t({decryptKey:"",url:r,headers:{},previewUrl:r})}),n.onError(e=>{i(e)}),n.start()});case c._g.UserPhoto:{let t=await e.isSupportFastImport();return new Promise((i,n)=>{(async()=>{if(t){let t=await e.getPreviewResourceToken();t.onReady(e=>{let{buffer:t}=e,n=new Blob([t]),r=URL.createObjectURL(n);i({decryptKey:"",url:r,headers:{},previewUrl:r})}),t.onError(e=>{n(e)}),t.start()}else{let t=e.getUserPhotoResourceToken();t.onReady(e=>{var n;let{buffer:r}=e,a=new Blob([r]),s=URL.createObjectURL(a);i({decryptKey:null===(n=t.value)||void 0===n?void 0:n.decryptKey,url:s,headers:{},previewUrl:s})}),t.onError(e=>{n(e)}),t.start()}})()})}default:throw Error(`resource type should be ${c._g.Photo} or ${c._g.UserPhoto}`)}},_=async(e,t)=>{switch(t){case c._g.Video:{var i;let t=new Promise((t,i)=>{let n=e.getVideoResourceToken();n.onReady(e=>{let{buffer:i}=e,n=new Blob([i]);t(URL.createObjectURL(n))}),n.onError(e=>{i(e)}),n.start()}),n=new Promise((t,i)=>{let n=e.getCoverResourceToken();n.onReady(e=>{let{buffer:i}=e,n=new Blob([i]);t(URL.createObjectURL(n))}),n.onError(e=>{i(e)}),n.start()}),[r,a]=await Promise.all([t,n]);return{url:r,previewUrl:a,decryptKey:null===(i=e.getVideoResourceToken().value)||void 0===i?void 0:i.decryptKey,headers:{}}}case c._g.UserVideo:{let t=new Promise(async t=>{if(await e.isSupportFastImport()){let i=e.getPreviewResourceToken();await (0,p.x)(i),t({url:i.value.url,decryptKey:""})}else{await (0,a.Z)(e);let i=e.getUserVideoResourceToken();t({url:i.value.url,decryptKey:i.value.decryptKey})}}),i=new Promise((t,i)=>{let n=e.getCoverResourceToken();n.onReady(e=>{let{buffer:i}=e,n=new Blob([i]);t(URL.createObjectURL(n))}),n.onError(e=>{i(e)}),n.start()}),[{url:n,decryptKey:r},s]=await Promise.all([t,i]);return{url:n,previewUrl:s,decryptKey:r,headers:{}}}default:throw Error(`resource type should be ${c._g.Video} or ${c._g.UserVideo}`)}};class S{async _parseSprites(e,t){if(this._store.sprites[t]||!this._graphicToolkitService)return;let i=await (0,h.AB)(e,this._graphicToolkitService);if(!!i&&0!==i.length)this._store.setSprites(t,i.map(e=>({image:e.image,x:e.x,y:e.y,width:e.width,height:e.height,timestamp:0n,sourceTimestamp:0n})))}async _parseCover(e,t){if(this._store.covers[t])return;let i=await (0,g.S)(e);this._store.setCover(t,i)}_generateVideoSpritesAndCover(e,t){this._parseSprites(e,t),this._parseCover(e,t)}getTrimVideoResourceInfo(e,t){let i=this._resourceService.get(e,t);if(!i)return Promise.resolve(null);if(t===c._g.UserVideo){if(this._draftMaterialsService.isMaterialExistByKey(i.value.key))i.getThumbResourceTokens().then(()=>{this._generateVideoSpritesAndCover(i,e)});else{let n=f(i,t,this._draftMaterialsService);return n.then(()=>{this._generateVideoSpritesAndCover(i,e)}),n}}else this._generateVideoSpritesAndCover(i,e);return f(i,t,this._draftMaterialsService)}async getCropResourceMeta(e){let{resourceKey:t,resourceType:i}=e,n=this._resourceService.get(t,i);if(!n)return Promise.resolve(null);switch(i){case c._g.Video:case c._g.UserVideo:{let{decryptKey:e,url:t,previewUrl:r,headers:a}=await _(n,i);return{decryptKey:e,url:t,previewUrl:r,headers:a}}case c._g.Gif:case c._g.Photo:case c._g.UserPhoto:return v(n,i);case c._g.UserFile:if(await (0,a.Z)(n),(0,u.Y2)((0,s.R)(n.value)),this._accountService.hasLogin){let e=await this._evercloudTokenDataService.getEvercloudToken();if(!e.ok)return null;return{url:n.value.url,decryptKey:n.value.decryptKey,headers:{"x-everphoto-global-session-token":e.value.token,"x-everphoto-token":e.value.token}}}return{url:n.value.url,decryptKey:n.value.decryptKey,headers:{}};default:throw Error(`resource type should be ${c._g.Video}, ${c._g.UserVideo}, ${c._g.Photo} or ${c._g.UserPhoto}`)}}constructor(e,t,i,n,r,a){this._store=e,this._resourceService=i,this._evercloudTokenDataService=n,this._draftMaterialsService=r,this._accountService=a,t.getInstance().then(e=>{this._graphicToolkitService=e})}}S=(0,n.gn)([(0,n.fM)(1,m.r),(0,n.fM)(2,o.c),(0,n.fM)(3,l.o),(0,n.fM)(4,r.D),(0,n.fM)(5,d.D),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",["undefined"==typeof ModalStore?Object:ModalStore,void 0===m.r?Object:m.r,void 0===o.c?Object:o.c,void 0===l.o?Object:l.o,void 0===r.D?Object:r.D,void 0===d.D?Object:d.D])],S)},677855:function(e,t,i){i.d(t,{iI:function(){return l},nt:function(){return o},sj:function(){return a},yi:function(){return s}});var n,r,a=((n={})[n.Low=1]="Low",n[n.Normal=2]="Normal",n[n.Fast=4]="Fast",n);var s=((r={})[r.Flexible=1]="Flexible",r[r.Normal=2]="Normal",r[r.Stable=3]="Stable",r);let o={2:"normal",4:"fast",1:"slow"},l={1:"flexible",2:"normal",3:"stable"}},816114:function(e,t,i){i.d(t,{p:function(){return u}});var n=i(789786),r=i(426336),a=i(433140),s=i(127830),o=i(583697),l=i(108692),d=i(242785),c=i(684685);class u{async renderFrames(e,t){let{clientWidth:i}=e,{clientHeight:n}=e,r=await this.getFrames(t,{width:i,height:n});if(!(r.length>0))return e.classList.add("empty-frames"),!1;{let t=document.createElement("canvas");t.width=i,t.height=n;let a=i/r.length,s=n/r[0].height,o=n,l=r[0].width*s;l<a&&(o=o/a*l,l=a);let d=0,c=t.getContext("2d"),u=n/l;for(let e of r){let{image:t,x:r,y:s,width:o}=e;d+l>i&&(u=n/(l=i-d)),c.drawImage(t,r,s,o,o*u,d,0,l,n),d+=a}return e.innerHTML="",e.appendChild(t),!0}}renderDefaultFrame(e,t){let{clientWidth:i}=e,{clientHeight:n}=e,r=document.createElement("canvas");r.width=i,r.height=n;let a=document.createElement("canvas");a.width=t.clientWidth,a.height=t.clientHeight,a.getContext("2d").drawImage(t,0,0,a.width,a.height);let s=n*(t.clientWidth/t.clientHeight),o=Math.ceil(i/s),l=r.getContext("2d"),d=0;for(let e=0;e<o;e++)l.drawImage(a,0,0,t.clientWidth,t.clientHeight,d,0,s,n),d+=s;e.innerHTML="",e.appendChild(r)}async getFrames(e,t){let i=this._mainDraftService.dataSdk.draftView.getSegmentById(e);if(!i||!(0,r.hey)(i))return[];let{reverse:n,sourceTimerange:a}=i;if(this._frames.id===e&&this._frames.sprites.length>0&&this._frames.start===a.start&&this._frames.duration===a.duration&&n===this._frames.reverse)return this._frames.sprites;let s=this.getVideoResource(e);if(s){let i=await (0,c.AB)(s,this._graphicToolkitService);if(0===i.length)return[];n&&i.reverse();let{height:r,width:o}=i[0],l=t.height,d=Math.floor(t.width/(l/r*o)),{start:u,end:h}=this.getSegmentRange(e),g=Math.floor(i.length*u),m=Math.floor(i.length*h),f=i.slice(g,m);if(f.length>d){let e=Math.floor(f.length/d);f=Array.from({length:d}).map((t,i)=>i===d-1?f[f.length-1]:f[i*e])}else if(f.length<d){let e=(t,i)=>{let n=[...t],{length:r}=t;if(r>=i)return t;for(let e=0;e<r;e++){let r=t[e];if(n.splice(2*e+1,0,r),n.length===i)return n}return n.length<i?e(n,i):n};f=e(f,d)}return this._frames={id:e,sprites:f,reverse:n,start:a.start,duration:a.duration},f}return[]}getSegmentRange(e){let t=this._mainDraftService.dataSdk.draftView.getSegmentById(e);if(t&&(0,r.hey)(t)){let{material:e,sourceTimerange:i}=t,{duration:n}=e,{start:a,duration:s}=i,o=r.pMA.div(a,n);return{start:o,end:r.pMA.div(r.pMA.plus(a,s),n)}}return{start:0,end:1}}getVideoResource(e){let t=this.getResourceKey(e),i=this._getResourceType(e);return t?this._resourceService.get(t,i):void 0}_getResourceType(e){let t=s._g.Video,i=this._mainDraftService.dataSdk.draftView.getSegmentById(e);return i&&(0,r.hey)(i)&&(0,o.$d)(i.material)||t}getResourceKey(e){var t;let i=this._mainDraftService.dataSdk.draftView.getSegmentById(e);if(!i||!(0,r.hey)(i))return"";let{material:n}=i,{path:a}=n;return null!==(t=this._mainDraftService.draftPathStore.getResourceKeyFromDraftPath(a))&&void 0!==t?t:""}destroy(){this._frames={id:"",sprites:[],reverse:!1,start:0n,duration:0n}}constructor(e,t,i){this._mainDraftService=e,this._resourceService=t,this._frames={id:"",reverse:!1,start:0n,duration:0n,sprites:[]},i.getInstance().then(e=>{this._graphicToolkitService=e})}}u=(0,n.gn)([(0,n.fM)(0,l.n),(0,n.fM)(1,a.c),(0,n.fM)(2,d.r),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===l.n?Object:l.n,void 0===a.c?Object:a.c,void 0===d.r?Object:d.r])],u)},378847:function(e,t,i){i.d(t,{Pp:function(){return l},ZP:function(){return m},_l:function(){return d}});var n=i(772322),r=i(141913),a=i(670933),s=i(218571),o=i(831228);let l=()=>Promise.all([i.e("1428"),i.e("149"),i.e("2133"),i.e("9653"),i.e("5798")]).then(i.bind(i,543690)),d=()=>Promise.all([i.e("1428"),i.e("7920"),i.e("149"),i.e("2133"),i.e("2277"),i.e("7677")]).then(i.bind(i,540655)),c=(0,r.PS)(l),u=(0,r.PS)(d),h=(0,r.PS)(()=>i.e("5598").then(i.bind(i,819301))),g=(0,r.PS)(()=>i.e("3210").then(i.bind(i,544855))),m=(0,a.f3)("store")((0,a.Pi)(e=>{let{store:t,segmentSelection:i}=e,a=(0,s.useCallback)(()=>t.actionIsMutableTrimModalVisibleSet(!1),[t]),l=(0,s.useCallback)(()=>t.actionIsMutableCropModalVisibleSet(!1),[t]);return(0,n.jsxs)(r.Xf,{fallback:(0,n.jsx)(o.i,{}),children:[t.isMutableTrimModalVisible&&(0,n.jsx)(c,{visible:t.isMutableTrimModalVisible,onClose:a,segmentSelection:i}),t.isMutableCropModalVisible&&(0,n.jsx)(u,{visible:t.isMutableCropModalVisible,onClose:l,segmentSelection:i}),t.isTransferPermissionModalVisible&&(0,n.jsx)(h,{visible:t.isTransferPermissionModalVisible,store:t}),t.isPasswordFlowVisible&&(0,n.jsx)(g,{visible:t.isPasswordFlowVisible,store:t})]})}))},583697:function(e,t,i){i.d(t,{$d:function(){return o},Xd:function(){return a},n3:function(){return d},q$:function(){return l},zg:function(){return s}});var n=i(426336),r=i(127830);let a=(e,t)=>{let{targetTimerange:i,sourceTimerange:r}=t,a=(0,n.hey)(t)||(0,n.Y9Q)(t)?t.speed.speed:1,{start:s=0n,duration:o=0n}=null!=r?r:{},{start:l,duration:d}=i,c=n.pMA.div(s,1e3),u=n.pMA.div(o,1e3),h=n.pMA.div(l,1e3),g=n.pMA.div(d,1e3),m=0;return e>h&&e<=h+g&&(m=(e-h)*a+c),{start:c,duration:u,seek:m}};function s(e){let{lowerLeftX:t,lowerLeftY:i,lowerRightX:n,lowerRightY:r,upperLeftX:a,upperLeftY:s,upperRightX:o,upperRightY:l}=e;return!(0===t&&1===i&&1===n&&1===r&&0===a&&0===s&&1===o&&0===l)}function o(e){let{type:t,sourcePlatform:i}=e,a=i===n.cvu.MaterialPlatformDefault;switch(t){case n.cVg.MetaTypeVideo:return i===n.cvu.MaterialPlatformDefault?r._g.UserVideo:r._g.Video;case n.cVg.MetaTypePhoto:case n.cVg.MetaTypeImage:return i===n.cvu.MaterialPlatformDefault?r._g.UserPhoto:r._g.Photo;case n.cVg.MetaTypeGif:return a?r._g.UserPhoto:r._g.Gif;default:return null}}let l=e=>{if("change_ratio"===e)return"ratio";return e},d=(e,t)=>{let i=10*Number(e.toFixed(1)),n=10*Number(t.toFixed(1));if(0===i||0===n)return"";let r=(e,t)=>0===t?e:r(t,e%t),a=r(i,n);return`${i/a}:${n/a}`}},953049:function(e,t,i){i.d(t,{s:function(){return n}});class n{set state(e){"loaded"===e&&"loaded"!==this._state&&!Number.isNaN(this._curOverlapStart)&&(this.uxOverlap+=performance.now()-this._curOverlapStart,this._curOverlapStart=NaN),this._state=e,this.run()}get state(){return this._state}set isLogin(e){this._isLogin=e,this.run()}get isLogin(){return this._isLogin}set isShowGuide(e){this._isShowGuide=e,this.run()}get isShowGuide(){return this._isShowGuide}register(e){var t;null===(t=e.onRegister)||void 0===t||t.call(e),this.modals.push({...e,weight:e.weight||0,loadingDone:!e.onPageLoading,loadedDone:!e.onPageLoaded,loggedInDone:!e.onPageLoggedIn}),this.modals.sort((e,t)=>t.weight-e.weight),this.run()}run(){if(this.current||"failed"===this._state)return;if(this.runState("loadingDone","onPageLoading"),!this.current){if("loaded"===this._state){if(this.runState("loadedDone","onPageLoaded"),this.current)return;this._isShowGuide&&this.runState("loggedInDone","onPageLoggedIn")}}}runState(e,t){for(let r of this.modals)if(!r[e]&&"function"==typeof r[t]){var i,n;try{;this.current=null===(i=r[t])||void 0===i?void 0:i.call(r),this.currentName=r.name}catch(e){this.current=void 0,this.currentName=void 0}if(r[e]=!0,(n=this.current)===Promise||n instanceof Promise){this._curOverlapStart=performance.now(),this.current.finally(()=>{"loadingDone"===e&&"onPageLoading"===t&&"loading"===this._state&&!Number.isNaN(this._curOverlapStart)&&(this.uxOverlap+=performance.now()-this._curOverlapStart,this._curOverlapStart=NaN),this.current=void 0,this.currentName=void 0,this.run()});return}}}constructor(){this.uxOverlap=0,this._curOverlapStart=NaN,this._state="loading",this._isLogin=!1,this._isShowGuide=!1,this.modals=[]}}},583031:function(e,t,i){i.d(t,{Z:function(){return ee}});var n=i(789786),r=i(589252),a=i(901840),s=i(689050),o=i(611881),l=i(617508),d=i(780910),c=i(827084),u=i(420072),h=i(315201),g=i(731992),m=i(173888),f=i(426020),p=i(433140),v=i(31463),_=i(744268),S=i(782350),y=i(430687),x=i(127830),b=i(249656),M=i(906419),T=i(572669),I=i(427683),k=i(820193),D=i(7703),C=i(989611),w=i(512619),E=i(433744),A=i(948328),R=i(617660),P=i(753809),L=i(206994),N=i(806731),B=i(425427),O=i(196769),j=i(969094),U=i(289732),V=i(108692),F=i(434316),z=i(690613),W=i(426336),Y=i(829144),K=i(234075),Z=i.n(K),G=i(854585),H=i(144144),X=i(937567),Q=i(255605),q=i(196269),J=i(535379),$=i(124394);class ee{async preloadPackageData(e,t,i,n){let{isFromThirdPartPlatform:r,draftIdFromUrl:a}=this._videoEnvironmentService,s=null!=i?i:a,[o]=[!!s,r];if(!o)return(0,z.oW)(null);let l=document.getElementById("GTW_DRAFT_JSONP")&&!t?(0,Q.bA)(this._containerService):(0,Q.ol)(e,this._containerService,s,n),d=await l;if(!d.ok&&(d=await (0,Q.ol)(e,this._containerService,s,n)),window.__draftPreloadData=d,!d.ok)return d;let c=(0,Q.xz)(d.value.data);return(0,z.oW)(c)}preloadCombinationTemplates(e){return(0,q.A4)(this._containerService,e)}warmupTemplateResourceWithoutFS(e){let t;let i=[];return(async()=>{let n;let r=(0,c.Bc)(e);this._resourceService.add(r,{key:r,type:x._g.VideoTemplate,id:e});let a=this._resourceService.get(r,x._g.VideoTemplate);if(await (0,u.Z)(a),t)return;if(!(0,h.R)(a.value))return;n=a.value;let s=(0,R.G)(n),l=await this._parserDraftResource(Promise.resolve((0,z.oW)(s)));if(t||!l)return;let{onlineMaterials:g,everCloudMaterials:m,algorithmProductMaterials:f,userMaterialLifeCycles:p,preloadMaterialItems:v,effects:_}=l;g.forEach(async e=>{let{online:n,preloadMaterial:r}=e,a=await this._ensureManager.getWarmupResourceWithToken({material:n,overrideSupportStream:r.support_stream});!t&&a.ok&&i.push(a.value)});let S=new Map;p.forEach(e=>{S.set(e.md5,e)}),[...m,...f].forEach(async e=>{var n;let r=S.get(e.asset.md5);if(!r){console.error("[startup] cannot find a lifecycle for EverCloud material",e);return}let a=r.getModel();if(!(null===(n=a.draftDelta)||void 0===n?void 0:n.sourcePath))return;let s=await this._ensureManager.getWarmupResourceWithToken({material:(0,k.GL)(a,Y.h6[a.fileType]),overrideSupportStream:(0,o.py)(e)});!t&&s.ok&&i.push(s.value)});let y=await a.getBuiltinResourceTokens();if(t)return;let b=n.preload.builtIns.reduce((e,t)=>(e[this._getBuiltInResourceKey(t)]=t.path,e),{}),T={...(0,M.Z)([...v.builtInMaterials,...v.remainingBuiltInResources],e=>e.builtIn.path)};y.filter(e=>{var t;return!!(null===(t=e.value)||void 0===t?void 0:t.url)}).forEach(e=>{let t=T[b[e.value.key]];!(0,d.ln)(t,this._configurationService)&&(e.start(),i.push(()=>{e.cancel()}))}),_.forEach(async e=>{var n,r;let a=null===(r=e.resource)||void 0===r?void 0:null===(n=r.resourceId)||void 0===n?void 0:n.toString();if(!a||a===P.Rw.resourceId)return;let s=await this._ensureManager.getWarmupResourceWithToken({material:e});!t&&s.ok&&i.push(s.value)})})(),()=>{t=!0,i.forEach(e=>{null==e||e()})}}async _parserDraftResource(e,t,i){var n,r;let[o,d]=(await e).pair();if(o)return null;if(console.log("[startup] did enter preload resources",d),!(null==d?void 0:d.resourceInfos))return null;console.log("[startup] did start preload resources");let{resourceInfos:c,attachments:u,template:h}=d,g=W.HHr.parse(h),{onlineResourceList:m}=c,f=m.reduce((e,t)=>{let i=(0,a.M)(t,this._reportService);return{...e,[t.schema]:i}},{});console.log("[startup] did finish compute schema map",f=(0,T.Z)(i)?i(f):f);let p=null!==(n=null==d?void 0:d.packageAssets.filter(e=>!["cover.jpg","template.json"].includes(e.source_path)))&&void 0!==n?n:[];p=(0,T.Z)(t)?t(p):p;let v=(0,l.P)(this._videoEnvironmentService,d,f,g,t),{builtInMaterials:_,onlineMaterials:S,everCloudMaterials:y,algorithmProductMaterials:x,folders:b,maxSubDraftDepth:M}=v;(0,L.b)(this._containerService,M);let I=[..._,...y].map(e=>e.preloadMaterial.material_id),C=(0,s.kL)(d.preloadResources.effects,f,I,g),{effects:w,oldResourceIdToNewResourceIdMap:E}=C;console.log("[startup] did parse preload resource items",v);let A=(0,N.J)(d.template),R=(0,D.f)({containerService:this._containerService,workspaceId:this._mainDraftService.draftWorkspaceManager.workspaceId,packageAssets:p,preloadMaterialFromEvercloud:null!==(r=null==d?void 0:d.resourceInfos.everCloudResourceList)&&void 0!==r?r:[]}),P=[];R.ok&&(P=R.value);let B=P;try{let e=B.filter(e=>!(0,k.fA)(e.getModel()));e.length>0&&this._reportService.reportDevEvent("preload_pending_user_materials",{pendingUserMaterialCount:e.length,pendingUserMaterialIds:e.map(e=>e.md5).join(",")})}catch(e){}return{preloadedPackageData:d,onlineMaterials:S,invalidUserMaterialLifeCycles:[],preloadMaterialItems:v,preloadEffectItems:C,oldResourceIdToNewResourceIdMap:E,everCloudMaterials:y,algorithmProductMaterials:x,userMaterialLifeCycles:B,effects:w,attachments:u,tracksMeta:A,folders:b}}_ensureDigitalHumanRelatedMask(e){let t=(0,J.X)(this._videoDataService,this._mainDraftService.dataSdk,e),i=e=>{console.error(" ensure digital human related mask error: ",e)};return t.catch(e=>(i(e),(0,z.oW)([]))).then(e=>{if(!e.ok)return;let{value:t}=e;if(t.length)return Promise.all(t.map(e=>{let{value:t}=(0,k.nQ)(this._resourceService,x._g.Video,e);return this._ensureManager.ensureMaterial({key:t.key,resource:t},(0,$.do)(t))}))}).catch(e=>{i(e)})}constructor({ensureManager:e,attachmentSaveManager:t,containerService:i},n,l,d,c,p,v,_,S){this._resourceService=n,this._draftMaterialService=l,this._mainDraftService=d,this._reportService=c,this._configurationService=p,this._videoEnvironmentService=v,this._workspaceService=_,this._videoDataService=S,this.preloadDraftResources=async(e,t,i)=>{var n,a;let s=await this._parserDraftResource(e,i);if((null==t?void 0:t.shouldMeasure)&&((0,H.Ie)(X.DOWNLOAD_EFFECTS),(0,H.Ie)(X.DOWNLOAD_MATERIALS_EVERCLOUD),(0,H.Ie)(X.DOWNLOAD_MATERIALS_ONLINE)),!s)return null;let{preloadedPackageData:l,onlineMaterials:d,everCloudMaterials:c,algorithmProductMaterials:u,userMaterialLifeCycles:h,invalidUserMaterialLifeCycles:g,preloadMaterialItems:m,preloadEffectItems:f,oldResourceIdToNewResourceIdMap:p,effects:v,tracksMeta:_,folders:S,attachments:y}=s,{waitForMaterialsEnsured:x,waitForOnlineMaterialMetasReady:b,waitForCloudMaterialMetasReady:M,pOnlineMaterials:T,pCloudMaterials:I,onlineMaterialList:k,everCloudMaterialList:D}=(0,o.of)(this._ensureManager,this._videoEnvironmentService,this._mainDraftService.draftPathStore,d,c,u,h),C=this._ensureDigitalHumanRelatedMask(k),{waitForEffectsEnsured:w,waitForEffectMetasReady:E,shouldProgressivelyLoadResources:A}=(0,r.u)(this._ensureManager,v,_,null!==(n=null==t?void 0:t.shouldDisableProgressiveLoading)&&void 0!==n&&n,(0,B.JY)(this._videoEnvironmentService));console.log("[startup] did finish ensure resources");let R=this._ensureManager.ensureBuiltInModules(_),P=(0,o.fN)(this._ensureManager,S),L=async()=>{await Promise.all([x(),w(),C,R,P]),this._ensureManager.ensureAttachments(y),this._attachmentSaveManager.startListenSaveEvents()},N=async()=>{await Promise.all([b(),E(),M()])};return(null==t?void 0:t.shouldMeasure)&&(w().then(()=>(0,H.oe)(X.DOWNLOAD_EFFECTS)),I.then(()=>(0,H.oe)(X.DOWNLOAD_MATERIALS_EVERCLOUD)),T.then(()=>(0,H.oe)(X.DOWNLOAD_MATERIALS_ONLINE))),{waitForEnsureFinished:L,userMaterialLifeCycles:h,invalidUserMaterialLifeCycles:g,preloadMaterialItems:m,preloadEffectItems:f,oldResourceIdToNewResourceIdMap:p,waitForMetasReady:N,rawPreloadMaterialsMap:null!==(a=l.preloadResources.materials)&&void 0!==a?a:{},waitForMaterialsEnsured:x,waitForEffectsEnsured:w,pEnsureBuiltInModules:R,pOnlineMaterials:T,pCloudMaterials:I,pBuiltInMaterials:Promise.resolve([]),pEmptyBuiltInMaterials:Promise.resolve([]),onlineMaterialList:k,everCloudMaterialList:D,effectMaterialList:v,shouldProgressivelyLoadResources:A}},this.preloadTemplateResources=async(e,t)=>{let i;if(!e)return null;if(await (0,u.Z)(e),!(0,h.R)(e.value))return null;i=e.value;let n=(0,R.G)(i),r=this.preloadDraftResources(Promise.resolve((0,z.oW)(n)),t),s=await r;if(!s)return null;let{userMaterialLifeCycles:l,invalidUserMaterialLifeCycles:d,preloadMaterialItems:c,preloadEffectItems:g,oldResourceIdToNewResourceIdMap:m,waitForMetasReady:f,rawPreloadMaterialsMap:p,waitForMaterialsEnsured:v,waitForEffectsEnsured:_,pEnsureBuiltInModules:S,pOnlineMaterials:y,pCloudMaterials:x,onlineMaterialList:b,everCloudMaterialList:M,effectMaterialList:T,shouldProgressivelyLoadResources:I}=s,k=i.preload.builtIns.reduce((e,t)=>(e[(0,a.F)(t)]=t.path,e),{});(null==t?void 0:t.shouldMeasure)&&(0,H.Ie)(X.DOWNLOAD_MATERIALS_BUILTIN);let D=(0,o.Wp)(this._ensureManager,e,k,c),C=(0,o.cY)(e);return(null==t?void 0:t.shouldMeasure)&&D.then(()=>{(0,H.oe)(X.DOWNLOAD_MATERIALS_BUILTIN)}),{waitForEnsureFinished:async()=>{await Promise.all([D,s.waitForEnsureFinished()])},userMaterialLifeCycles:l,invalidUserMaterialLifeCycles:d,preloadMaterialItems:c,preloadEffectItems:g,oldResourceIdToNewResourceIdMap:m,waitForMetasReady:f,rawPreloadMaterialsMap:p,waitForMaterialsEnsured:v,waitForEffectsEnsured:_,pEnsureBuiltInModules:S,pOnlineMaterials:y,pCloudMaterials:x,pBuiltInMaterials:D,pEmptyBuiltInMaterials:C,onlineMaterialList:b,everCloudMaterialList:M,effectMaterialList:T,shouldProgressivelyLoadResources:I}},this.syncTemplateResources=async(e,t,i,n)=>{let{remainingBuiltInResources:r,builtInMaterials:s,duplicatedBuiltinResourceMap:o}=t,l=new Set,d=i?C.N:w.f,c=n?(0,I.Z)(n):n;await this._workspaceService.initialize((0,F.fC)());let u=d({templateId:e,data:[...s,...r].filter(e=>{let{path:t,md5:i}=e.builtIn;if(t===W.Fxj||t===W.oUy)return!1;let n=o[t];return!(n&&n!==t||l.has(i))&&(l.add(i),!0)}).map(e=>({uri:e.builtIn.uri,md5:e.builtIn.md5,url:e.builtIn.url,decryptKey:e.builtIn.key,fileType:this._getBuiltInResourceType(e),key:(0,a.F)(e.builtIn),decryptType:e.builtIn.aes?b.PS.AES_GCM:b.PS.AES_CBC})),toWorkspaceId:this._mainDraftService.draftWorkspaceManager.workspaceId,payinPayoutHelper:this._containerService.createInstance(O.o),containerService:this._containerService});this._draftMaterialService.batchAddToAutoGenerated(u);let h=[];u.forEach((e,t,i)=>{let{length:n}=i,r=e.getModel(),a=(0,g.l)(Y.h6[r.fileType],{...r,onProgress:e.onModelUpdate,onReady:e.onDidDone},e.status===m.a.Success);this._resourceService.add(a.key,a.resource),e.onDidSync2UserMaterial(()=>{h.push({status:"success",key:a.key,md5:a.resource.md5,newMd5:e.getModel().md5}),h.length===n&&(null==c||c(h))}),e.onSync2UserMaterialFailure(e=>{h.push({status:"fail",key:a.key,md5:a.resource.md5,code:null==e?void 0:e.code}),h.length===n&&(null==c||c(h))})})},this.preloadThirdPartyResources=async(e,t)=>{var i,n,o;let[l,d]=(await e).pair();if(l||!d)return null;let{resourceInfos:c,preloadResources:u,template:h}=d,{onlineResourceList:g}=c,{materialItems:m}=(0,j.i)(d),{visitorAssetList:f}=m,p=(0,E.a)(f.map(e=>e.resource),{toWorkspaceId:this._mainDraftService.draftWorkspaceManager.workspaceId,payinPayoutHelper:this._containerService.createInstance(O.o),containerService:this._containerService,syncAssetOptions:{invisible:!0,noOccupy:!0,noTranscode:!1}}),v=[],_=[];for(let e=0;e<f.length;e++){let t=f[e],n=p[e].getModel(),r=this._ensureManager.ensureMaterial((0,k.GL)(n,Y.h6[n.fileType]),Z().join("/",t.asset.path),{draftPathStrategy:U.S.ForceGenerateNew,overrideSupportStream:!(null==t?void 0:null===(i=t.preloadMaterial)||void 0===i?void 0:i.support_stream)});v.push(r.waitForResourceMetaReady()),_.push(r.waitForResourceValueReady())}let S=()=>Promise.all(v),y=()=>Promise.all(_),x=g.reduce((e,t)=>{let i=(0,a.M)(t,this._reportService);return{...e,[t.schema]:i}},{}),b=(0,s.kL)(u.effects,x,[],W.HHr.parse(h)),M=(0,N.J)(d.template),{effects:T,oldResourceIdToNewResourceIdMap:I}=b,{waitForEffectsEnsured:D,waitForEffectMetasReady:C}=(0,r.u)(this._ensureManager,T,M,null!==(n=null==t?void 0:t.shouldDisableProgressiveLoading)&&void 0!==n&&n);return{waitForMetasReady:async()=>{await Promise.all([C(),S()])},waitForEnsureFinished:async()=>{await Promise.all([y(),D()]),this._ensureManager.ensureAttachments({}),this._attachmentSaveManager.startListenSaveEvents()},userMaterialLifeCycles:p,oldResourceIdToNewResourceIdMap:I,thirdPartyResourcePromiseList:_,rawPreloadMaterialsMap:null!==(o=d.preloadResources.materials)&&void 0!==o?o:{}}},this._getBuiltInResourceKey=e=>`${e.md5}${e.key?`_${e.key.slice(0,6)}`:""}`,this._getBuiltInResourceType=e=>{if(!("preloadMaterial"in e)){var t;return(null===(t=e.builtIn.mime_type)||void 0===t?void 0:t.startsWith("image/"))?f.YB.Image:f.YB.File}let{preloadMaterial:{meta_type:i}}=e;if(G.De.includes(i))return f.YB.Video;if(G.DZ.includes(i))return f.YB.Image;if(G.t6.includes(i))return f.YB.Audio;return f.YB.File},this._ensureManager=e,this._attachmentSaveManager=t,this._containerService=i}}ee=(0,n.gn)([(0,n.fM)(1,p.c),(0,n.fM)(2,A.D),(0,n.fM)(3,V.n),(0,n.fM)(4,v.m),(0,n.fM)(5,_.Ui),(0,n.fM)(6,B.rO),(0,n.fM)(7,S.W),(0,n.fM)(8,y.u),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[Object,void 0===p.c?Object:p.c,void 0===A.D?Object:A.D,void 0===V.n?Object:V.n,void 0===v.m?Object:v.m,void 0===_.Ui?Object:_.Ui,void 0===B.rO?Object:B.rO,void 0===S.W?Object:S.W,void 0===y.u?Object:y.u])],ee)},764749:function(e,t,i){i.d(t,{f:function(){return n}});let n=e=>{let t=/(.*):\/\/(.*)/.exec(e),i=t[1].toLowerCase(),n=t[2].split("/");return{platform:i,id:1===n.length?n[0]:n.slice(1).join("/"),panel:1===n.length?null:n[0]}}},901840:function(e,t,i){i.d(t,{F:function(){return u},M:function(){return c}});var n=i(626516),r=i(983171),a=i(518911),s=i(867179),o=i(77324),l=i(753809),d=i(520980);let c=(e,t)=>{if(null==e?void 0:e.heycan_item)return(0,n.L)({...null==e?void 0:e.heycan_item,scheme:e.schema},t);if(null==e?void 0:e.song_item)return(0,r.x)(e.song_item);if(null==e?void 0:e.giphy_item)return(0,a.T)(e.giphy_item);else if(null==e?void 0:e.loki_item)return e.loki_item.ResourceId.toString()===l.Rw.resourceId||"system-fonts"===e.loki_item.Panel?null:(0,s.$)(d.n,e.loki_item,t);else if(null==e?void 0:e.tuchong_item){let{effect_item:i}=e.tuchong_item;return(0,n.L)(i,t)}else if(null==e?void 0:e.brand_resource)return(0,o.f)(e.brand_resource);return null},u=e=>`${e.md5}${e.key?`_${e.key.slice(0,6)}`:""}`},229465:function(e,t,i){i.d(t,{n:function(){return r}});var n=i(670933);function r(e){return(0,n.Pi)(e)}},231471:function(e,t,i){i.d(t,{KK:function(){return m},cD:function(){return g},cL:function(){return f},iq:function(){return h}});var n=i(426336),r=i(218571),a=i(260963),s=i(937802),o=i(800788),l=i(108692),d=i(118642),c=i(262319),u=i(894907);let h=(e,t)=>{let i=(0,s.G)(l.n),h=(0,d.th)(i.dataSdk,e,t,n.Eu.KFTypeSaturation)[0],[g,m]=(0,r.useState)(h),f=(0,c.jL)(e);return(0,o.Y2)((0,a.bi)(e),"[useSaturation] expect segment is observable"),(0,r.useEffect)(()=>(0,a.U5)(()=>(0,u.Y)([null==f?void 0:f.saturation]),()=>{m((0,d.th)(i.dataSdk,e,t,n.Eu.KFTypeSaturation)[0])},{fireImmediately:!0}),[i.dataSdk,e,f,t]),{value:g}},g=(e,t)=>{let i=(0,s.G)(l.n),h=(0,d.th)(i.dataSdk,e,t,n.Eu.KFTypeTemperature)[0],[g,m]=(0,r.useState)(h),f=(0,c.jL)(e);return(0,o.Y2)((0,a.bi)(e),"[useTemperature] expect segment is observable"),(0,r.useEffect)(()=>(0,a.U5)(()=>(0,u.Y)([null==f?void 0:f.colorTemperature]),()=>{m((0,d.th)(i.dataSdk,e,t,n.Eu.KFTypeTemperature)[0])},{fireImmediately:!0}),[i.dataSdk,e,f,t]),{value:g}},m=(e,t)=>{let i=(0,s.G)(l.n),h=(0,d.th)(i.dataSdk,e,t,n.Eu.KFTypeHue)[0],[g,m]=(0,r.useState)(h),f=(0,c.jL)(e);return(0,o.Y2)((0,a.bi)(e),"[useHue] expect segment is observable"),(0,r.useEffect)(()=>(0,a.U5)(()=>(0,u.Y)([null==f?void 0:f.hue]),()=>{m((0,d.th)(i.dataSdk,e,t,n.Eu.KFTypeHue)[0])},{fireImmediately:!0}),[i.dataSdk,e,f,t]),{value:g}},f=e=>{let t=(0,s.G)(l.n),i=(0,c.jL)(e),[n,d]=(0,r.useState)(null==i?void 0:i.colorCurves);return(0,o.Y2)((0,a.bi)(e),"[useColorCurves] expect segment is observable"),(0,r.useEffect)(()=>(0,a.U5)(()=>(0,u.Y)([null==i?void 0:i.colorCurves]),()=>{d(null==i?void 0:i.colorCurves)},{fireImmediately:!0}),[t.dataSdk,i]),{value:n}}},711536:function(e,t,i){i.d(t,{D:function(){return d},t:function(){return l}});var n=i(789786),r=i(260963),a=i(569471),s=i(800788),o=i(531474);let l=Symbol.for("__current_segment_store__");class d{_recursiveMergeSegment(e){(0,s.ZB)(this._observableData.currentSegment),(0,o.T)(this._observableData.currentSegment,e)}updateCurrentSegment(e){this._recursiveMergeSegment(e)}changeCurrentSegment(e){if(!e){(0,r.t8)(this._observableData,{currentSegment:e});return}(0,r.t8)(this._observableData,{currentSegment:(0,a.I)(e)})}get currentSegmentId(){var e;return null===(e=this._observableData.currentSegment)||void 0===e?void 0:e.id}get currentSegment(){return this._observableData.currentSegment}constructor(e,t){this._dataSdk=e,this._missingDependenciesTracker=t,this._observableData=(0,r.LO)({currentSegment:null})}}(0,n.gn)([r.aD,(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",["undefined"==typeof SegmentDeltaCurrent?Object:SegmentDeltaCurrent]),(0,n.w6)("design:returntype",void 0)],d.prototype,"_recursiveMergeSegment",null),(0,n.gn)([r.aD,(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",["undefined"==typeof SegmentDeltaCurrent?Object:SegmentDeltaCurrent]),(0,n.w6)("design:returntype",void 0)],d.prototype,"updateCurrentSegment",null),(0,n.gn)([r.aD,(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[Object]),(0,n.w6)("design:returntype",void 0)],d.prototype,"changeCurrentSegment",null)},655400:function(e,t,i){i.d(t,{q:function(){return g}});var n=i(789786),r=i(587892),a=i(402655),s=i(800788),o=i(591010),l=i(126429),d=i(426336),c=i(260963),u=i(298730),h=i(425427);class g extends a.JT{get observeData(){return this._observeData}get onSubDraftTemplateIdChange(){return this._onSubDraftTemplateIdChange.event}get onSubDraftRatioChange(){return this._onSubDraftRatioChange.event}get onSubDraftSegmentChange(){return this._onSubDraftSegmentChange.event}get onNestedSelectedSegmentIdsChange(){return this._onNestedSelectedSegmentIdsChange.event}get onBatchReplacingSegmentIdChange(){return this._onBatchReplacingSegmentIdChange.event}get onExpandedSegmentIdChange(){return this._onExpandedSegmentIdChange.event}get onMutableVideosChange(){return this._onMutableVideosChange.event}get onMutableAudiosChange(){return this._onMutableAudiosChange.event}get onMutableTextsChange(){return this._onMutableTextsChange.event}get onRelationVideoGroupChange(){return this._onRelationVideoGroupChange.event}get relationVideoGroup(){return this._observeData.relationVideoGroup}get batchReplacingSegmentId(){return this._observeData.batchReplacingSegmentId}get expandedSegmentId(){return this._observeData.expandedSegmentId}get nestedSelectedSegmentIds(){return this._observeData.nestedSelectedSegmentIds}get previewSelectedSegmentIds(){return this._observeData.previewSelectedSegmentIds}get topLevelSelectedSegmentIds(){return this._observeData.topLevelSelectedSegmentIds}get subDraftSegment(){return this._observeData.subDraftSegment}get subDraftSegmentId(){return this._observeData.subDraftSegmentId}get subDraftTemplateId(){var e;return null===(e=this.subDraftSegment)||void 0===e?void 0:e.templateId}get subDraftId(){return this._observeData.subDraftId}get subDraftSegments(){return this._observeData.subDraftSegments}get subDraft(){return this._observeData.subDraft}get draftId(){return this._observeData.draftId}get mutableVideos(){return this._observeData.mutableVideos}get mutableAudios(){return this._observeData.mutableAudios}get mutableTexts(){return this._observeData.mutableTexts}get segmentMutable(){return this._observeData.segmentMutable}get segment(){return this._observeData.segment}get isSelectedFromCanvas(){return this._observeData.selectActionSource===o.k.Canvas}get isTemplateFillAll(){let e=this.observeData.mutableVideos.filter(e=>e.visible),t=e.length;return e.filter(e=>e.filled).length>=t}get selectionData(){return this._selection}get prepareSelectionData(){return this._prepareSelection}_getSelectedData(e){let t;let{segmentIds:i=[]}=e,{subDraftSegmentId:n}=e,r={...e},{subSegmentIdToAncestors:a,expandedSegmentId:o,batchReplacingSegmentId:l}=this.observeData,c=!!o;if(n){let e=this._dataSdk.draftView.getSegmentById(n);(0,s.Y2)(e&&(0,d.duj)(e)),t={subDraftId:e.materialDraft.draft.getDraftId(),segmentId:e.id,segment:e,expandMode:c}}else if(void 0===n){if(o)n=o;else if(l)n=l;else if(i.length>0){var u;n=null===(u=a[i[0]])||void 0===u?void 0:u[0]}if(n){let e=this._dataSdk.draftView.getSegmentById(n);(0,s.Y2)(e&&(0,d.duj)(e));let r=e.materialDraft.draft.getDraftId(),a=this._dataSdk.draftView.getDraftById(r);(0,s.Y2)(a);let o=new Set(i);a.getAllSegments().forEach(e=>{let{id:t}=e;o.has(t)&&o.delete(t)}),0===o.size&&(t={subDraftId:e.materialDraft.draft.getDraftId(),segmentId:e.id,segment:e,expandMode:c})}}return(t&&this.segmentMutable||(0,h.JY)(this._videoEnvironmentService))&&i&&i.length>1&&(r.segmentIds=[i[i.length-1]]),{...r,subDraftContext:t}}_fireSubDraftChangeIfNeeded(e){e.find(e=>{var t;if(e.type===d.C8.UPDATE&&(0,d.RFV)(e.item.segment)&&(null===(t=e.item.segment.materialDraft)||void 0===t?void 0:t.draft))return!0})&&this._onSubDraftSegmentChange.fire(this._observeData.subDraftSegment)}_listenDependenciesChange(){this._dataSdk.onChangeDiff(e=>{(e[d.u4I.SEGMENT].length>0||e[d.u4I.TRACK].length>0)&&(0,c.z)(()=>{this._observeData.tracks=this._dataSdk.draftView.getAllTracks(),this._fireSubDraftChangeIfNeeded(e[d.u4I.SEGMENT])}),e[d.u4I.CONFIG].length>0&&(0,c.z)(()=>{this._observeData.draftId=this._dataSdk.draftView.getDraftId()});let t=new Set(this._selection.getSelectedSegmentsIds()),i=new Set(this._selection.getSelectedTransitionIds()),n=new Map,r=new Map;e[d.u4I.SEGMENT].forEach(e=>{var t,i,a,s,o,l,c;let u=e.type,h=null===(i=e.item)||void 0===i?void 0:null===(t=i.segment)||void 0===t?void 0:t.id;if(h&&!n.has(h)&&n.set(h,[]),u===d.C8.DELETE&&(null===(a=n.get(null!=h?h:""))||void 0===a||a.push(u),h&&this._segmentIdToTransitionId.delete(h)),u===d.C8.ADD&&(null===(s=n.get(null!=h?h:""))||void 0===s||s.pop(),h&&(null===(o=e.item)||void 0===o?void 0:o.segment)&&(0,d.hey)(null===(l=e.item)||void 0===l?void 0:l.segment)&&(null===(c=e.item)||void 0===c?void 0:c.segment.transition)&&this._segmentIdToTransitionId.set(h,e.item.segment.transition.id)),u===d.C8.UPDATE){if(e.item.id&&e.item.segment&&(0,d.RFV)(e.item.segment)&&null===e.item.segment.transition){let t=this._segmentIdToTransitionId.get(e.item.id);t&&(!r.has(t)&&r.set(t,[]),r.get(t).push(d.C8.UPDATE)),this._segmentIdToTransitionId.delete(e.item.id)}e.item.id&&e.item.segment&&(0,d.RFV)(e.item.segment)&&e.item.segment.transition&&e.item.segment.transition.id&&(!r.has(e.item.segment.transition.id)&&r.set(e.item.segment.transition.id,[]),r.get(e.item.segment.transition.id).pop(),this._segmentIdToTransitionId.set(e.item.id,e.item.segment.transition.id))}});let a=!1;n.forEach((e,i)=>{(null==e?void 0:e.length)&&(a=!0,t.delete(i))}),r.forEach((e,t)=>{(null==e?void 0:e.length)&&(a=!0,i.delete(t))}),a&&this.setSelectedData({segmentIds:Array.from(t),transitionIds:Array.from(i),placeholderIds:this._selection.placeholderIds,selectedSegmentChildIndex:this._selection.selectedSegmentChildIndex})}),this._register(this._dataSdk.onChangeDiff(e=>{let{actionOperateType:t}=e;if(t===d.aWQ.Redo||t===d.aWQ.Undo){var i,n;let t=e[d.u4I.SEGMENT],r=t.some(e=>e.type===d.C8.ADD),a=t.some(e=>e.type===d.C8.DELETE),s=[],o=[],l=e[d.u4I.SELECTION],c=new Set(l),u=new Set;if(void 0!==l)l.forEach(e=>{this._dataSdk.draftView.getSegmentById(e)&&(s.push(e),c.delete(e))}),o=Array.from(c),t.forEach(e=>{if(e.type===d.C8.DELETE){let{segment:t}=e.item;(0,d.duj)(t)&&u.add(t.id)}});else{let e=r||a;t.forEach(t=>{if(t.type===d.C8.ADD)s.push(t.item.segment.id);else if(t.type===d.C8.MOVE)!e&&s.push(t.item.id);else if(t.type===d.C8.UPDATE){let{item:n}=t;if(n.segmentType===d.Ocy.SegmentVideo){let t=n.segment;if(t.transition){var i;let e=this._dataSdk.draftView.getSegmentById(n.id);r=!0,(null===(i=e.transition)||void 0===i?void 0:i.id)&&o.push(e.transition.id)}else void 0!==t.transition&&(a=!0),!e&&s.push(n.id)}else!e&&s.push(n.id)}else if(t.type===d.C8.DELETE){let{segment:e}=t.item;(0,d.duj)(e)&&u.add(e.id)}})}this.expandedSegmentId&&(u.has(this.expandedSegmentId)?this.setExpandedSegmentId(null):s.length&&!(null===(i=this.subDraft)||void 0===i?void 0:i.getSegmentById(s[0]))&&this.setExpandedSegmentId(null)),this.batchReplacingSegmentId&&(u.has(this.batchReplacingSegmentId)?this.setBatchingReplaceSegmentId(null):s.length&&!(null===(n=this.subDraft)||void 0===n?void 0:n.getSegmentById(s[0]))&&this.setBatchingReplaceSegmentId(null));let h=this.getSelectedData();if(0===o.length&&1===s.length&&1===h.segmentIds.length&&s[0]===h.segmentIds[0]||!r&&h.segmentIds.length)return;let g=Array.from(new Set([...s,...r?[]:h.segmentIds]));this.setSelectedData({segmentIds:g,transitionIds:o})}})),this._register(this._dataSdk.cutSame.onMutableTextsChanged((e,t)=>{(0,c.z)(()=>{this._observeData.draftIdToMutableTexts=t})})),this._register(this._dataSdk.cutSame.onMutableVideosChanged((e,t)=>{(0,c.z)(()=>{this._observeData.draftIdToMutableVideos=t})})),this._register(this._dataSdk.cutSame.onMutableAudiosChanged((e,t)=>{(0,c.z)(()=>{this._observeData.draftIdToMutableAudios=t})})),this._register(this._dataSdk.cutSame.onRelationVideoGroupChanged((e,t)=>{(0,c.z)(()=>{this._observeData.draftIdToRelationVideoGroup=t})})),this._register(this._selection.onChange(e=>{let t=this._getNestedSelectedSegmentIds();(0,c.z)(()=>{this._observeData.nestedSelectedSegmentIds=t,this._observeData.selectActionSource=e.source})})),this._register(this._prepareSelection.onChange(e=>{let t=this._getNestedSelectedSegmentIds(this._prepareSelection);(0,c.z)(()=>{this._observeData.nestedSelectedSegmentIds=t,this._observeData.selectActionSource=e.source})}))}_initEvent(){let e=(0,c.U5)(()=>[this._observeData.subDraftSegment],e=>{let[t]=e;this._onSubDraftSegmentChange.fire(t)}),t=(0,c.U5)(()=>[this._observeData.nestedSelectedSegmentIds],e=>{let[t]=e;this._onNestedSelectedSegmentIdsChange.fire(t)}),i=(0,c.U5)(()=>[this._observeData.mutableVideos],e=>{let[t]=e;this._onMutableVideosChange.fire(t)}),n=(0,c.U5)(()=>[this._observeData.mutableAudios],e=>{let[t]=e;this._onMutableAudiosChange.fire(t)}),r=(0,c.U5)(()=>[this._observeData.mutableTexts],e=>{let[t]=e;this._onMutableTextsChange.fire(t)}),a=(0,c.U5)(()=>[this._observeData.relationVideoGroup],e=>{let[t]=e;this._onRelationVideoGroupChange.fire(t)}),s=(0,c.U5)(()=>[this._observeData.subDraftTemplateId],e=>{let[t]=e;this._onSubDraftTemplateIdChange.fire(t)}),o=(0,c.U5)(()=>[this._observeData.subDraftRatio],e=>{let[t]=e;this._onSubDraftRatioChange.fire(t)});this._register({dispose:()=>{e(),t(),i(),n(),r(),a(),s(),o()}})}_getSelectedSegmentIds(e){var t,i,n;let r=Object.fromEntries([...null!==(t=e.segmentIds)&&void 0!==t?t:[],...null!==(i=e.transitionIds)&&void 0!==i?i:[],...null!==(n=e.placeholderIds)&&void 0!==n?n:[]].map(e=>[e,null]));return this.expandedSegmentId||this.batchReplacingSegmentId,r}_getNestedSelectedSegmentIds(e){let t=null!=e?e:this._selection,i=Object.fromEntries([...t.segmentIds,...t.transitionIds,...t.placeholderIds].map(e=>[e,null]));if(this.expandedSegmentId||this.batchReplacingSegmentId)return i;let{subDraftContext:n}=t;return n?{[n.segmentId]:i}:i}setExpandedSegmentId(e){let t=1===this._selection.segmentIds.length?this._selection.segmentIds[0]:null;if(e){let i=this._dataSdk.draftView.getSegmentById(e);if(!i||!(0,d.duj)(i))return;(0,c.z)(()=>{this._observeData.expandedSegmentId=e}),!this.batchReplacingSegmentId&&this.setSelectedData({segmentIds:"string"!=typeof t||e===t?void 0:[t],subDraftSegmentId:e},void 0,void 0,!0),this._onExpandedSegmentIdChange.fire(e);return}let i=this.expandedSegmentId;if(!!i)(0,c.z)(()=>{this._observeData.expandedSegmentId=null}),!this.batchReplacingSegmentId&&(this._dataSdk.draftView.getSegmentById(i)?this.setSelectedData({segmentIds:t?[t]:[i],subDraftSegmentId:t?i:null},void 0,void 0,!0):this.setSelectedData({segmentIds:[],subDraftSegmentId:null},void 0,void 0,!0)),this._onExpandedSegmentIdChange.fire(null)}setBatchingReplaceSegmentId(e){let t=1===this._selection.segmentIds.length?this._selection.segmentIds[0]:null;if(e){let i=this._dataSdk.draftView.getSegmentById(e);if(!i||!(0,d.duj)(i))return;(0,c.z)(()=>{this._observeData.batchReplacingSegmentId=e}),!this.expandedSegmentId&&this.setSelectedData({segmentIds:"string"!=typeof t||e===t?void 0:[t],subDraftSegmentId:e},void 0,void 0,!0),this._onBatchReplacingSegmentIdChange.fire(e);return}let i=this.batchReplacingSegmentId;if(!!i)(0,c.z)(()=>{this._observeData.batchReplacingSegmentId=null}),!this.expandedSegmentId&&(this._dataSdk.draftView.getSegmentById(i)?this.setSelectedData({segmentIds:t?[t]:[i],subDraftSegmentId:t?i:null},void 0,void 0,!0):this.setSelectedData({segmentIds:[],subDraftSegmentId:null},void 0,void 0,!0)),this._onBatchReplacingSegmentIdChange.fire(null)}getSelectedData(){return this._selection.getSelectedData()}setSelectedData(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.k.Unknown,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.U.Default,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=this._getSelectedData(e),{subDraftContext:a}=r;!a&&(this.expandedSegmentId&&this.setExpandedSegmentId(null),this.batchReplacingSegmentId&&this.setBatchingReplaceSegmentId(null)),this._selection.setSelectedData({...r},t,i,n),this._prepareSelection.setSelectedData({...r},t,i,n)}setPrepareSelectedData(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.k.Unknown,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.U.Default,n=this._getSelectedData(e);this._prepareSelection.setSelectedData({...n},t,i)}setPreviewSelectedData(e){let t=this._getSelectedData(e),i=this._getSelectedSegmentIds(t);this._observeData.previewSelectedSegmentIds=i}getPrepareSelectedData(){return this._prepareSelection.getSelectedData()}constructor(e,t,i,n){super(),this._selection=e,this._prepareSelection=t,this._dataSdk=i,this._videoEnvironmentService=n,this._onExpandedSegmentIdChange=new r.Q,this._onBatchReplacingSegmentIdChange=new r.Q,this._onNestedSelectedSegmentIdsChange=new r.Q,this._onSubDraftSegmentChange=new r.Q,this._onMutableVideosChange=new r.Q,this._onMutableAudiosChange=new r.Q,this._onMutableTextsChange=new r.Q,this._onRelationVideoGroupChange=new r.Q,this._onSubDraftTemplateIdChange=new r.Q,this._onSubDraftRatioChange=new r.Q,this._segmentIdToTransitionId=new Map,this._observeData=(0,c.LO)({expandedSegmentId:null,batchReplacingSegmentId:null,nestedSelectedSegmentIds:{},previewSelectedSegmentIds:{},draftIdToRelationVideoGroup:{},draftIdToMutableVideos:{},draftIdToMutableAudios:{},draftIdToMutableTexts:{},draftId:null,tracks:[],selectActionSource:o.k.Unknown,get subDraftSegment(){let e=new Set([...this.topLevelSelectedSegmentIds,..."string"==typeof this.expandedSegmentId?[this.expandedSegmentId]:[],..."string"==typeof this.batchReplacingSegmentId?[this.batchReplacingSegmentId]:[]]),t=this.subDraftSegments.filter(t=>e.has(t.id));return 1===t.length?t[0]:null},get subDraftSegmentId(){var a,s;return null!==(s=null===(a=this.subDraftSegment)||void 0===a?void 0:a.id)&&void 0!==s?s:null},get mutableVideos(){var l,d,h;let e=null!==(d=null!==(l=this.subDraftId)&&void 0!==l?l:this.draftId)&&void 0!==d?d:"";return null!==(h=this.draftIdToMutableVideos[e])&&void 0!==h?h:[]},get mutableTexts(){var g,m,f;let e=null!==(m=null!==(g=this.subDraftId)&&void 0!==g?g:this.draftId)&&void 0!==m?m:"";return null!==(f=this.draftIdToMutableTexts[e])&&void 0!==f?f:[]},get mutableAudios(){var p,v,_;let e=null!==(v=null!==(p=this.subDraftId)&&void 0!==p?p:this.draftId)&&void 0!==v?v:"";return null!==(_=this.draftIdToMutableAudios[e])&&void 0!==_?_:[]},get relationVideoGroup(){var S,y,x;let e=null!==(y=null!==(S=this.subDraftId)&&void 0!==S?S:this.draftId)&&void 0!==y?y:"";return null!==(x=this.draftIdToRelationVideoGroup[e])&&void 0!==x?x:new Map},get segment(){var b,M,T;return null!==(T=(0,u.kt)(this.tracks,this.segmentId))&&void 0!==T?T:(0,u.kt)(null!==(M=null===(b=this.subDraft)||void 0===b?void 0:b.getAllTracks())&&void 0!==M?M:[],this.segmentId)},get segmentMutable(){if(this.segmentId&&!this.segment)return function(e,t,i){for(let t of e)if(t.segmentId===i)return t;let n=[];for(let e of t)e.segmentId===i&&n.push(e);return n.length>1?n:1===n.length?n[0]:null}(this.mutableVideos,this.mutableTexts,this.segmentId);return(0,u.Mf)(this.mutableVideos,this.mutableTexts,this.segment)},get selectedSegmentIds(){let{nestedSelectedSegmentIds:e}=this,t=Object.keys(e);for(;1===t.length;){let i=t[0];if(null===e[i])break;t=Object.keys(e=e[i])}return t},get segmentId(){return 1===this.selectedSegmentIds.length?this.selectedSegmentIds[0]:null},get topLevelSelectedSegmentIds(){return Object.keys(this.nestedSelectedSegmentIds)},get subDraftTemplateId(){var I;return null===(I=this.subDraftSegment)||void 0===I?void 0:I.templateId},get subDraftId(){var k,D,C;return null!==(C=null===(D=this.subDraftSegment)||void 0===D?void 0:null===(k=D.materialDraft)||void 0===k?void 0:k.draft.getDraftId())&&void 0!==C?C:null},get subDraft(){var w;return null!==(w=i.draftView.getDraftById(this.subDraftId))&&void 0!==w?w:null},get subDraftSegments(){return(0,u.q6)(this.tracks)},get subSegmentIdToAncestors(){let e={};for(let t of this.subDraftSegments)for(let i of t.materialDraft.draft.tracks)for(let n of i.segments)e[n.id]=[t.id];return e},get subDraftRatio(){var E;return null===(E=(0,u.q6)(this.tracks).find(e=>e.id===this.subDraftSegmentId))||void 0===E?void 0:E.materialDraft.draft.getCanvasConfig().ratio}}),this._initEvent(),this._listenDependenciesChange()}}g=(0,n.gn)([(0,n.fM)(3,h.rO),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===l.Y?Object:l.Y,void 0===l.d?Object:l.d,"undefined"==typeof IDataSdk?Object:IDataSdk,void 0===h.rO?Object:h.rO])],g)},52442:function(e,t,i){i.d(t,{C$:function(){return s},M:function(){return o},m7:function(){return a}});var n=i(999943),r=i(539896);let a="mutableElementStore",s="mutableStatusStore";function o(e,t){let i=new n.A(e,t);return{[a]:i,[s]:new r.r}}},40142:function(e,t,i){i.d(t,{D:function(){return r}});var n,r=((n={}).thirdPartDraftId="thirdPartDraftId",n.thirdPartPlatform="thirdPartPlatform",n)},705325:function(e,t,i){i.d(t,{X:function(){return f}});var n=i(789786),r=i(486441),a=i(251266),s=i(377680),o=i(278433),l=i(966697),d=i(200247),c=i(690613),u=i(425427),h=i(797913),g=i(652148),m=i(564831);class f{_init(){this._initListenLogin()}_initListenLogin(){this._accountService.hasLogin?this.openThirdPartyLoginPolicyModal():this._accountService.onDidLogin(()=>{this.openThirdPartyLoginPolicyModal()})}get hasUseGptTextToVideo(){return this._hasUseGptToText||this._accountService.userProfile.useGPTText2Video}get hasExportGptTextToVideo(){return this._hasExportGptTextToVideo||this._accountService.userProfile.exportGPTText2Video}get store(){return this._store}openThirdPartyLoginPolicyModal(){this._accountService.hasLogin&&this._videoEnvironmentService.isFromThirdPartPlatform&&!this.hasUseGptTextToVideo&&(this._thirdPartModalController.showLoginPolicyModal(),this._userPrivacyPolicyDataService.updateUserPrivacyPolicy({useGPTText2Video:!0}).then(()=>{this._hasUseGptToText=!0}))}openThirdPartyExportPolicyModal(e){this._accountService.hasLogin&&this._videoEnvironmentService.isFromThirdPartPlatform&&!this.hasExportGptTextToVideo?(this._thirdPartModalController.showExportPolicyModal(e),this._userPrivacyPolicyDataService.updateUserPrivacyPolicy({exportGetText2Video:!0}).then(()=>{this._hasExportGptTextToVideo=!0})):null==e||e()}async synchronizeUserInfo(){let e=await this._userInfoDataService.getUserInfo({});if(e.ok){var t,i,n,r,a,s,o,l;this._hasExportGptTextToVideo=null!==(o=null==e?void 0:null===(n=e.value)||void 0===n?void 0:null===(i=n.data)||void 0===i?void 0:null===(t=i.user_info)||void 0===t?void 0:t.export_gpt_text2video)&&void 0!==o&&o,this._hasUseGptToText=null!==(l=null==e?void 0:null===(s=e.value)||void 0===s?void 0:null===(a=s.data)||void 0===a?void 0:null===(r=a.user_info)||void 0===r?void 0:r.use_gpt_text2video)&&void 0!==l&&l}else throw Error(e.msg)}async initializeThirdPartyUserInfo(){if(!!this._videoEnvironmentService.thirdPartyDraftId)await this.synchronizeUserInfo()}askUserLogin(){!this._accountService.hasLogin&&!this._didAskUserLogin&&(this._didAskUserLogin=!0,this._accountService.login({reportParams:{pageEnterFrom:l.d.EditorLoginPopup}}))}setPendingResources(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.store.setTotalResourceCount(e.length),this.store.setFinishedResourceCount(0),e.forEach(e=>{e.finally(()=>{this.store.setFinishedResourceCount(this.store.finishedResourceCount+1)})})}async getThirdPartyPackageInfo(e){try{let t=new g.S(this._textToVideoDataService,this._videoConfigurationService),i=await t.fetchPackageInfo({thirdPartyDraftId:e,onProgress:e=>{this._store.setFetchProgress(e)}});return setTimeout(()=>{this.askUserLogin(),this._store.setFetchStatus(a.Xp.success)},500),(0,c.oW)(i)}catch(e){throw this._store.setFetchStatus(a.Xp.fail),this._store.setFetchProgress(0),e}}constructor(e,t,i,n,a,s){this._userInfoDataService=e,this._userPrivacyPolicyDataService=t,this._textToVideoDataService=i,this._videoEnvironmentService=n,this._accountService=a,this._videoConfigurationService=s,this._hasUseGptToText=!0,this._hasExportGptTextToVideo=!1,this._didAskUserLogin=!1,this._store=new r.B,this._thirdPartModalController=new m.I,this._init()}}f=(0,n.gn)([(0,n.fM)(0,s.I),(0,n.fM)(1,o.u),(0,n.fM)(2,a.gt),(0,n.fM)(3,u.rO),(0,n.fM)(4,d.D),(0,n.fM)(5,h.J),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===s.I?Object:s.I,void 0===o.u?Object:o.u,void 0===a.gt?Object:a.gt,void 0===u.rO?Object:u.rO,void 0===l.Gw?Object:l.Gw,void 0===h.J?Object:h.J])],f)},354267:function(e,t,i){i.d(t,{Jy:function(){return a},VF:function(){return l},_9:function(){return r},dw:function(){return o},k:function(){return s},pl:function(){return n}});let n={MAIN_TRACK:50,VIDEO_TRACE:36,OTHERS_TRACE:28},r=7,a="mutable-lock",s="empty-mutable-audio",o="placeholder-segment",l="audio-record"},469859:function(e,t,i){i.d(t,{O:function(){return a},y:function(){return s}});var n=i(789786),r=i(260963);let a="contextMenuContribution";class s{registerController(e,t){this.nameToController[e]=t}unregisterController(e){delete this.nameToController[e]}constructor(){this.nameToController={},(0,r.ky)(this)}}(0,n.gn)([r.aD,(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[String,"undefined"==typeof ITimelineContextMenuController?Object:ITimelineContextMenuController]),(0,n.w6)("design:returntype",void 0)],s.prototype,"registerController",null),(0,n.gn)([r.aD,(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[String]),(0,n.w6)("design:returntype",void 0)],s.prototype,"unregisterController",null)},452210:function(e,t,i){i.d(t,{G:function(){return l},Y:function(){return o}});var n,r=i(560941),a=i(469859),s=i(156145);var o=((n={}).TIMELINE_TOOL="timelineTool",n.TIMELINE_CONTEXTMENU="timelineContextmenu",n.TIMELINE_CONTENT="timelineContent",n);class l{get[r._](){return this._timelineToolContribution}get[a.O](){return this._timelineContextMenuContribution}get[s.OP](){return this._timelineContentContribution}setForceRender(e,t){t?this._nameToForceRender.set(e,t):this._nameToForceRender.delete(e)}forceRender(e){let t=this._nameToForceRender.get(e);t&&t()}constructor(e){this._isTemplate=e,this._timelineContextMenuContribution=new a.y,this._timelineContentContribution=new s.d8,this._nameToForceRender=new Map,this._timelineToolContribution=new r.Z(e)}}},156145:function(e,t,i){i.d(t,{OP:function(){return s},d8:function(){return o},te:function(){return a}});var n,r=i(260963);var a=((n={}).TRAIN_HEADER="trainHeader",n);let s="timelineContentContribution";class o{get trainHeaderController(){let e=null;return Object.keys(this.nameToController).forEach(t=>{let{config:i,controller:n}=this.nameToController[t];"trainHeader"===i.position&&(e=n)}),e}registerController(e,t){let{name:i}=e;this.nameToController[i]={controller:t,config:e}}unregisterController(e){delete this.nameToController[e]}constructor(){this.nameToController={},(0,r.ky)(this)}}},376117:function(e,t,i){i.d(t,{u:function(){return o}});var n=i(112825),r=i(690674),a=i(426336),s=i(129883);class o{updateTimelineDuration(e){this._store[r.U_].setTimelineDuration(e)}updateSegmentStyle(e){this._coordinate.context.event.emit(n.B.updateStyle,e)}updatePartialSegmentData(e){this._coordinate.context.event.emit(n.B.updatePartialSegmentData,e)}updateSegmentData(e){this._coordinate.context.event.emit(n.B.updateData,e)}addAudioSegmentPlaceholder(e,t){let i=1000n*t.duration,n=1000n*t.start,o={path:e.path,commonKeyframes:[],duration:i,id:`audio-record-${Date.now()}`,keyframesMap:new Map,metaType:a.cVg.MetaTypeMusic,originalTargetDuration:i,originalTargetStart:n,slots:[],start:n,title:e.name,type:"audio",prolong:{duration:i,start:0n,total:i},sourceTimeRange:{start:n,duration:i}};return this._store[r.jU].setWaves(e.path,(0,s.V)(1000n*BigInt(3e3)).map(e=>({timestamp:0n,strength:e}))),this._transientDataManager.addSegment(o,{...t,start:n,duration:i}),o.id}removeAudioSegmentPlaceholder(e){this._transientDataManager.removeSegment(e)}get active(){return this._store[r.U_].audioTimelinePanelVisible}constructor(e,t,i,n){this._store=e,this._coordinate=t,this._timelineEvent=i,this._transientDataManager=n}}},77042:function(e,t,i){i.d(t,{P:function(){return O},q:function(){return L}});var n,r=i(789786),a=i(690674),s=i(426020),o=i(315201),l=i(230689),d=i(433140),c=i(127830),u=i(629750),h=i(426336),g=i(460254),m=i(319525),f=i(825686),p=i(771255),v=i(189577),_=i(732564),S=i(254336),y=i(948328),x=i(829144),b=i(612183),M=i(574132),T=i(695324),I=i(49200),k=i(533743),D=i(394267),C=i(260963),w=i(609962),E=i(9645),A=i(425427),R=i(544009),P=i(513053);var L=((n={}).none="none",n.replace="replace",n.resorting="resorting",n);let N={[s.YB.Video]:g.r.UserVideo,[s.YB.Image]:g.r.UserPhoto},B=e=>e.length>0&&(e.every(e=>e.filled)||e.every(e=>!e.filled));class O{get active(){return this._timelineStore.isBatchReplacePanelVisible}get disabledSegIds(){return this._observableData.disabledSegIds}get hoverSegmentInfo(){return this._observableData.hoverSegInfo||{segmentId:"",targetIndex:-1,sourceIndex:-1}}get movedSegmentId(){return this._observableData.movedSegmentId}get isResorting(){return!!this._observableData.movedSegmentId}get batchReplaceCount(){return this._observableData.batchReplaceCount}get resortValidInfo(){return this._observableData.resortValidInfo}get batchReplaceStatus(){let{uploading:e,uploaded:t,replacedMaterial:i,failed:n,canceled:r,skipped:a}=this._observableData.batchReplaceCount;switch(!0){case r>0:return p.g.CANCELED;case e+t+i+n===0:return p.g.IDLE;case i+n+a<t+e:return p.g.UPLOADING;case i+n+a>=e+t:return p.g.SUCCESS;default:return p.g.IDLE}}get isElementPanelMode(){return!!(this._segmentSelection.subDraftSegment&&!this._segmentSelection.expandedSegmentId&&!this._getIsTemplate())}setBatchReplaceCount(e){this._observableData.batchReplaceCount={...this._observableData.batchReplaceCount,...e}}get confirmBatchReplaceHelper(){return this._confirmBatchReplaceHelper}setRenderManager(e){this._renderManager=e}async batchUploadFiles(e){this._replaceMutableList=this._getAllUnfilledAndVisibleMutable(),this._usedMutableList=[];let{batch:t}=this._dataSdk.api,i=t.batchStart();this._startBatchReplacing(e.length),t.batchEnd(i);let{isBatchReplacePanelVisible:n}=this._timelineStore,r=await this._fileUploadManager.localFilesUpload(e,{uploadReportParams:{action_type:S.jm.CLICK_ADD,material_source:S.O9.LOCAL,position:n?S.cg.SLOTS:S.cg.TRACK}});r.forEach(e=>{e.then(e=>{let t=e.model;this._asyncReplacingTask.push(this._uploadFileToMutable(t,{tasksTotal:r.length,from:this._store[a.U_].isBatchReplacePanelVisible||this.isElementPanelMode?"slots":"track"}))}).catch(()=>{let{batchReplaceCount:e}=this._observableData;this.setBatchReplaceCount({uploading:e.uploading-1,failed:e.uploaded+1})})})}startConfirmBatchReplaceLocalTasks(e,t){let i=t.some(e=>e.type.includes(s.YB.Image)||e.type.includes(s.YB.Video));if(!!this._isTemplateEnvironment&&!!i&&!!this._getAllUnfilledAndVisibleMutable().length)this._confirmBatchReplaceHelper.showModal().then(i=>{i.ok&&this._batchReplaceWithUploadingTasks(e,t)})}_batchReplaceWithUploadingTasks(e,t){let i=[],n=[];for(let r=0;r<t.length;r++)this._fileAccept.includes(t[r].type)&&(i.push(e[r]),n.push(t[r]));if(this._replaceMutableList=this._getAllUnfilledAndVisibleMutable(),0!==i.length&&0!==this._replaceMutableList.length)this._usedMutableList=[],this._startBatchReplacing(n.length),(0,x.gx)({resourceService:this._resourceService,tasks:i,fileList:n}).forEach(e=>{e.then(e=>{let t=e.model;this._asyncReplacingTask.push(this._uploadFileToMutable(t,{tasksTotal:i.length,from:"material",fromFolder:e.fromFolderId!==s.ZF}))}).catch(()=>{this.setBatchReplaceCount({failed:this.batchReplaceCount.failed+1})})})}resortStart(e){this._observableData.movedSegmentId=e}resortHover(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;if(this._observableData.hoverSegInfo=i?{segmentId:i,targetIndex:n,sourceIndex:t}:void 0,this._resortTargetSegmentId!==i)this._handleHover(e,t,i,n)}resortEnd(){this._clearPreview(),clearTimeout(this._hoverDebounceTimer),this._resortTargetSegmentId=void 0,(0,C.z)(()=>{this._observableData.disabledSegIds=new Set,this._observableData.hoverSegInfo=void 0,this._observableData.resortValidInfo=[],this._observableData.movedSegmentId=""})}async resortMutable(e,t){var i;let{index:n}=e,{index:r}=t,{subDraftId:s}=null!==(i=this._store[a.qk])&&void 0!==i?i:{},o=this._getMovedSegments(n,r);if(!this._validCanResort(o))return P.D.LimitFail(this.isElementPanelMode),Promise.resolve({res:-1});let l=await this._genUpdatePrams(o);if(o.filter(e=>{var t;return null===(t=e.sourceTimelineSegment.mutable)||void 0===t?void 0:t.filled}).forEach(e=>{this._smartToolsManager.cacheOriginSegment(e.targetMutableId,null!=s?s:void 0)}),!this._dataSdk.api.template.setMutableVideos({videos:l,draftId:null!=s?s:void 0}).ok)return P.D.LimitFail(this.isElementPanelMode),Promise.resolve({res:-1});for(let{targetSegment:e,targetMutableId:t}of o)this._subjectCropManager.subjectCropMutableVideoAsync({segmentId:e.id,mutableId:t});let d=o.filter(e=>{var t;return null===(t=e.sourceTimelineSegment.mutable)||void 0===t?void 0:t.filled}).map(e=>{var t,i;return{mutableId:e.targetMutableId,type:null===(t=e.sourceResource)||void 0===t?void 0:t.type,value:null===(i=e.sourceResource)||void 0===i?void 0:i.data}});return(0,k.R)(this._dataSdk,this._smartToolsManager,d,this._getDraftId()),this._draftTemplateManager.updateDraftChangedSummary(this._getDraftId(),{is_move_material:!0}),Promise.resolve({res:0,isMoveSameDots:this._validSameSlotReplace(o)})}clearResortHover(e){let{hover:t,disabled:i}=e;t&&(this._observableData.hoverSegInfo=void 0),i&&this._observableData.disabledSegIds.size&&(this._observableData.disabledSegIds=new Set),this._resortTargetSegmentId=void 0}startConfirmBatchReplaceThirdPartyFiles(e){if(!!this._isTemplateEnvironment&&!!this._getAllUnfilledAndVisibleMutable().length)this._confirmBatchReplaceHelper.addUploadingMaterials(e.map(e=>({from:"third_party",materialLifecycle:e}))),this._confirmBatchReplaceHelper.showModal().then(e=>{e.ok&&this._startThirdPartyBatchReplace(this._confirmBatchReplaceHelper.uploadingMaterialsLifecycles),void 0!==e.ok&&this._confirmBatchReplaceHelper.removeMaterialTasks()})}_startThirdPartyBatchReplace(e){let t=[];for(let i of e)this._fileAccept.includes(i.materialLifecycle.getModel().fileType)&&t.push(i);if(this._replaceMutableList=this._getAllUnfilledAndVisibleMutable(),0===t.length||0===this._replaceMutableList.length)return;let{batch:i}=this._dataSdk.api,n=i.batchStart(!0);this._usedMutableList=[],this._startBatchReplacing(t.length);let r=0;for(let e of t)e.materialLifecycle.onDidUpload(()=>{this._asyncReplacingTask.push(this._uploadFileToMutable(e.materialLifecycle.getModel(),{tasksTotal:t.length,from:"material"},!0)),++r===t.length&&i.batchEnd(n,{canUndoRedo:!0})})}selectNextAvailableSegment(){let e=this._replaceMutableList.filter(e=>!this._usedMutableList.includes(e.id))[0];if(!!e)this._timelineSelection.updateSelectData({segmentIds:[e.segmentId]})}checkIfCanResort(e,t){if(e===t)return[];let i=this._getMovedSegments(e,t),{flattedSegments:n}=this._store[a.U_],r="";return t>=0&&t<n.length&&(r=n[t].id),this._validCanResort(i),this.resortValidInfo.length?this._observableData.disabledSegIds=new Set([r]):this._observableData.disabledSegIds=new Set,this._observableData.resortValidInfo}_getMovedSegments(e,t){var i,n,r,s,o,l;let{flattedSegments:d}=this._store[a.U_],c=[],{draftView:u}=this._dataSdk,h=d[e],g=null===(i=u.getSegmentById(h.id))||void 0===i?void 0:i.clone(),m=d[t],f=null===(n=u.getSegmentById(m.id))||void 0===n?void 0:n.clone(),{mutableId:p=""}=h.mutable,{mutableId:v=""}=m.mutable,_=this._getResourceBySegment(g);if(e<t){for(let i=e;i<t;i++){let e=d[i+1],t=d[i],n=null===(r=u.getSegmentById(t.id))||void 0===r?void 0:r.clone(),{mutableId:a=""}=e.mutable,{mutableId:o=""}=t.mutable,l=null===(s=u.getSegmentById(e.id))||void 0===s?void 0:s.clone(),h=this._getResourceBySegment(l);c.push({sourceSegment:l,sourceResource:h,sourceTimelineSegment:e,targetSegment:n,targetMutableId:o,sourceMutableId:a,targetTimelineSegment:t})}c.push({sourceTimelineSegment:h,sourceSegment:g,sourceMutableId:p,targetMutableId:v,targetSegment:f,sourceResource:_,targetTimelineSegment:m})}else{for(let i=e;i>t;i--){let e=d[i-1],t=null===(o=u.getSegmentById(e.id))||void 0===o?void 0:o.clone(),n=d[i],r=null===(l=u.getSegmentById(n.id))||void 0===l?void 0:l.clone(),{mutableId:a=""}=e.mutable,{mutableId:s=""}=n.mutable,h=this._getResourceBySegment(t);c.unshift({sourceResource:h,sourceSegment:t,sourceTimelineSegment:e,sourceMutableId:a,targetMutableId:s,targetSegment:r,targetTimelineSegment:n})}c.unshift({sourceTimelineSegment:h,sourceSegment:g,sourceMutableId:p,targetMutableId:v,targetSegment:f,sourceResource:_,targetTimelineSegment:m}),c.reverse()}return c}async _genUpdatePrams(e){var t;let i=[],{subDraftId:n}=null!==(t=this._store[a.qk])&&void 0!==t?t:{},r=this._dataSdk.cutSame.getMutableVideos(null!=n?n:void 0);for(let t of e){let e=r.find(e=>{let{id:i}=e;return i===t.sourceMutableId}),n=r.find(e=>{let{segmentId:i}=e;return i===t.targetSegment.id});if(e&&n){let r=await this._getMutableParams(n,t.sourceSegment,e.filled);i=i.concat(r)}}return i}_clearPreview(){var e,t,i;let{id:n}=null!==(t=this._store[a.qk].subDraftSegment)&&void 0!==t?t:{};Promise.all(null!==(i=null===(e=this._previewMovedSegments)||void 0===e?void 0:e.map(e=>this._renderManager.clearVideoSubstitute(e.targetSegment.id,{subDraftSegmentId:n})))&&void 0!==i?i:[]).then(()=>{this._previewMovedSegments=[],this._renderManager.refreshCurrentFrame(0,!0)})}async seekToPreview(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t&&this._clearPreview(),await this.seekToSegment(e)}async seekToSegment(e){let t=await (0,R.HA)(e,this._store[a.qk].subDraftSegment,this._renderManager,this._dataSdk,this._selection);null!==t&&this._playerManager.timelineSeek(t,!1)}_handleHover(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;this._hoverDebounceTimer&&clearTimeout(this._hoverDebounceTimer),this._hoverDebounceTimer=window.setTimeout(()=>{var r;if(this._resortTargetSegmentId!==i&&(null===(r=this._previewMovedSegments)||void 0===r?void 0:r.length)&&this._clearPreview(),this._resortTargetSegmentId=i,!i)return;if(i===e){this.seekToPreview(i,!0);return}let a=this._getMovedSegments(t,n);this._validCanResort(a)&&(this.seekToPreview(i),this._hoverPreview(a))},200)}_validCanResort(e){let t=[],i=[];return e.filter(e=>{var t;return null===(t=e.sourceTimelineSegment.mutable)||void 0===t?void 0:t.filled}).forEach(e=>{var n,r;let s=this._timelineStore.mutableVideos.find(t=>{let{id:i}=t;return e.targetMutableId===i});if(!s)return;let{status:o}=null!==(n=this._store.timelineMutableStatusStore.mutableIdToStatusInfo[s.id])&&void 0!==n?n:{},{status:l}=null!==(r=this._store.timelineMutableStatusStore.mutableIdToStatusInfo[e.sourceMutableId])&&void 0!==r?r:{};if([o,l].includes(w.a.FAILED)||[e.targetSegment.id,e.sourceSegment.id].some(e=>this._store[a.U_].intelligentStore.errorSegIds.includes(e)))t.push({type:"",value:0,errmsg:"status is failed",errType:"fail_limit"});else if([o,l].some(e=>[w.a.REPLACING,w.a.UPLOADING].includes(e))||[e.targetSegment.id,e.sourceSegment.id].some(e=>this._store[a.U_].intelligentStore.processingSegIds.includes(e))||[e.targetSegment.id,e.sourceSegment.id].some(e=>this._subjectCropManager.store.processingSegIds.includes(e)))t.push({type:"",value:0,errmsg:"status is loading",errType:"loading_limit"});else if(s&&e.sourceResource){let n=this._autoReplace.checkReplace(s,e.sourceResource);n.errmsg&&(i.push(s.segmentId),t.push(n))}}),this._observableData.resortValidInfo=t,0===t.length}_hoverPreview(e){var t,i;let{id:n}=null!==(t=this._store[a.qk].subDraftSegment)&&void 0!==t?t:{};Promise.all(null!==(i=e.map(async e=>{var t;let{sourceSegment:i,targetSegment:r,targetTimelineSegment:a,sourceTimelineSegment:s}=e,{material:o}=i,{sourcePlatform:l,type:d,path:u}=o,g=this._draftPathStore.getResourceKeyFromDraftPath(u),m=d===h.cVg.MetaTypePhoto?u:this._coverPathCache.get(u);if(null===(t=s.mutable)||void 0===t?void 0:t.filled){if(d===h.cVg.MetaTypeVideo&&g&&!this._coverPathCache.has(u)){let e=l===h.cvu.MaterialPlatformDefault?this._resourceService.get(g,c._g.UserVideo):this._resourceService.get(g,c._g.Video);if(e){this._ensureManager.enableCompleteWrite(this._renderManager);let t=this._ensureManager.ensureCoverUrl(e),i=await t.waitForResourceValueReady();m=i.ok?i.value:""}m&&this._coverPathCache.set(u,m)}}else m=a.mutable.coverPath;return this._renderManager.setVideoSubstitute(r.id,m,{subDraftSegmentId:n})}))&&void 0!==i?i:[]).then(()=>{this._previewMovedSegments=e,this._renderManager.refreshCurrentFrame(0,!0)})}_validSameSlotReplace(e){let{draftView:t}=this._dataSdk,i=this._dataSdk.cutSame.draftIdToRelationVideoGroup,n=this._getDraftId(),r=i[n],a=[];for(let[,e]of r)a.push(e);let s=e.some(e=>{let{targetMutableId:i,sourceSegment:r}=e,s=a.find(e=>e.has(i));if(!s)return!1;let o=[];for(let e of s){let n=this._getUISegmentByMutableId(e);if(i!==e&&n){let e=t.getSegmentById(n.id);e&&o.push(e)}}return o.some(e=>{var t,i;let a=this._dataSdk.cutSame.getMutableById(e.materialId,n);return!h.hPV.isPathEqual(null===(t=e.material)||void 0===t?void 0:t.path,null===(i=r.material)||void 0===i?void 0:i.path)&&(null==a?void 0:a.filled)})});return!this._sameSlotReplaceHasToast&&(s&&this._timelineStore.switches.autoReplace&&P.D.RelatedVideoReplace(()=>{this._dataSdk.api.undoRedo.undo(),this._renderManager.pause()},this.isElementPanelMode),this._sameSlotReplaceHasToast=s&&this._timelineStore.switches.autoReplace),s&&this._timelineStore.switches.autoReplace}get _timelineStore(){return this._store[a.U_]}_reportAddMaterialToTrack(e){var t;let{model:i,status:n,addFrom:r,batchCnt:a,waitTime:o,isTemplateSubjectCrop:l,fromFolder:d}=e,c={actionType:"click",addFrom:r,batchCnt:a,optionType:"add",status:n,materialName:i.filename,storage:i.size,materialId:i.id,fileType:i.subType,isFastImport:null==i?void 0:null===(t=i.uploading)||void 0===t?void 0:t.isSupportFastImport,waitTime:o,isTemplateSubjectCrop:l,fromFolder:d};i.fileType===s.YB.Video||i.fileType===s.YB.Image?(0,M.QU)(this._containerService,{resolution:i.height&&i.width?`${i.height} * ${i.width}`:void 0,...c}):(0,M.QU)(this._containerService,{...c})}_getResourceBySegment(e){if(!e||!(0,h.hey)(e))return;let t=this._smartToolsManager.pipelineManager.intelligenceStore.idToIntermediateMaterial[e.id],{type:i,path:n,sourcePlatform:r}=null!=t?t:e.material,a=this._draftPathStore.getResourceKeyFromDraftPath(n),s=r===h.cvu.MaterialPlatformDefault;if(!a)return;let l={};if(i===h.cVg.MetaTypeVideo){l.type=s?c._g.UserVideo:c._g.Video;let e=s?this._resourceService.get(a,c._g.UserVideo):this._resourceService.get(a,c._g.Video);e&&(0,o.R)(e.value)&&(l.data=e.value)}else if(i===h.cVg.MetaTypePhoto||i===h.cVg.MetaTypeGif){l.type=s?c._g.UserPhoto:c._g.Photo;let e=s?this._resourceService.get(a,c._g.UserPhoto):this._resourceService.get(a,c._g.Photo);e&&(0,o.R)(e.value)&&(l.data=e.value)}return s&&!l.data&&this._draftMaterialsService.isMaterialExistByKey(a)&&(l.data=this._draftMaterialsService.getMaterialByKey(a)),l.type&&l.data?l:void 0}async _askIfNeedAutoReplace(e){let{sourceSegment:t,targetSegment:i,sourceMutableList:n,targetMutableList:r}=e,a=B(r),s=B(n),o=this._getResourceBySegment(t),l=this._getResourceBySegment(i),d=!o||r.some(e=>!this._autoReplace.check(e,o)),c=!l||n.some(e=>!this._autoReplace.check(e,l)),u={isTargetAllSync:a&&!d,isSourceAllSync:s&&!c};return d||c?u:(a?!s&&(u.isSourceAllSync=await this._autoReplace.ask(t.id),u.isTargetAllSync=u.isSourceAllSync):(u.isTargetAllSync=await this._autoReplace.ask(i.id),u.isSourceAllSync=u.isTargetAllSync),u)}async _uploadFileToMutable(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],{isBatchReplacing:n}=this._timelineStore;if(!!n){if(e.fileType===s.YB.Audio)this.setBatchReplaceCount({uploading:this.batchReplaceCount.uploading-1,uploaded:this.batchReplaceCount.uploaded+1,skipped:this.batchReplaceCount.skipped+1});else if([s.YB.Video,s.YB.Image].includes(e.fileType)){var r;let n=this._getMutableToReplace(e),s=Promise.resolve({results:{}});if(i&&n[0]&&(s=this._subjectCropManager.getSubjectCropResult(e,n,!0)),this.setBatchReplaceCount({uploading:this.batchReplaceCount.uploading-1,uploaded:this.batchReplaceCount.uploaded+1}),!n.length){this.setBatchReplaceCount({failed:this.batchReplaceCount.failed+1});return}let o=n.map(e=>e.id);this._store[a.jU].setMutableUploadMaterial(o,{status:p.g.REPLACING}),(0,T.b)(this._containerService,{relatedEvent:T.Z.AddMaterialToTrack,actionType:"click",optionType:"add"}),(0,I.O)(this._containerService,{actionType:"click",optionType:"add",isVip:!1,materialName:null!==(r=e.filename)&&void 0!==r?r:"",scene:"category",materialCategory:"media",category:"media"});let l=await this._batchUploadFileToMutable(n,e),d=(null==l?void 0:l.result.ok)?l.result.value.reduce((e,t)=>t.ok?{success:e.success+1,failed:e.failed}:{success:e.success,failed:e.failed+1},{success:0,failed:0}):{success:0,failed:1};if(l){let r={model:e,addFrom:t.from,batchCnt:t.tasksTotal,fromFolder:t.fromFolder,status:l.result.ok?"success":"fail",waitTime:l.performanceDuration};i&&n.length?Promise.allSettled([s]).then(t=>{let[i]=t;this._subjectCropManager.applySubjectCropSync(e,n,i),this._reportAddMaterialToTrack({...r,isTemplateSubjectCrop:this._subjectCropManager.getIfUseSmartCropWhenReplacing(e.key)})}):this._reportAddMaterialToTrack(r)}this._store[a.jU].setMutableUploadMaterial(o,{status:p.g.SUCCESS}),(null==l?void 0:l.result.ok)?this.setBatchReplaceCount({replacedMaterial:this.batchReplaceCount.replacedMaterial+1,filledMutable:this.batchReplaceCount.filledMutable+d.success}):this.setBatchReplaceCount({failed:this.batchReplaceCount.failed+d.failed})}}}async _getMutableParams(e,t,i){var n,r;if(!e)return[];!Array.isArray(e)&&(e=[e]);let a=i?null!==(n=this._smartToolsManager.intelligenceStore.idToIntermediateMaterial[t.id])&&void 0!==n?n:t.material:void 0,s=null!==(r=null==a?void 0:a.path)&&void 0!==r?r:"",o=this._getDraftId(),l=this._dataSdk.draftView.getDraftById(o);if(!l)return[];let d=(0,h.GUA)(l),c=this._getResourceBySegment(t);return(await Promise.all(e.map(async e=>{if(!i||!c||this._autoReplace.check(e,c)){var n,r,o,l,u,g,m;let c=(0,h.dlx)(null!==(o=null===(n=this._renderManager.resourceRecords.getRecordBySegmentPath(s))||void 0===n?void 0:n.resPath)&&void 0!==o?o:"",null!==(l=null===(r=this._renderManager.resourceRecords.getRecordBySegmentPath(d.get(e.id).coverPath))||void 0===r?void 0:r.resPath)&&void 0!==l?l:""),f=await this._renderManager.getMediaFileInfo(c,"");if(!f)return;let p=i?s:(0,h.ZK_)(this._renderManager.resourceRecords,"",e.coverPath);return{crop:e.crop,id:e.id,isMutable:!0,materialId:null!==(u=null==a?void 0:a.materialId)&&void 0!==u?u:"",materialName:null!==(g=null==a?void 0:a.materialName)&&void 0!==g?g:"",originalPath:p,path:p,mediaType:f.type,rotation:f.rotation,duration:f.duration,width:f.width,height:f.height,sourcePlatform:null!==(m=null==a?void 0:a.sourcePlatform)&&void 0!==m?m:h.cvu.MaterialPlatformDefault,sourceStart:t.sourceTimerange.start,volume:t.volume,initialSpeed:t.speed.speed}}}))).filter(Boolean)}_batchUploadFileToMutable(e,t){if(s.YB.Video!==t.fileType&&s.YB.Image!==t.fileType)return;let i=N[t.fileType];return this._draftOperation.mutable.setMutableVideos({dragData:{type:i,sourceFrom:"quick-upload",dragSource:t},mutableVideoList:e})}_getAllUnfilledAndVisibleMutable(){let e=this._getDraftId(),{draftIdToMutableVideos:t}=this._dataSdk.cutSame;return t[e].filter(e=>!e.filled&&e.visible)}_getMutableToReplace(e){var t;let i;let n=this._replaceMutableList.filter(e=>!this._usedMutableList.includes(e.id)),r={type:N[e.fileType],data:e},o="";if(e.fileType===s.YB.Image?i=n[0]:e.fileType===s.YB.Video&&(i=n.find(e=>{let t=this._autoReplace.checkReplace(e,r);return t.errmsg&&!o&&(o=t.errmsg),!t.errmsg})),!i)return o&&this._timelineToast.error(o),[];if(!i.relationVideoGroup||!this._timelineStore.switches.autoReplace)return this._usedMutableList.push(i.id),[i];let l=this._dataSdk.draftView.getDraftId(),{subDraftId:d,subDraftSegment:c,subDraft:u}=this._store[a.qk],h=null!=d?d:l,g=null!==(t=this._dataSdk.cutSame.draftIdToRelationVideoGroup[h].get(i.relationVideoGroup))&&void 0!==t?t:new Set;0===g.size&&d&&(null==u?void 0:u.getDuration())!==(null==c?void 0:c.sourceTimerange.duration)&&g.add(i.id);let m=this._dataSdk.cutSame.draftIdToMutableVideos[h].filter(t=>!this._usedMutableList.includes(t.id)&&g.has(t.id)&&(e.fileType!==s.YB.Video||this._autoReplace.check(t,r)));return this._usedMutableList=this._usedMutableList.concat(Array.from(g)),m}_getUISegmentBySegmentId(e){let{flattedSegments:t}=this._timelineStore;return t.find(t=>t.id===e)}_getUISegmentByMutableId(e){let{flattedSegments:t}=this._timelineStore;return t.find(t=>{var i;return(null===(i=t.mutable)||void 0===i?void 0:i.mutableId)===e})}_startBatchReplacing(e){this._timelineStore.setIsBatchReplacing(!0),this.setBatchReplaceCount({uploading:e,uploaded:0,replacedMaterial:0,filledMutable:0,failed:0,skipped:0})}_getIsTemplate(){return(0,A.JY)(this._videoEnvironmentService)}_getDraftId(){let{subDraftId:e}=this._store[a.qk];return null!=e?e:this._dataSdk.draftView.getDraftId()}constructor(e,t,i,n,r,s,o,l,d,c,u,h,g,f,_,S,y,x,M,T,I){var k=this;this._dataSdk=e,this._fileUploadManager=t,this._draftOperation=i,this._store=n,this._renderManager=r,this._timelineSelection=s,this._autoReplace=o,this._draftPathStore=l,this._smartToolsManager=d,this._coordinate=c,this._timelineToast=u,this._subjectCropManager=h,this._segmentSelection=g,this._draftTemplateManager=f,this._playerManager=_,this._selection=S,this._containerService=y,this._resourceService=x,this._payinPayoutService=M,this._draftMaterialsService=T,this._videoEnvironmentService=I,this._replaceMutableList=[],this._usedMutableList=[],this._hoverDebounceTimer=0,this._sameSlotReplaceHasToast=!1,this._coverPathCache=new Map,this._fileAccept=(0,m.U)(["video","image"]),this._asyncReplacingTask=[],this.cancelBatchReplace=async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];k._timelineStore.setIsBatchReplacing(!1),await Promise.all(k._asyncReplacingTask);let t=1/0;k.setBatchReplaceCount({uploading:0,uploaded:0,canceled:e?0:t,failed:e?t:0});let i=Object.keys(k._store[a.gC].mutableIdToStatusInfo).filter(e=>k._store[a.gC].mutableIdToStatusInfo[e].status===w.a.REPLACING);k._draftOperation.mutable.resetSegmentMutableStatus({mutableIds:i}),k._subjectCropManager.cancelSubjectCrop()},this.startQrUpload=()=>(this._replaceMutableList=this._getAllUnfilledAndVisibleMutable(),this._usedMutableList=[],this._batchReplaceUploadLinkManager.startQrUpload()),this._startQrBatchReplace=e=>{for(let t of e){let i="material";"material_link"===t.from?i="material_phone":"third_party"===t.from?i="material":"timeline_link"===t.from&&(i=this._timelineStore.isBatchReplacePanelVisible||this.isElementPanelMode?"slot_phone":"timeline_phone"),this._asyncReplacingTask.push(this._uploadFileToMutable(t.materialLifecycle.getModel(),{tasksTotal:e.length,from:i},!0))}},this._isTemplateEnvironment=this._getIsTemplate(),this._observableData=(0,C.LO)({disabledSegIds:new Set,hoverSegmentId:void 0,batchReplaceCount:{uploaded:0,uploading:0,replacedMaterial:0,filledMutable:0,failed:0,canceled:0,skipped:0},resortValidInfo:[],movedSegmentId:""}),this._ensureManager=this._containerService.createInstance(v.P,(0,A.JY)(this._videoEnvironmentService),this._draftPathStore),this._confirmBatchReplaceHelper=this._containerService.createInstance(b.s,e,this._payinPayoutService,n),this._confirmBatchReplaceHelper.onLinkMaterialUploaded(e=>{this._startQrBatchReplace([e])}),this._batchReplaceUploadLinkManager=this._containerService.createInstance(E.l,this._observableData,this._confirmBatchReplaceHelper,this._segmentSelection),this._batchReplaceUploadLinkManager.onStartBatchReplace(e=>{this._startBatchReplacing(e)}),this._batchReplaceUploadLinkManager.onBeforeStartBatchReplace(e=>{this._replaceMutableList=this._getAllUnfilledAndVisibleMutable(),this._usedMutableList=[],e.then(e=>{e.length&&this._startQrBatchReplace(e)})}),(0,C.U5)(()=>this.batchReplaceStatus,e=>{(e===p.g.SUCCESS||e===p.g.CANCELED)&&this.confirmBatchReplaceHelper.qrCodeReplaceConfirm&&setTimeout(()=>{this._batchReplaceUploadLinkManager.handleCurrentBatchReplaceTaskFinish(),this._confirmBatchReplaceHelper.resetQrCodeStatus()},1100)}),(0,C.U5)(()=>{let e=this._coordinate.context.store,t=new Set;if("dragging"!==e.dragState||!(0,D.Z)(e.message)||(0,D.Z)(e.message)&&"browser-outside"===e.message.sourceFrom)return t;for(let i of this._timelineStore.mutableVideos)try{!this._autoReplace.check(i,{type:e.message.type,data:e.message.dragSource})&&t.add(i.segmentId)}catch(e){}return t},e=>{this._observableData.disabledSegIds=e})}}O=(0,r.gn)([(0,r.fM)(16,l.t),(0,r.fM)(17,d.c),(0,r.fM)(18,f.sX),(0,r.fM)(19,y.D),(0,r.fM)(20,A.rO),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",["undefined"==typeof IDataSdk?Object:IDataSdk,"undefined"==typeof IEditorWidgetFileUploadManager?Object:IEditorWidgetFileUploadManager,"undefined"==typeof ITimelineDraftOperation?Object:ITimelineDraftOperation,"undefined"==typeof TimelineManagerStore?Object:TimelineManagerStore,void 0===_.zo?Object:_.zo,void 0===u.N?Object:u.N,"undefined"==typeof IAutoReplace?Object:IAutoReplace,"undefined"==typeof DraftPathStore?Object:DraftPathStore,"undefined"==typeof SmartToolsManager?Object:SmartToolsManager,"undefined"==typeof Coordinate?Object:Coordinate,"undefined"==typeof ITimelineToast?Object:ITimelineToast,"undefined"==typeof ISubjectCropManager?Object:ISubjectCropManager,"undefined"==typeof SegmentSelection?Object:SegmentSelection,"undefined"==typeof IDraftTemplateManager?Object:IDraftTemplateManager,"undefined"==typeof ITimelinePlayerManager?Object:ITimelinePlayerManager,"undefined"==typeof ISelection?Object:ISelection,void 0===l.t?Object:l.t,void 0===d.c?Object:d.c,void 0===f.sX?Object:f.sX,void 0===y.D?Object:y.D,void 0===A.rO?Object:A.rO])],O)},431093:function(e,t,i){i.d(t,{Z:()=>M});var n=i("72127"),r=i("39657"),a=i("892230"),s=i("112825"),o=i("907031"),l=i("65967"),d=i("211704"),c=i("650248"),u=i("709488"),h=i("824951"),g=i("928261"),m=i("140041"),f=i("849435"),p=i("800788"),v=i("377125");let _=["arco-modal-wrapper","segment-slot__btn"],S=["arco-modal-wrapper"],y=["lv-modal-wrapper"],x=["arco-modal-wrapper","menu-mutable","popup-confirm","timeline-quick-upload-btn-popover","mutable-batch-replace-panel-bottom","timeline-batch-replace-invoker","guide-modal","guide-mask","timeline-confirm-mask","timeline-tools","lv-modal"],b=["transition"],M=class e{get store(){return this._context.store}get _isTemplate(){return this.store.isTemplate}reset(){this._downBtnWitch=void 0,this._isCropAdsorb=!1}setSkipHandleTimelineUp(e){this._skipHandleTimelineUp=e}innovateStart(e,t){if(this._context.store.disable)return;this._context.userConfig.switch.unselectOnInnovate,this._context.store.setMessage(t);let i=this._context.userConfig.transfer.segment(t.type,t.dragSource);if(!i)return;if(this._context.store.setUISegments([i]),!!this._context.store.isSingleSelection)this._downBtnWitch="left",this._genInnovateOffset(),this._context.valid.calculate(),this._context.reference.calculate(),this._context.cursor.stage("drag"),this._context.store.setDragState("prepare"),this._context.store.setDragType("insert"),this._context.store.setDragStart({timestamp:Date.now(),x:e.clientX,y:e.clientY})}innovateRevoke(e,t,i){if(t!==this._context.store.dragType){console.log("innovateRevoke doesnt execute because dragType not match",t,this._context.store.dragType);return}if(!this._context.store.message){console.log("innovateRevoke doesnt execute because theres no message");return}if(!(0,d.Z)(this._context.store.message,i)){console.log("innovateRevoke doesnt execute because message no match",i,this._context.store.message);return}if("insert"===t){let[e]=this._context.registry.track.findByIndex(0);if(e){let t=this._context.registry.segment.findByTrack(e.id);this._context.uiUpdater.cleanSegmentsTransform(t)}this._context.enclaveDrag.free(),this._context.resetDrag()}}handleDraggingLocalFileOver(e,t){this._context.store.setMessage(t),this._context.store.setDragState("dragging"),this._context.store.setDragType("insert");let i={...e,x:e.clientX,y:e.clientY};this._context.mouse.calculate(i),this._handleDraging(i)}handleDraggingLocalFileLeave(){this._context.resetDrag(),!this._mousedownSegmentOrTransition&&this._context.situation.drag.reflexRelease()}establish(){var e,t,i,n,r,a,s,o;null===(e=this._context.store.container)||void 0===e||e.addEventListener("mouseenter",this.handleTimelineEnter),null===(t=this._context.store.container)||void 0===t||t.addEventListener("mouseleave",this.handleTimelineLeave),null===(i=this._context.store.container)||void 0===i||i.addEventListener("mousedown",this.handleTimelineDown),null===(n=this._context.store.container)||void 0===n||n.addEventListener("mouseup",this.handleTimelineUp),null===(r=this._context.store.container)||void 0===r||r.addEventListener("mousemove",this.handleTimelineMove),null===(a=this._context.store.container)||void 0===a||a.addEventListener("dblclick",this.handleTimelineDbClick),null===(s=this._context.store.container)||void 0===s||s.addEventListener("scroll",this.handleTimelineScroll),null===(o=this._context.store.vertivalContainer)||void 0===o||o.addEventListener("scroll",this.handleTimelineVerticalScroll),window.addEventListener("mousemove",this.handleWindowMove),window.addEventListener("mousedown",this.handleWindowDown),window.addEventListener("mouseup",this.handleWindowUp),window.addEventListener("mouseleave",this.handleWindowLeave)}relinquish(){var e,t,i,n,r,a,s,o;null===(e=this._context.store.container)||void 0===e||e.removeEventListener("mouseenter",this.handleTimelineEnter),null===(t=this._context.store.container)||void 0===t||t.removeEventListener("mouseleave",this.handleTimelineLeave),null===(i=this._context.store.container)||void 0===i||i.removeEventListener("mousedown",this.handleTimelineDown),null===(n=this._context.store.container)||void 0===n||n.removeEventListener("mouseup",this.handleTimelineUp),null===(r=this._context.store.container)||void 0===r||r.removeEventListener("mousemove",this.handleTimelineMove),null===(a=this._context.store.container)||void 0===a||a.addEventListener("dblclick",this.handleTimelineDbClick),null===(s=this._context.store.container)||void 0===s||s.removeEventListener("scroll",this.handleTimelineScroll),null===(o=this._context.store.vertivalContainer)||void 0===o||o.removeEventListener("scroll",this.handleTimelineVerticalScroll),window.removeEventListener("mousemove",this.handleWindowMove),window.removeEventListener("mousedown",this.handleWindowDown),window.removeEventListener("mouseup",this.handleWindowUp),window.removeEventListener("mouseleave",this.handleWindowLeave)}_clickBlank(e,t){"left"===this._downBtnWitch&&this._isTimelineDown&&!this._isClickHScrollbar&&this._context.userConfig.trigger.clickBlank(t)}_reselect(){this._context.userConfig.trigger.refreshSegment()}_clickSelectSegmentOrTransition(e,t){let{uiSegments:i,message:n}=this._context.store,r="click";if(((null==n?void 0:n.registeredType)==="mutable"||(null==n?void 0:n.registeredType)==="tier-block")&&this._context.store.setHasMutableVideoClicked(!0),e&&((null==n?void 0:n.registeredType)==="mutable"||(null==n?void 0:n.registeredType)==="mutableAudio"||(null==n?void 0:n.registeredType)==="tier-block")){this._context.userConfig.trigger.selectSegmentOrTransition({segmentIds:[e],transitionIds:[]},r);return}let a=[],o=[];if(i.forEach(e=>{e.id&&("transition"===e.type?o.push(e.id):a.push(e.id))}),this._context.store.cmdKeyHadDown){t===s.C3.SEGMENT?a.includes(e)?(r="cmd_click_cancel",a=a.filter(t=>t!==e)):(r="cmd_click",a.push(e)):o.includes(e)?(r="cmd_click_cancel",o=o.filter(t=>t!==e)):(r="cmd_click",o.push(e)),this._context.userConfig.trigger.selectSegmentOrTransition({transitionIds:o,segmentIds:a},r);return}!(a.includes(e)||o.includes(e))&&(t===s.C3.SEGMENT?this._context.userConfig.trigger.selectSegmentOrTransition({segmentIds:[e],transitionIds:[]},r):this._context.userConfig.trigger.selectSegmentOrTransition({segmentIds:[],transitionIds:[e]},r))}_endBoxSelection(){if("none"===this._context.boxSelection.selectState)return!1;{let e="boxSelecting"===this._context.boxSelection.selectState;return this._context.boxSelection.end(),this._context.situation.timeline.reset(),e&&this._context.userConfig.trigger.endBoxSelect(),e}}_shouldChangeSelectWhenEdge(e,t){let[i,n]=t,r=!this._context.store.isSingleSelection,a="edge-front"===e&&!(n&&this._context.store.isSingleSelection&&this._context.store.uiSegments[0].id===n.id),s="edge-rear"===e&&!(i&&this._context.store.isSingleSelection&&this._context.store.uiSegments[0].id===i.id);return r||a||s}_checkIsClickScrollBar(){this._isClickHScrollbar=void 0!==this._context.mouse.absolute&&this._context.mouse.absolute.y>this._context.unit.containerHeight-o.St-10}_shouldStartDrag(e){return(0,n.nq)(this._context.store.dragStart,{x:e.clientX,y:e.clientY},5e3,5)}_handleBoxSelectionMove(){let{mouse:e,registry:t,boxSelection:i,store:n}=this._context,{x:r,y:a}=e.relative,s={x:Math.max(r+n.operationWidthInner,n.operationWidthInner),y:Math.min(a,this.store.vertivalContainer.scrollHeight)};i.move(s);let o={x:i.startLocation.x-n.operationWidthInner,y:i.startLocation.y},l=e.relative;if(l){let e={x:Math.min(o.x,l.x),y:Math.min(o.y,l.y)},i={x:Math.max(o.x,l.x),y:Math.max(o.y,l.y)},n=t.findAllSegmentsAndTransitionsByRect({start:e,end:i}),r=n.segements.map(e=>e.id),a=n.transitions.map(e=>e.id);this.store.cmdKeyHadDown&&(this.store.uiSegments.forEach(e=>{"transition"===e.type?a.push(e.id):r.push(e.id)}),a=Array.from(new Set(a)),r=Array.from(new Set(r))),this._context.userConfig.trigger.selectSegmentOrTransition({segmentIds:r,transitionIds:a},"box_select")}if(this.store.isInTimelineBd){let e=this._context.situation.timeline.situation();this._context.situation.timeline.reflexInspect(e)}}_genInnovateOffset(){if(!this._context.store.isSingleSelection)return;let e=m.yh[this._context.store.uiSegments[0].type]?{...m.yh[this._context.store.uiSegments[0].type]}:void 0;e&&this._context.mouse.recordElementOffset(e)}_getSnapshotTracks(){let e=this.store.segmentSelected.filter(e=>"transition"!==e.type).map(e=>e.id);if(!e.length)return[];let{tracks:t}=this.store,i=[];return t.forEach(t=>{let[n,r]=t,a=t[0].segments.filter(t=>e.includes(t.id));i.push([{...n,segments:a},r])}),i}constructor(e){this._context=e,this._skipHandleTimelineUp=!1,this._skipHandleTimelineUpOnce=!1,this._isTimelineDown=!1,this._isClickHScrollbar=!1,this._isCropAdsorb=!1,this.handleTimelineEnter=e=>{if((0,n.O1)(e.target,["lv-modal-wrapper"]))return;if(this._context.event.emit(s.B.timelineEnter),this.store.setIsInTimelineBd(!0),this._context.enclaveDrag.stage("inner"),"dragging"===this._context.store.dragState)"insert"===this._context.store.dragType?this._insertMoveCursorChange(e):"crop"===this._context.store.dragType&&this._context.cursor.stage(this._context.situation.crop.cropSide)},this.handleTimelineLeave=e=>{if((0,n.O1)(e.target,["lv-modal-wrapper"]))return;if(this._context.event.emit(s.B.timelineLeave),this.store.setIsInTimelineBd(!1),this._context.enclaveDrag.stage("outer"),"dragging"===this._context.store.dragState)"insert"===this._context.store.dragType&&(this._context.cursor.stage("drag"),this._context.dirty.executeClean(),this._context.valid.hidePlaceholder())},this.handleTimelineDown=e=>{var t,i,a,o,d,c;this._mousedownSegmentOrTransition=void 0;let u=e.target;if((0,n.O1)(u,_))return;if(this._isTimelineDown=!0,this._cmdSelect=void 0,this._context.store.disable||this._context.store.isCursorDrag||this._context.store.isHoverCursor)return;if((0,r.xE)(e,"left"))this._downBtnWitch="left";else{if(!(0,r.xE)(e,"right"))return;this._downBtnWitch="right"}if(this._context.mouse.calculate(e),this._checkIsClickScrollBar(),this._context.mouse.absolute&&this._context.mouse.absolute.y<=0)return;let h=this._context.registry.tier.lbs(this._context.mouse.fixed);if(h){this._context.store.setMessage({id:h.id,registeredType:h.registeredType}),this._clickSelectSegmentOrTransition(h.id,s.C3.SEGMENT);return}let{track:g,segment:m,transition:f,positionType:v,extra:S}=this._context.registry.lbs(this._context.mouse.relative);if(this._context.store.mutableAudioDisableInteract&&(null==m?void 0:m.registeredType)==="mutableAudio"){this._skipHandleTimelineUpOnce=!0;return}if(m?this._mousedownSegmentOrTransition=m:f&&(this._mousedownSegmentOrTransition=f),!g||!(m||f)){if(this._context.mouse.relative&&this._context.mouse.relative.x<0||!this._context.store.cmdKeyHadDown&&this._context.userConfig.trigger.selectSegmentOrTransition({segmentIds:[],transitionIds:[]},"click"),!m&&(this._context.store.setDragStart({timestamp:Date.now(),x:e.clientX,y:e.clientY}),!1!==this._context.userConfig.switch.boxSelection&&!this._context.store.expandedSegmentId)){if(this._context.mouse.relative.x<0)return;let e={x:this._context.mouse.relative.x+this._context.store.operationWidthInner,y:this._context.mouse.relative.y};this._context.boxSelection.start(e)}return}(0,p.Y2)(m||f);let y=null!==(t=null==m?void 0:m.id)&&void 0!==t?t:null==f?void 0:f.id,x=null!==(i=null==m?void 0:m.registeredType)&&void 0!==i?i:null==f?void 0:f.registeredType,b=null!==(a=null==m?void 0:m.trackId)&&void 0!==a?a:null==f?void 0:f.trackId,M=null!==(o=null==m?void 0:m.start)&&void 0!==o?o:null==f?void 0:f.start,T=null!==(d=null==m?void 0:m.duration)&&void 0!==d?d:null==f?void 0:f.duration;if(void 0===y||void 0===x||void 0===b||void 0===M||void 0===T)return;if("keyframe"===v&&(0,s.OV)(m)&&(null==S?void 0:S.keyframeValue)&&this._context.keyframeDrag.handleKeyframeMousedown(e,m,null==S?void 0:S.keyframeValue),"right"===this._downBtnWitch){this._context.store.setMessage({id:y,registeredType:x,sourceTrackIndex:g.index}),!this._context.store.uiSegments.find(e=>e.id===(null==m?void 0:m.id)||e.id===(null==f?void 0:f.id))&&(m?this._clickSelectSegmentOrTransition(m.id,s.C3.SEGMENT):f&&this._clickSelectSegmentOrTransition(f.id,s.C3.TRANSITION));return}let I=["mutable","combination"].includes(null!==(c=null==m?void 0:m.registeredType)&&void 0!==c?c:"")?"middle":v;if(this._context.store.setTargetSegment({segId:y,trackId:b}),"edge-front"===I||"edge-rear"===I){if(f){let e=this._context.registry.segment.findByTransition(f.id),[t,i]=(0,l.Tt)(f,e);this._shouldChangeSelectWhenEdge(I,[t,i])?(this._context.store.setMessage({id:f.id,registeredType:f.registeredType,sourceTrackIndex:g.index}),this._clickSelectSegmentOrTransition(f.id,s.C3.TRANSITION)):(this._context.situation.crop.cacheDragFrom({duration:0n}),this._context.situation.crop.recordTransitionDuration())}else(0,p.Y2)(m),this._context.store.setMessage({id:m.id,registeredType:m.registeredType,sourceTrackIndex:g.index}),this._clickSelectSegmentOrTransition(m.id,s.C3.SEGMENT);m?this._context.situation.crop.setCropSeg({id:y,edge:I,type:"segment"}):f&&this._context.situation.crop.setCropSeg({id:y,edge:I,type:"transition"}),this._context.store.setDragType("crop"),this._context.cursor.stage(I),this._context.situation.crop.calculate(I)}else"keyframe"===I?(this._context.store.setDragType("keyframe"),this._context.cursor.stage("ew-resize")):(this._context.userConfig.trigger.cancelKeyframeSelect(),this._context.store.setMessage({id:y,registeredType:x,sourceTrackIndex:g.index}),m?this._clickSelectSegmentOrTransition(m.id,s.C3.SEGMENT):f&&this._clickSelectSegmentOrTransition(f.id,s.C3.TRANSITION),this._context.mouse.referElementOffset({x:this._context.unit.us2px(M),y:g.startY}),0===g.index&&this._context.situation.drag.cacheDragFrom({start:M,duration:T}),this._context.store.setDragType("update"),this._context.valid.calculate(),this._context.reference.calculate());this._context.store.setDragState("prepare"),this._context.store.setDragStart({timestamp:Date.now(),x:e.clientX,y:e.clientY})},this.handleTimelineUp=e=>{var t,i,r,a;if(!this._isTimelineDown&&"insert"!==this._context.store.dragType)return;if(this._context.userConfig.modules.draftOperation.setEnableTimelineRefresh(!0),(0,n.O1)(e.target,S)||this._skipHandleTimelineUp)return;if("dragging"===this._context.store.dragState&&"insert"===this._context.store.dragType){let{x:t}=this._context.store.container.getBoundingClientRect();if(e.x<t+this.store.operationWidth){this._context.resetDrag();return}}if(this._skipHandleTimelineUpOnce){this._skipHandleTimelineUpOnce=!1;return}if("dragging"!==this._context.store.dragState&&this._cmdSelect&&this._context.userConfig.trigger.selectSegmentOrTransition({segmentIds:this._cmdSelect.segmentIds,transitionIds:this._cmdSelect.transitionIds},this._cmdSelect.action),this._endBoxSelection())return;if(this._context.store.disable||"left"!==this._downBtnWitch){this._context.resetDrag();return}this._context.mouse.calculate(e);let o=this._context.registry.tier.lbs(this._context.mouse.fixed);if(o){this._clickSelectSegmentOrTransition(o.id,s.C3.SEGMENT);return}if(!this._mousedownSegmentOrTransition&&this._context.mouse.relative&&(null===(t=this._context.mouse.relative)||void 0===t?void 0:t.x)>=0&&!("dragging"===this._context.store.dragState&&"insert"===this._context.store.dragType)){if((null===(a=this._context.store.message)||void 0===a?void 0:a.registeredType)==="mutable"){this._context.resetDrag();return}!this._context.store.isCursorDrag&&"dragging"!==this._context.store.dragState&&this._clickBlank(e,this._context.mouse.time)}"dragging"!==this._context.store.dragState&&this._mousedownSegmentOrTransition&&!this._context.store.cmdKeyHadDown&&(null===(i=this._context.store.message)||void 0===i?void 0:i.registeredType)!=="mutable"&&(null===(r=this._context.store.message)||void 0===r?void 0:r.registeredType)!=="tier-block"&&("transition"===this._mousedownSegmentOrTransition.registeredType?this._context.userConfig.trigger.selectSegmentOrTransition({segmentIds:[],transitionIds:[this._mousedownSegmentOrTransition.id]},"click"):this._context.userConfig.trigger.selectSegmentOrTransition({segmentIds:[this._mousedownSegmentOrTransition.id],transitionIds:[]},"click","mouse_up"));let l=!1,d="move";if("none"!==this._context.store.dragState&&!!this._context.store.uiSegments.length){if("prepare"===this._context.store.dragState);else if("crop"===this._context.store.dragType){this._context.userConfig.trigger.cropHandlerBefore(),d="crop",l=this._isCropAdsorb;let e=this._context.situation.crop.situation();this._context.situation.crop.reflexExecute(e),this._context.userConfig.trigger.cropAfter(this._context.situation.crop.cropStartTime),this._reselect()}else if("keyframe"===this._context.store.dragType)this._context.keyframeDrag.handleKeyframeMouseUp();else{d="move",l=this._context.reference.adsorb();let e=this._context.situation.drag.situation();if(this._context.situation.drag.reflexExecute(e),this._context.enclaveDrag.free(),(0,h.Ui)(e)){let t=this._context.registry.segment.findByTrack(e.track.id);this._context.uiUpdater.cleanSegmentsTransform(t)}this._reselect()}l&&this._context.userConfig.trigger.handleAbsorb(d),this._context.resetDrag()}},this.handleTimelineMove=e=>{this._context.store.disableInteract&&!this._context.store.disableReadonlyMode&&this._context.resetDrag();let t=(0,c.Z)(e=>{var t,i,n,r,a,s,l;let d,c;let h=e.target,g=[null===(t=h.parentElement)||void 0===t?void 0:t.id,h.id,null===(n=h.parentElement)||void 0===n?void 0:null===(i=n.parentElement)||void 0===i?void 0:i.id,null===(s=h.parentElement)||void 0===s?void 0:null===(a=s.parentElement)||void 0===a?void 0:null===(r=a.parentElement)||void 0===r?void 0:r.id];if(this._context.store.isCursorDrag||"dragging"===this._context.store.dragState||"boxSelecting"===this._context.boxSelection.selectState||g.includes(o.$K))return;this._context.mouse.calculate(e);let m=!1,{track:p,segment:v,positionType:_}=this._context.registry.lbs(this._context.mouse.relative);if(this._context.mouse.absolute&&this._context.mouse.absolute.y>0){c=_;let e=null!==(l=null==v?void 0:v.registeredType)&&void 0!==l?l:"";if((this._context.store.isInTemplate||f.V.has(e))&&(!this._context.store.isInTemplate||this._context.store.mutableAudioDisableInteract||"mutableAudio"!==e)||this._context.store.disableInteract)(this._context.store.isInTemplate||f.V.has(e))&&this._context.cursor.stage("default");else{let e="edge-front"===_||"edge-rear"===_?_:"keyframe"===_?"ew-resize":"default";this._context.cursor.stage(e)}d=v,m=!!(p&&v),this._context.store.setHoverSegLocation(d&&{x:0,y:d.refEl.y})}this._context.store.setHoverSegPart(c),this._context.store.setHoverSeg(d),this._context.store.setIsHoverSeg(m);let S=g.includes(o.Zv)&&"keyframe"!==c;(0,u.Z9)(300,m&&S,()=>{this._context.store.setIsHoverCursorSeg(m&&S)}),this._context.store.setIsHoverCursor(!m&&S)},100);t(e),(()=>{this._context.event.emit(s.B.previewLineSeek,{absolute:this._context.mouse.absolute.x,relative:this._context.mouse.relative.x,time:this._context.mouse.time})})()},this.handleTimelineDbClick=e=>{if(this._context.mouse.absolute&&this._context.mouse.absolute.y<=0)return;this._context.mouse.calculate(e);let{track:t,segment:i,transition:n}=this._context.registry.lbs(this._context.mouse.relative);this._context.userConfig.trigger.dbClick(t?{trackId:t.id,segmentId:null==i?void 0:i.id,transitionId:null==n?void 0:n.id}:null)},this.handleTimelineScroll=()=>{this._handleScroll(!0)},this.handleTimelineVerticalScroll=()=>{this._handleScroll(!1)},this.handleWindowMove=(0,c.Z)(e=>{var t,i;if(!(0,n.O1)(e.target,y)&&!this._context.store.disable&&("none"!==this._context.store.dragState||"none"!==this._context.boxSelection.selectState)&&(null===(t=this._context.store.message)||void 0===t?void 0:t.registeredType)!=="tier-block"&&(null===(i=this._context.store.message)||void 0===i?void 0:i.registeredType)!=="mutable")try{this._context.mouse.calculate(e),"prepare"===this._context.boxSelection.selectState?!this._context.store.disableSelection&&this._shouldStartDrag(e)&&this._handleBoxSelectionMove():"prepare"===this._context.store.dragState?this._shouldStartDrag(e)&&this._handleDragPrepare(e):("dragging"===this._context.store.dragState||"boxSelecting"===this._context.boxSelection.selectState)&&this._handleDraging(e)}catch(e){this._context.resetDrag(),this._context.userConfig.trigger.catchError(e)}},10),this.handleWindowDown=e=>{if((0,n.O1)(e.target,x)||this._context.store.disable)return;if((0,r.xE)(e,"left"))this._downBtnWitch="left";else{if(!(0,r.xE)(e,"right"))return;this._downBtnWitch="right"}this.store.targetSegment&&this._context.registry.segment.setDraggedSegment(this.store.targetSegment.id),this._context.mouse.calculate(e),this.store.targetSegment&&this._context.registry.segment.setDraggedSegment(this.store.targetSegment.id);let t=document.querySelector(".mutable-poly-modal-children");if(this.store.isBatchReplace&&(t=document.querySelector(`.${v.PO}`)),!t)return;let{left:i,right:o,bottom:l,top:d}=t.getBoundingClientRect();if(!(0,a.mK)(e.y,[d,l])||!(0,a.mK)(e.x,[i,o]))return;let c=this._context.registry.tier.lbs(this._context.mouse.fixed);c&&(this._context.store.setMessage({id:c.id,registeredType:c.registeredType}),this._clickSelectSegmentOrTransition(c.id,s.C3.SEGMENT))},this.handleWindowUp=e=>{if(!this._isTimelineDown&&"insert"!==this._context.store.dragType)return;if(this._context.userConfig.modules.draftOperation.setEnableTimelineRefresh(!0),this._isTimelineDown=!1,this._skipHandleTimelineUp=!1,(0,n.O1)(e.target,["arco-modal-wrapper"])||this._endBoxSelection())return;if(this._context.store.disable&&"dragging"===this._context.store.dragState)return this._context.resetDrag();if(!this._context.store.disable&&"none"!==this._context.store.dragState){if("prepare"===this._context.store.dragState);else if("insert"===this._context.store.dragType){if(this._context.mouse.calculate(e),this._context.registry.tier.lbs(this._context.mouse.fixed)){let e=this._context.situation.drag.situation();this._context.situation.drag.reflexExecute(e)}this._context.dirty.executeClean(),this._context.valid.hideSpace(),this._context.enclaveDrag.free()}else if("crop"===this._context.store.dragType){this._context.userConfig.trigger.cropHandlerBefore(),this._context.mouse.calculate(e);let t=this._context.situation.crop.situation();this._context.situation.crop.reflexExecute(t),this._context.userConfig.trigger.cropAfter(this._context.situation.crop.cropStartTime),this._reselect()}else if("keyframe"===this._context.store.dragType)this._context.keyframeDrag.handleKeyframeMouseUp();else{this._context.mouse.calculate(e),this._context.reference.adsorb();let t=this._context.situation.drag.situation();if(this._context.situation.drag.reflexExecute(t),this._context.enclaveDrag.free(),(0,h.Ui)(t)){let e=this._context.registry.segment.findByTrack(t.track.id);this._context.uiUpdater.cleanSegmentsTransform(e)}this._reselect()}this._context.resetDrag()}},this.handleWindowLeave=e=>{if(this._isTimelineDown=!1,(0,n.O1)(e.target,["lv-modal-wrapper"]))return;if(this._endBoxSelection(),"dragging"===this._context.store.dragState){if("insert"===this._context.store.dragType||"update"===this._context.store.dragType){if("update"===this._context.store.dragType){var t,i;null===(t=(i=this._context.userConfig.trigger).unescapeSegment)||void 0===t||t.call(i)}if(this._context.enclaveDrag.free(),this._context.store.isSingleSelection){let[e]=this._context.registry.track.findBySegment(this._context.store.uiSegments[0].id),t=e?this._context.registry.segment.findByTrack(e.id):[];this._context.uiUpdater.cleanSegmentsTransform(t)}}else if("crop"===this._context.store.dragType){this._context.userConfig.trigger.cropHandlerBefore(),this._context.reference.skipForCrop(),this._context.reference.adsorb();let e=this._context.situation.crop.situation();this._context.situation.crop.reflexExecute(e),this._context.userConfig.trigger.cropAfter(this._context.situation.crop.cropStartTime),this._reselect()}else"keyframe"===this._context.store.dragType&&this._context.keyframeDrag.handleKeyframeMouseUp();this._context.resetDrag()}},this._handleDragPrepare=e=>{if(this._context.store.disableInteract)return!1;if("insert"===this._context.store.dragType)return this._context.enclaveDrag.join(),this._context.enclaveDrag.move(),this._context.store.setDragState("dragging"),!1;if("update"===this._context.store.dragType){if(!1===this._context.userConfig.switch.move)return this._context.resetDrag(),!1;if(this._context.situation.dragMulti.setDragingStart(),this._context.enclaveDrag.judgeSide(e),"inner"===this._context.enclaveDrag.side){if((0,g.hi)(this._context.store.targetSegment))return this._context.resetDrag(),!1;this._context.userConfig.modules.draftOperation.setEnableTimelineRefresh(!1),this._context.enclaveDrag.join("inner"),this._context.enclaveDrag.join(),this._context.enclaveDrag.move(),this._context.store.setDragState("dragging");let e=this._getSnapshotTracks();this.store.setSnapshotTracks(e),this._context.userConfig.trigger.escapeSegment(),this._context.situation.drag.reflexStartOperation(this._mousedownSegmentOrTransition),this._context.userConfig.trigger.dragBefore()}return!1}if("crop"===this._context.store.dragType){if(!this._context.userConfig.switch.crop||!this._context.situation.crop.cropSegment)return this._context.resetDrag(),!1;let{cropSegment:e}=this._context.situation.crop;this._context.userConfig.trigger.cropBefore(e.edge),(null==e?void 0:e.type)==="segment"?this._context.userConfig.trigger.selectSegmentOrTransition({segmentIds:[e.id],transitionIds:[]},"click"):(null==e?void 0:e.type)==="transition"&&this._context.userConfig.trigger.selectSegmentOrTransition({segmentIds:[],transitionIds:[e.id]},"click"),this._context.situation.crop.calculate(e.edge),this._context.situation.crop.calcCropingExpandInfo(e.edge),this._context.store.setDragState("dragging")}if("keyframe"===this._context.store.dragType){if(!(this._context.keyframeDrag.draggingKeyframeMapValue&&this._context.keyframeDrag.draggingSegment))return!1;this._context.store.setDragState("dragging")}return!0},this._handleDraging=e=>{let t="inner"===this._context.enclaveDrag.judgeSide(e),i="insert"===this._context.store.dragType;if(i){if(t)this._insertMoveCursorChange(e);else{let{x:t,y:i}=this.store.container.getBoundingClientRect();e.x>t&&e.y>i&&this._context.cursor.stage("drag")}}if("boxSelecting"===this._context.boxSelection.selectState)this._handleBoxSelectionMove();else if(!this._context.store.disableInteract){if("crop"===this._context.store.dragType){this._context.reference.skipForCrop(),this._isCropAdsorb=this._context.reference.adsorb();let e=this._context.situation.crop.situation();this._context.situation.crop.reflexInspect(e);let t=this._context.situation.crop.getCropingSeekInfo(),i=this._context.situation.crop.getCropingSpeedInfo();t&&i&&this._context.userConfig.trigger.cropingSeek(t,i)}else if("keyframe"===this._context.store.dragType)this._context.keyframeDrag.handleKeyframeMouseMove(e.clientX);else{if(!t){var n,r;let e=this._context.situation.drag.situation();this._context.store.enableHoverOutsideTimeline||b.includes(null!==(r=null===(n=this._context.store.targetSegment)||void 0===n?void 0:n.type)&&void 0!==r?r:"")?this._context.situation.drag.reflexInspect(e):this._context.situation.drag.reflexRelease()}if("inner"===this._context.enclaveDrag.side){this._context.reference.adsorb();let e=this._context.situation.drag.situation();this._context.situation.drag.reflexInspect(e)}else"insert"===this._context.store.dragType&&this._context.valid.hideSpace();if(this._context.enclaveDrag.move(),this._context.store.enableTimelineScrollOnEdge&&t){let e=this._context.situation.timeline.situation();this._context.situation.timeline.reflexInspect(e)}}}i&&!t&&(this._context.reference.reset(),this._context.dirty.executeClean(),this._context.valid.hidePlaceholder())},this._handleScroll=(0,c.Z)(e=>{this._context.unit.fetchScroll(e),this._context.mouse.calculateScroll(),"boxSelecting"===this._context.boxSelection.selectState&&this._handleBoxSelectionMove()},50),this._insertMoveCursorChange=e=>{if("insert"===this._context.store.dragType){let{x:t}=this.store.container.getBoundingClientRect();e.x>t+this.store.operationWidthInner&&this._context.cursor.stage("insert")}}}}},818755:function(e,t,i){i.d(t,{Z:()=>l});var n=i("969242"),r=i("857670"),a=i("426336");function s(e){return(0,r.i1)(e*r.G8)}var o=i("362853");let l=class e{get draggingSegment(){return this._draggingSegment}get draggingKeyframeMapValue(){return this._draggingKeyframeMapValue}constructor(e){this._preFormatFrame=0,this._newFormatFrame=0,this.handleKeyframeMousedown=(e,t,i)=>{let{id:n}=t,{cmdKeyHadDown:s,keyframeSelectInfo:l}=this.context.store,{clientX:d,button:c}=e,{frame:u}=i;this._draggingSegment=t,this._draggingKeyframeMapValue=i,this._startDragPosX=d,this._preFormatFrame=u,this._newFormatFrame=u;let h=(0,r.i1)(a.pMA.times(u,r.G8,"bigint")),g=c===o.JK;g&&this.context.userConfig.trigger.keyframeContextMenuOpen();let{seg_id:m,keyframes_infos:f=[]}=null!=l?l:{},p={seg_id:n,keyframes_infos:[i]};if(m===n&&s&&!g){let e=f.filter(e=>e.offset!==i.offset);p.keyframes_infos.push(...e)}this.context.userConfig.trigger.keyframeSelect(p,h,!g)},this.handleKeyframeMouseMove=e=>{var t;if(!(this._draggingKeyframeMapValue&&this._draggingSegment))return;let{frame:i,preKeyframeFrameIndex:o,nextKeyframeFrameIndex:l,currentKeyframeIndex:d,offset:c}=this._draggingKeyframeMapValue,u=null!==(t=this._startDragPosX)&&void 0!==t?t:e,h=(0,r.i1)((0,n.TF)(this.context.store.zoom,e-u)),{id:g,start:m,duration:f}=this._draggingSegment,p=function(e){let{frame:t,start:i,duration:n,preFrame:s,nextFrame:o}=e,l=void 0!==s?s+1:a.pMA.div(i,r.G8,"number","round");return Math.max(Math.min(t,void 0!==o?o-1:a.pMA.div(n+i,r.G8,"number","round")),l)}({frame:i+a.pMA.div(h,r.G8,"number","round"),start:m,duration:f,preFrame:o,nextFrame:l});if(this._newFormatFrame=p,Math.abs(this._preFormatFrame-p)>0){let{keyframeMap:e}=this._draggingSegment;if(e){let t=s(BigInt(p)),i={...this._draggingKeyframeMapValue,frame:p};e.set(c,i),this.context.uiUpdater.keyframeKeepActive({segId:g,data:{keyframesMap:e,keepActiveIndex:d}}),this._dragKeyframeUpdatePromise=this.context.userConfig.trigger.dragKeyframeUpdate({seg_id:g,keyframes_infos:[i]},t),this._preFormatFrame=p}}},this.handleKeyframeMouseUp=async()=>{if(this._dragKeyframeUpdatePromise&&(await this._dragKeyframeUpdatePromise,this._dragKeyframeUpdatePromise=void 0),this._draggingKeyframeMapValue&&this._draggingSegment){let e=this._newFormatFrame,t=s(BigInt(e)),{keyframe_details:i,frame:n,currentKeyframeIndex:r}=this._draggingKeyframeMapValue,{id:a}=this._draggingSegment;if(e!==n&&i.length){let i={...this._draggingKeyframeMapValue,frame:e};await this.context.userConfig.trigger.dragKeyframeEnd({seg_id:a,keyframes_infos:[i],draggedKeyframeIndex:r},t)}}this._draggingSegment&&this.context.uiUpdater.keyframeKeepActive({segId:this._draggingSegment.id,data:{keepActiveIndex:void 0}}),this._draggingSegment=void 0,this._draggingKeyframeMapValue=void 0,this._startDragPosX=void 0,this._preFormatFrame=0},this.context=e}}},998588:function(e,t,i){i.d(t,{E:function(){return s}});var n=i(843168),r=i(804497),a=i(632555);class s extends n.J{get entities(){return[...this._segments]}get draggedSegment(){return this._draggedSegment}register(e){this._segments=e,this._sortSegments()}unregister(e){let t=[];return this._segments=this._segments.filter(i=>!e.includes(i.id)||(t.push(i),!1)),t}update(e){let t=this._segments.find(t=>{let{id:i}=t;return i===e.id});t&&Object.assign(t,e)}replace(e){if(Array.isArray(e)){let t=e.reduce((e,t)=>(e.add(t.id),e),new Set);this._segments=[...this._segments.filter(e=>!t.has(e.id)),...e],this._sortSegments()}else{let t=this._segments.findIndex(t=>{let{id:i}=t;return i===e.id});t>-1&&this._segments.splice(t,1);let i=this._segments.findIndex(t=>(0,r.y_)(t,e)>=0);i=i>-1?i:this._segments.length,this._segments.splice(i,0,e)}}findById(e){let t=this._segments.findIndex(t=>t.id===e);return[this._segments[t],t]}findByTrack(e){return this._segments.filter(t=>t.trackId===e).sort(r.y_)}findByTransition(e){let[t]=this.context.registry.transition.findById(e);return t?this.findByTrack(t.trackId).filter(e=>(0,a.mK)(e.start,[t.start,t.start+t.duration])||(0,a.mK)(e.start+e.duration,[t.start,t.start+t.duration])):[]}findCanBeAddTransition(){let e=[];for(let n of this._segments){var t,i;let[a]=this.context.registry.track.findBySegment(n.id);if(!(null==a?void 0:null===(i=a.availSegment)||void 0===i?void 0:null===(t=i.includes)||void 0===t?void 0:t.call(i,"video")))continue;let s=this.findByTrack(n.trackId);s.sort(r.y_);let[o,l]=(0,r.kf)(s,n);if(!o||!l)continue;let d=l.start-(o.start+o.duration);d>=0n&&d<=1n&&e.push(n)}return e}findPrev(e){let[t]=this.context.registry.track.findBySegment(e);if(!t)return;let i=this.findByTrack(t.id),n=i.findIndex(t=>t.id===e);if(n>=1)return i[n-1]}findNext(e){let[t]=this.context.registry.track.findBySegment(e);if(!t)return;let i=this.findByTrack(t.id),n=i.findIndex(t=>t.id===e);if(n>=0&&n<=i.length-2)return i[n+1]}findFirst(e){let[t]=this.context.registry.track.findBySegment(e);if(!!t)return this.findByTrack(t.id)[0]}setDraggedSegment(e){var t;let i=this.findById(e);if(null===(t=i[0])||void 0===t?void 0:t.refEl){let{height:e}=i[0].refEl;this._draggedSegment={...i[0],style:{height:e}}}}_sortSegments(){this._segments.sort(r.y_)}constructor(...e){super(...e),this._segments=[],this._draggedSegment=null}}},821768:function(e,t,i){i.d(t,{c:function(){return s}});var n=i(843168),r=i(804497),a=i(632555);class s extends n.J{get entities(){return[...this._transitions]}register(e){this._transitions=e}unregister(e){let t=[];return this._transitions=this._transitions.filter(i=>!e.includes(i.id)||(t.push(i),!1)),t}update(e){let t=this._transitions.find(t=>{let{id:i}=t;return i===e.id});t&&Object.assign(t,e)}replace(e){if(Array.isArray(e)){let t=e.reduce((e,t)=>(e.add(t.id),e),new Set);this._transitions=[...this._transitions.filter(e=>!t.has(e.id)),...e]}else{let t=this._transitions.findIndex(t=>{let{id:i}=t;return i===e.id});t>-1?this._transitions.splice(t,1,e):this._transitions.push(e)}}findById(e){let t=this._transitions.findIndex(t=>t.id===e);return[this._transitions[t],t]}findByTrack(e){return this._transitions.filter(t=>t.trackId===e).sort(r.y_)}findBySegment(e){let[t]=this.context.registry.segment.findById(e);return t?this.context.registry.transition.findByTrack(t.trackId).filter(e=>(0,a.mK)(t.start,[e.start,e.start+e.duration])||(0,a.mK)(t.start+t.duration,[e.start,e.start+e.duration])):[]}findBySegmentSequenced(e){let[t]=this.context.registry.segment.findById(e);if(!t)return[void 0,void 0];let i=this.context.registry.transition.findByTrack(t.trackId);return[i.find(e=>(0,a.mK)(t.start,[e.start,e.start+e.duration])),i.find(e=>(0,a.mK)(t.start+t.duration,[e.start,e.start+e.duration]))]}constructor(...e){super(...e),this._transitions=[]}}},603577:function(e,t,i){i.d(t,{Z:function(){return g}});var n=i(29188),r=i(928261),a=i(112825),s=i(824951),o=i(804497),l=i(810233),d=i(72127),c=i(784878),u=i(65967),h=i(426336);let g=class e{get currentSitutation(){return this._currentSitutation}get targetSegment(){return this._context.store.targetSegment}reset(){this._dragFrom=void 0,this.reflexRelease(),this._context.uiUpdater.replaceHoverPlaceholderTrack(this._context.registry.track.entities,!1)}cacheDragFrom(e){this._dragFrom=e}situation(){let e,t=h.pMA.max([0,this._context.reference.trElement],"bigint");this._context.situation.dragMulti.isReflexToMain&&(t=h.pMA.max([0,this._context.mouse.trElement],"bigint"));let i={x:this._context.unit.us2px(t),y:this._context.mouse.relative.y},n={location:i,mouseTime:t},a=(0,u.c2)(this._context);a&&(n.placeholder={id:a.id});let s=(0,u.fW)(this._context);if(s&&(n.tierBlock={id:s.id}),(0,r.Xe)(this.targetSegment)){let e=this._context.valid.nearestSlotTransition(i);return e?(n.slot={id:e.id},n):n}let o=this._context.valid.isShowSpaceImmediately(n),l=this._context.valid.nearestSpace(i);l&&(n.space={id:l.id,position:l.position,isShowSpaceImmediately:o});let d=this._context.valid.landTrack(i);if(!d)return n;n.track={id:d.id};let c=this._context.registry.segment.findByTrack(d.id);return((this._context.store.allowNegtiveMouseTime||this._context.mouse.trElement&&this._context.mouse.trElement>0)&&(e=(0,u.tG)({zoom:this._context.store.zoom},c,t)),e)?(n.segment={id:e.segment.id,zone:e.zone,nZone:e.nZone},this._currentSitutation=n,n):n}reflexStartOperation(e){if(!e)return;let[t]=this._context.registry.track.findById(e.trackId);if(!t||0!==t.index)return;let i=this._context.registry.segment.findByTrack(t.id);i.sort(o.y_);let n=(0,d.An)(i,e.start,this._context.unit.us2px(e.duration),this._context.unit.zoom);this._context.uiUpdater.batchUpdateStyle(n),this._context.dirty.markDirty(n),this._context.uiUpdater.replaceHoverPlaceholderTrack(t,!0)}reflexInspect(e){let t=this._parseSituation(e);this._context.store.isMultiSelection?this._context.situation.dragMulti.reflexMultiInspect(e,t):(this._reflexSingleInspect(e,t),this._reflexSingleRelease(t))}reflexRelease(){this._reflexSingleRelease(void 0)}reflexExecute(e){try{"update"===this._context.store.dragType&&this._context.userConfig.trigger.unescapeSegment(),this._context.store.isMultiSelection?this._context.situation.dragMulti.reflexMultiExecute():this._context.store.isSingleSelection&&this._reflexSingleExecute(e)}catch(e){this._context.userConfig.trigger.catchError(e)}}_parseSituation(e){let t,i,n,r,a;return(0,s.IA)(e)&&([i]=this._context.registry.placeholder.findById(e.placeholder.id)),(0,s.Aj)(e)&&([t]=this._context.registry.tier.findById(e.tierBlock.id)),(0,s.AU)(e)&&([n]=this._context.registry.segment.findById(e.slot.id)),(0,s.d4)(e)&&([n]=this._context.registry.segment.findById(e.segment.id)),(0,s.Ui)(e)&&([r]=this._context.registry.track.findById(e.track.id)),(0,s.uS)(e)&&([a]=this._context.valid.findSpace(e.space.id,e.space.position)),{tierBlock:t,placeholder:i,segment:n,track:r,space:a}}_reflexSingleInspect(e,t,i){let{placeholder:n,tierBlock:o,segment:l,track:d,space:c}=t;if(!i){var u;if(this._context.uiUpdater.replaceHoverPlaceholderTrack(this._context.registry.track.entities,!1),this._context.dirty.executeClean(),this._context.valid.hideSpace(),(0,s.IA)(e)&&(0,a.RO)(n)){let e=this._reflexInspectPlaceholder(n);if(e?this._context.enclaveDrag.pass():this._context.enclaveDrag.unpass(),e)return}if((0,s.Aj)(e)&&(0,a.Q)(o)){let e=this._reflexInspectTierBlock(o);if(e?this._context.enclaveDrag.pass():this._context.enclaveDrag.unpass(),e)return}if((0,s.AU)(e)&&(0,r.Xe)(this.targetSegment)&&l&&this._reflexInspectSlot(l))return;if((0,s.d4)(e)&&d&&l){if(("middle"===e.segment.zone||"middle"===e.segment.nZone)&&"insert"===this._context.store.dragType){this._context.valid.hidePlaceholder();let e=this._reflexInspectSegmentMiddle(l);if(this._context.enclaveDrag.unpass(),e)return}if(0===d.index&&this._context.store.switches.inspectPlaceholder&&(this.reflexRelease(),this._reflexInspectSegmentReflow(d,l,e.segment.nZone)))return}if((0,s.Ui)(e)&&this._context.store.switches.inspectPlaceholder&&d&&(this.reflexRelease(),this._reflexInspectSegmentInsert(d,e,l)))return;this._context.valid.hidePlaceholder();let{isShowSpaceImmediately:i}=null!==(u=e.space)&&void 0!==u?u:{};if(!i){this._reflexSingleInspect(e,t,!0);return}}if((0,s.uS)(e)&&c&&this._reflexInspectSegmentSpace(c))return}_reflexSingleRelease(e){var t,i,n,r,a,s;let{prevSituation:o}=this._context.store;(null==e?void 0:null===(t=e.segment)||void 0===t?void 0:t.id)!==(null==o?void 0:null===(i=o.segment)||void 0===i?void 0:i.id)&&(null==o?void 0:o.segment)&&this._reflexReleaseSegment(o.segment),(null==e?void 0:null===(n=e.tierBlock)||void 0===n?void 0:n.id)!==(null==o?void 0:null===(r=o.tierBlock)||void 0===r?void 0:r.id)&&(null==o?void 0:o.tierBlock)&&this._reflexReleaseSegment(o.tierBlock),(null==e?void 0:null===(a=e.placeholder)||void 0===a?void 0:a.id)!==(null==o?void 0:null===(s=o.placeholder)||void 0===s?void 0:s.id)&&(null==o?void 0:o.placeholder)&&this._reflexReleaseSegment(o.placeholder),!(null==e?void 0:e.segment)&&!(null==e?void 0:e.tierBlock)&&this._context.enclaveDrag.unpass(),this._context.store.setPrevSituation(e)}_reflexSingleExecute(e){let{placeholder:t,tierBlock:i,segment:n,track:o,space:l}=this._parseSituation(e);if(this._context.uiUpdater.replaceHoverPlaceholderTrack(this._context.registry.track.entities,!1),this._context.dirty.executeClean(),this._context.valid.hideSpace(),(0,s.IA)(e)&&(0,a.RO)(t)&&this._reflexExecutePlaceholder(t)||(0,s.Aj)(e)&&(0,a.Q)(i)&&this._reflexExecuteTierBlock(i))return;if((0,s.AU)(e)){if((0,r.Xe)(this.targetSegment)&&n&&this._reflexExecuteSlot(n))return}else(0,r.Xe)(this.targetSegment)&&this._context.valid.showTips(null,null,s.jC.NoAvailableSlot);if(!((0,s.d4)(e)&&o&&n&&(("middle"===e.segment.zone||"middle"===e.segment.nZone)&&"insert"===this._context.store.dragType&&this._reflexExecuteSegmentMiddle(n)||0===o.index&&this._reflexExecuteSegmentReflow(o,n,e.segment.nZone))||(0,s.Ui)(e)&&o&&this._reflexExecuteSegmentInsert(o,e,n)))if(!this._stayTimer){if((0,s.uS)(e)&&l&&this._reflexExecuteSegmentSpace(l,e.mouseTime))return}else this._clearStayTimer()}_reflexInspectTierBlock(e){return!!this._context.store.message&&!!this.targetSegment&&!!(0,l.c)(e.availReplace,this.targetSegment)&&(e.handleReplaceHover(this._context.store.message,this.targetSegment),!0)}_reflexInspectPlaceholder(e){return!!this._context.store.message&&!!this.targetSegment&&!!(0,l.c)(e.availReplace,this.targetSegment)&&(e.handleReplaceHover(this._context.store.message,this.targetSegment),!0)}_reflexInspectSlot(e){if(!this._context.store.message||!this.targetSegment)return!1;let t="outer"===this._context.enclaveDrag.side,i=[e];t&&(i=this._context.registry.segment.findCanBeAddTransition());let r=[];for(let e of i){var a,s;let[t]=this._context.registry.track.findById(e.trackId);if(!t)return!1;let i=this._context.registry.segment.findByTrack(t.id);i.sort(o.y_);let[l,d]=(0,o.kf)(i,e),c=null!==(s=null===(a=e.transition)||void 0===a?void 0:a.duration)&&void 0!==s?s:h.pMA.min([h.pMA.times(n.u$,1e3,"bigint"),l&&d?h.pMA.div(h.pMA.min([l.duration,d.duration],"bigint"),2,"bigint"):h.pMA.div(this.targetSegment.duration,2,"bigint")],"bigint"),u=e.start+e.duration-h.pMA.div(c,2,"bigint")-1n;r.push({start:u,duration:c,track:t,segment:e})}!t&&this._context.valid.isMultiPlaceholder&&this._context.valid.removeMultiPlaceholder();let l=r.reduce((e,t)=>{let i=e.find(e=>e.track.id===t.track.id);return i?i.places.push({start:t.start,duration:t.duration,segment:t.segment}):e.push({track:t.track,places:[{start:t.start,duration:t.duration,segment:t.segment}]}),e},[]);return this._context.valid.showMultiPlaceholder(l,t?["style-placeholder-hide"]:[],t,(e,i,n)=>{var r,a,s,o;if(this._context.valid.restoreTransitionSlotIcon(),!n)return;e.setAttribute("data-id",null!==(a=null===(r=n.transition)||void 0===r?void 0:r.id)&&void 0!==a?a:""),t?e.classList.remove("style-placeholder-show"):this._context.valid.isInsideTransitionArea(l[0])?e.classList.add("style-placeholder-active"):e.classList.remove("style-placeholder-active");let d=e.querySelector(".segment-transition");d&&e.removeChild(d);let u=!!n.transition;u&&this._context.valid.clearTransitionSlotIcon(null!==(o=null===(s=n.transition)||void 0===s?void 0:s.id)&&void 0!==o?o:""),e.appendChild((0,c.n)(this._context.unit.us2px(i),u)),setTimeout(()=>{e.classList.add("style-placeholder-show")})}),!0}_reflexInspectSegmentMiddle(e){if(!this._context.store.message||!this.targetSegment)return!1;if((0,r.Xe)(this.targetSegment)){if((0,l.c)(e.availAttach,this.targetSegment))return e.handleAttachHover(this._context.store.message,this.targetSegment),!0}else if((0,l.c)(e.availReplace,this.targetSegment))return e.handleReplaceHover(this._context.store.message,this.targetSegment),!0;return!1}_reflexReleaseSegment(e){var t,i;if(!this.targetSegment)return!1;if((0,r.Xe)(this.targetSegment)){if((0,l.c)(e.availAttach,this.targetSegment))return null===(t=e.handleAttachBlur)||void 0===t||t.call(e,this._context.store.message,this.targetSegment),!0}else if((0,l.c)(e.availReplace,this.targetSegment))return null===(i=e.handleReplaceBlur)||void 0===i||i.call(e,this._context.store.message,this.targetSegment),!0;return!1}_reflexInspectSegmentReflow(e,t,i){let n;if(!this.targetSegment||!this._context.store.message||!this._context.store.dragType)return!1;let r=this._context.registry.segment.findByTrack(e.id),a=this._context.registry.transition.findByTrack(e.id);"rear"===i||"middle"===i?n=t.start+t.duration:{start:n}=t;let s=[];return s.push(...(0,d.An)(r,n,this._context.unit.us2px(this.targetSegment.duration),this._context.unit.zoom)),s.push(...(0,d.w7)(a,n,this._context.unit.us2px(this.targetSegment.duration),this._context.unit.zoom)),this._context.uiUpdater.batchUpdateStyle(s),this._context.valid.showPlaceholder(e,n,this.targetSegment.duration),this._context.dirty.markDirty(s),this._context.uiUpdater.replaceHoverPlaceholderTrack(e,!0),!0}_getMinorInsertStart(e,t,i){let n;if(!this.targetSegment)return 0n;let{mouseTime:r}=e;if((0,s.d4)(e)&&i)n=0n===r?0n:i.start+i.duration;else{var a,o;let e=-1,i=-1;for(let n=0;n<=t.length-1;n++){let s=t[n];if(s.id!==(null===(a=this.targetSegment)||void 0===a?void 0:a.id)){if(s.start+s.duration<=r&&(e=n),s.start>=r){i=n;break}}}let s=t[e],l=t[i];if(!l||r+this.targetSegment.duration<=l.start)n=r;else{let e=s?s.start+s.duration:0n,t=l.start;n=t-e-this.targetSegment.duration>=0?t-(null===(o=this.targetSegment)||void 0===o?void 0:o.duration):e}}return n}_reflexInspectSegmentInsert(e,t,i,n){if(!this.targetSegment||!this._context.store.message||!this._context.store.dragType)return!1;this._clearStayTimer(),!this._getIsCurrentTrackConflictActive(e)&&this._deactivateMovingConflictTrack(),n&&this._activateMovingConflictTrack(e);let r=this._context.registry.segment.findByTrack(e.id);if(0===e.index){let t=0n;r.length&&(t=r[r.length-1].start+r[r.length-1].duration),this._context.valid.showPlaceholder(e,t,this.targetSegment.duration)}else{let n=this._getMinorInsertStart(t,r,i),a=r.findIndex(e=>{var t;return e.start+e.duration>n&&e.id!==(null===(t=this.targetSegment)||void 0===t?void 0:t.id)}),s=r[a],o=void 0===s?-1n:n+this.targetSegment.duration-s.start;if(o>0){if(!this._getIsCurrentTrackConflictActive(e))return this._context.valid.hidePlaceholder(),this._createStayTimer(()=>{this._reflexInspectSegmentInsert(e,t,i,!0)}),!0;let a=(0,d.An)(r,n,this._context.unit.us2px(o),this._context.unit.zoom);this._context.dirty.markDirty(a),this._context.uiUpdater.batchUpdateStyle(a)}this._context.valid.showPlaceholder(e,n,this.targetSegment.duration)}return this._context.uiUpdater.replaceHoverPlaceholderTrack(e,!0),!0}_reflexInspectSegmentSpace(e){return this._context.valid.showSpace(e),!0}_reflexExecuteTierBlock(e){return!!this._context.store.message&&!!this.targetSegment&&!!(0,l.c)(e.availReplace,this.targetSegment)&&(e.handleReplace(this._context.store.message,this.targetSegment),!0)}_reflexExecutePlaceholder(e){return!!this._context.store.message&&!!this.targetSegment&&!!(0,l.c)(e.availReplace,this.targetSegment)&&(e.handleReplace(this._context.store.message,this.targetSegment),!0)}_reflexExecuteSlot(e){return!!this._context.store.message&&!!this.targetSegment&&!!(0,r.Xe)(this.targetSegment)&&!!this._context.registry.segment.findCanBeAddTransition().some(t=>t.id===e.id)&&(e.handleAttach(this._context.store.message,this.targetSegment),!0)}_reflexExecuteSegmentMiddle(e){if(!this._context.store.message||!this.targetSegment)return!1;if((0,r.Xe)(this.targetSegment)){if((0,l.c)(e.availAttach,this.targetSegment))return e.handleAttach(this._context.store.message,this.targetSegment),!0}else if((0,l.c)(e.availReplace,this.targetSegment))return e.handleReplace(this._context.store.message,this.targetSegment),!0;return!1}_reflexExecuteSegmentReflow(e,t,i){if(!this._context.store.message||!this._context.store.dragType)return!1;let n=t.start,r=void 0!==this._dragFrom&&t.start>=this._dragFrom.start?this._dragFrom.duration:0n;return("rear"===i||"middle"===i)&&(n+=t.duration),e.handleDrop(this._context.store.message,this.targetSegment,{start:n,dragType:this._context.store.dragType,uiPatch:r,index:e.index}),!0}_reflexExecuteSegmentInsert(e,t,i){if(!this._context.store.message||!this._context.store.dragType)return!1;let n=this._context.registry.segment.findByTrack(e.id);if(0===e.index){let t;let i=n.sort((e,t)=>h.pMA.minus(e.start,t.start)).pop(),r=void 0!==this._dragFrom?this._dragFrom.duration:0n;return t=i?i.start+i.duration+1n+r:r,e.handleDrop(this._context.store.message,this.targetSegment,{start:t,dragType:this._context.store.dragType,uiPatch:r,index:e.index}),!0}let r=this._getMinorInsertStart(t,n,i);return e.handleDrop(this._context.store.message,this.targetSegment,{start:r,dragType:this._context.store.dragType,index:e.index}),!0}_reflexExecuteSegmentSpace(e,t){if(!this._context.store.message||!this._context.store.dragType)return!1;let[i]=this._context.registry.track.findById(e.id);return!!i&&("before"===e.position?(i.handleDropBefore(this._context.store.message,this.targetSegment,{start:t,dragType:this._context.store.dragType,index:i.index}),!0):"after"===e.position&&(i.handleDropAfter(this._context.store.message,this.targetSegment,{start:t,dragType:this._context.store.dragType,index:i.index}),!0))}_createStayTimer(e){this._stayTimer=setTimeout(e,200)}_clearStayTimer(){this._stayTimer&&(clearTimeout(this._stayTimer),this._stayTimer=null)}_getIsCurrentTrackConflictActive(e){var t;return(null===(t=this._movingConflictActiveTrack)||void 0===t?void 0:t.id)===e.id}_activateMovingConflictTrack(e){this._movingConflictActiveTrack=e}_deactivateMovingConflictTrack(){this._movingConflictActiveTrack=null}constructor(e){this._context=e,this._stayTimer=null,this._movingConflictActiveTrack=null,this._currentSitutation=null}}},3752:function(e,t,i){i.d(t,{Z:function(){return a}});var n=i(650248),r=i(72127);let a=class e{appendTo(e){null==e||e.appendChild(this.$dom)}removeFrom(e){(0,r.LW)(this.$dom,"[LineReference#removeFrom] remove $dom")}move(e){let{x:t}=e;this.$dom.style.left=`${t+1}px`}constructor(e){var t=this;this.context=e,this.$dom=(0,r.V5)("div",["coordinate-line","style-vertical","style-reference"]),this.show=function(){let{x:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};void 0!==e&&(t.$dom.style.left=`${e+1}px`),t.$dom.classList.add("active")},this.hide=()=>{this.$dom.classList.remove("active"),this.$dom.style.left="0px"},this.tShow=(0,n.Z)(this.show,50),this.tHide=(0,n.Z)(this.hide,50)}}},604351:function(e,t,i){i.d(t,{d:()=>x});var n=i("789786"),r=i("230689"),a=i("193330"),s=i("690674");i("218571");var o=i("426336"),l=i("936154"),d=i("394267"),c=i("800788"),u=i("108692"),h=i("695324"),g=i("221242"),m=i("432092");function f(e){let t,{trackIndex:i,trackSection:n,message:r,segmentUI:a,dropPos:s,needInsert:l,draftView:u}=e,h={start:s.start,trackIndex:i,needInsertTargetTrack:l};if(0===i&&"before"===n&&"audio"===a.type){for(let e=u.getAllTracks().length-1;e>=0;e--)if(u.getAllTracks()[e].type!==o.pNd.TrackTypeAudio){h.trackIndex=e;break}}return("after"===n||"before"===n&&"audio"===a.type)&&(h.trackIndex+=1),"update"===s.dragType&&(h.start=s.uiPatch?o.pMA.minus(h.start,s.uiPatch,"bigint"):h.start),"insert"===s.dragType?t={...h,type:a.type,duration:a.duration}:((0,c.Y2)((0,d.h)(r)),t={segmentId:a.id,targetTrackIndex:h.trackIndex,targetStartTime:"number"==typeof s.uiPatch?o.pMA.plus(h.start,s.uiPatch,"bigint"):h.start,sourceTrackIndex:r.sourceTrackIndex,needInsertTargetTrack:h.needInsertTargetTrack,inMousePosition:!0,type:a.type,duration:a.duration}),t}function p(e){let{containerService:t,store:i,modules:n,optionsMaker:r,quickImportChecker:a,trackSection:o,needInsert:d}=e,{reporter:c,draftOperation:f,event:p}=n;return(e,c,v)=>{let{timelineSelectionStore:_}=i,{isEditingTemplate:S}=_;if(S)return;if(0!==v.index&&!a({...c,start:v.start},v.dragType)){v.dragType;return}let y=r({trackSection:o,message:e,segmentUI:c,dropPos:v,needInsert:d,draftView:n.draftOperation.dataSdk.draftView});if("insert"===v.dragType)f.segment.segmentAdd(e,y);else{(0,h.b)(t,{relatedEvent:h.Z.MoveMaterialSegment}),f.segment.segmentMove(y);let e=t.invokeFunction(e=>e.get(u.n)),n=e.dataSdk.draftView.getSegmentById(c.id);if(p.uiEvents.emit(m.W.SEGMENT_DRAG_END,e.dataSdk),n){let e=(0,l.q)(n);(0,g.H)(t,{...e,is_batch:0,absorb_status:i[s.U_].absorbStatus})}}}}var v=i("969167");class _{get _remainQuickImportSegments(){return this._store[s.U_].quickImportSegmentsSub}get _couldOperateQuickImportSegment(){var e=this;return function(){for(var t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];return(0,v.Jj)(e._remainQuickImportSegments,...i)}}handleDrop(e,t){let{_store:i,_modules:n,_containerService:r}=this;return p({containerService:r,store:i,modules:n,optionsMaker:e=>f({trackIndex:t,...e}),quickImportChecker:this._couldOperateQuickImportSegment,trackSection:"body",needInsert:"none"===e.type})}handleDropBefore(e,t){let{_store:i,_modules:n,_containerService:r}=this;return p({containerService:r,store:i,modules:n,optionsMaker:e=>f({trackIndex:t,...e}),quickImportChecker:this._couldOperateQuickImportSegment,trackSection:"before",needInsert:!0})}handleDropAfter(e,t){let{_store:i,_modules:n,_containerService:r}=this;return p({containerService:r,store:i,modules:n,optionsMaker:e=>f({trackIndex:t,...e}),quickImportChecker:this._couldOperateQuickImportSegment,trackSection:"after",needInsert:!0})}constructor(e,t,i){this._store=e,this._modules=t,this._containerService=i}}_=(0,n.gn)([(0,n.fM)(2,r.t),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",["undefined"==typeof TimelineManagerStore?Object:TimelineManagerStore,"undefined"==typeof TimelineManagerModules?Object:TimelineManagerModules,void 0===r.t?Object:r.t])],_);var S=i("333051"),y=i("244141");class x{get crop(){return this._cropController}get drop(){return this._dropController}get replace(){return this._replaceController}get avail(){return this._availController}get modules(){return this._modules}constructor(e,t,i){this._store=e,this._modules=t,this._containerService=i,this._cropController=this._containerService.createInstance(a.A,this._store,this._modules),this._dropController=this._containerService.createInstance(_,this._store,this._modules),this._replaceController=this._containerService.createInstance(S.k,this._store,this._modules),this._availController=this._containerService.createInstance(y.P,this._store)}}x=(0,n.gn)([(0,n.fM)(2,r.t),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",["undefined"==typeof TimelineManagerStore?Object:TimelineManagerStore,"undefined"==typeof TimelineManagerModules?Object:TimelineManagerModules,void 0===r.t?Object:r.t])],x)},713910:function(e,t,i){i.d(t,{s:function(){return n}});function n(e){class t extends e{hlEffect(e){this._hlEffects.push(e)}hlEffectEmit(){this._hlEffectDestructors.push(...this._hlEffects.map(e=>e()).filter(Boolean))}hlEffectDisposerEmit(){for(let e of this._hlEffectDestructors.reverse())null==e||e();this._hlEffectDestructors.splice(0,this._hlEffectDestructors.length)}constructor(...e){super(...e),this._hlEffects=[],this._hlEffectDestructors=[]}}return t.__MARK_DECO__=!0,t}},139367:function(e,t,i){i.d(t,{y:()=>r});var n=i("656494");let r={trackInfo:function(e){let{trackCO:t,controllerManager:i}=e,[n,r,a]=t.data.cTrack;return{id:n.id,index:r,type:n.trackType,availSegment:i.avail.getAvailSegment(n,r,a),availSegmentBefore:i.avail.getAvailSegmentBefore(n,r,a),availSegmentAfter:i.avail.getAvailSegmentAfter(n,r,a),handleDrop:i.drop.handleDrop(n,r),handleDropBefore:i.drop.handleDropBefore(n,r),handleDropAfter:i.drop.handleDropAfter(n,r),refEl:t.style}},segmentInfo:n.Xe,transitionInfo:n.ar,audioPlaceholderInfo:n.so}},99891:function(e,t,i){i.d(t,{c:function(){return h}});var n=i(276513),r=i(690674),a=i(426336),s=i(34044),o=i(796281),l=i(928261),d=i(959292),c=i(29188),u=i(140041);function h(e,t,i){let h;let{draftOperation:g,player:m,segmentManager:f}=t;return{cropHandlerBefore:()=>{g.setEnableTimelineRefresh(!0),f.emitCropEvent(o.x.BEFORE_HANDLE)},cropBefore:t=>{e[r.U_].setIsCroping(!0),e[r.VT].unionPlaying&&m.pause();let i=e[r.qk].segmentSelected[0];if(!(!i||(0,l.Xe)(i)))e[r.U_].setStashBeforeCrop({progress:e[r.U_].progress}),e[r.U_].setDecoupling({progress:!0}),f.emitCropEvent(o.x.START),g.setEnableTimelineRefresh(!1),g.segment.timelineStartExpandSegment("edge-front"===t?a.ZXd.ClipStart:a.ZXd.ClipDuration)},cropingSeek:(t,i)=>{e[r.U_].setIsCroping(!0);let n=e[r.qk].segmentSelected[0];if(!(!n||(0,l.Xe)(n))&&"audio"!==n.type){if(e[r.U_].setDecoupling({progress:!0}),t&&i){m.timelineSeekWithSpeed({timestamp:t.seekTime,leftLimit:t.leftLimit,rightLimit:t.rightLimit,durationSpeed:i.durationSpeed,pxSpeed:i.pxSpeed});let e=t.seekTime;e<=t.leftLimit?e=t.leftLimit+c.CZ:e>=t.rightLimit&&(e=t.rightLimit-c.CZ),h&&clearTimeout(h),h=setTimeout(()=>{m.timelineSeek(e,!1,d.H.seekDone)},u.Ad)}}},cropAfter:t=>{h&&clearTimeout(h);let a=e[r.qk].segmentSelected[0];if(!a||(0,l.Xe)(a)){e[r.U_].setIsCroping(!1);return}(0,s.M)(i,{seek_type:"slide",duration:Date.now()-(t||0)});let{progress:c=0n}=e[r.U_].stashBeforeCrop;m.flushSeekCmd(),m.timelineSeek(c,!1,d.H.seekDone);let u=m.onPlayProgressChange((0,n.Z)(()=>{null==u||u.dispose(),e[r.U_].setDecoupling({progress:!1}),m.refreshTimelineProgress()},400));setTimeout(()=>{e[r.U_].setIsCroping(!1)},400),f.emitCropEvent(o.x.END)}}}},53927:function(e,t,i){i.d(t,{s:function(){return c}});var n=i(108692),r=i(690674),a=i(112825),s=i(371140),o=i(394236),l=i(422404),d=i(426336);function c(e,t,i){let{draftOperation:c,player:u}=t,h="";async function g(e,t){!h&&(h=c.batchStart()),await Promise.all(e.keyframes_infos[0].keyframe_details.map(i=>c.keyframe.updateCommonKeyframe({segId:e.seg_id,keyframeId:i.id,keyframeType:i.type,dataParam:(0,d.TIP)({flags:BigInt(d.yPX.KFDataParamFlag_playHead),playHead:t})})))}return{cancelKeyframeSelect:()=>{c.keyframe.setKeyframeSelectInfo(void 0)},keyframeContextMenuOpen:()=>{let e={contextmenuMode:l.D.KEYFRAME,data:{}};t.coordinate.context.event.emit(a.B.contextmenuVisible,!0,e)},keyframeSelect:(t,i,n)=>{e[r.VT].unionPlaying&&u.pause(),n&&(e[r.U_].setPreviewLineStatus(s.$o.DISABLE),u.timelineSeek(i,!1)),c.keyframe.setKeyframeSelectInfo(t)},dragKeyframeUpdate:g,dragKeyframeEnd:async(e,t)=>{await g(e,t),c.keyframe.setKeyframeSelectInfo(e);let r=i.invokeFunction(e=>e.get(n.n)).dataSdk.draftView.getSegmentById(e.seg_id);r&&(0,o.Y)(i,r,e,"drag","click"),h&&(c.batchEnd(h),h="")}}}},136498:function(e,t,i){i.d(t,{VV:function(){return g},pP:function(){return c},tA:function(){return h},t_:function(){return m},yG:function(){return u}});var n=i(373722),r=i(345299),a=i(800788),s=i(690674),o=i(426336),l=i(248222),d=i(173828);function c(e,t){let i=null,n=-1,r=null;return e.forEach(e=>{let[a]=e,{segments:s}=a;s.forEach((e,s)=>{e.id===t&&(i=e,n=s,r=a.id)})}),{segment:i,index:n,trackId:r}}function u(e,t){for(let i=0;i<e.length;i++){let[r]=e[i];if(r.id===t)return{track:(0,n.Z)(r,["segments"]),index:i}}return null}function h(e,t){return e?t?r.P.UPDATE:r.P.DELETE:((0,a.Y2)(t,"next state should exist"),r.P.ADD)}function g(e,t){for(let i of t.draftView.getAllTracks()){let{segments:t}=i;for(let n=0;n<t.length;n++)if(t[n].id===e)return{segment:t[n],index:n,trackId:i.id}}}function m(e,t){let i,{segmentId:n,notifySegmentOperation:c,subDraftId:u,collectionMap:g,draftView:m}=e,{dataSdk:f,store:p}=t,{segment:v}=g,_=f.cutSame.getMutableBySegmentId(n,u),{segment:S,index:y}=function(e,t){for(let i=0;i<e.length;i++){let[n]=e[i],{segments:r}=n;for(let e=0;e<r.length;e++){let i=r[e],{type:a}=i;if("mutablePoly"===a){let{children:r}=i.mutable;if(r&&r.find(e=>e.id===t))return{segment:i,trackId:n.id,index:e}}else if(i.id===t)return{segment:i,trackId:n.id,index:e}}}return{segment:null,trackId:null,index:-1}}(p[s.U_].tracksMutable,n);if(_){let e=f.cutSame.getMutableVideoIndexById(_.id);if((0,o.OvQ)(_)||(0,o.VIL)(_)){let t;t=m?(0,l.k7)(_,{needComputeSpeed:!0,draftView:m}):(0,l.k7)(_,{needComputeSpeed:!1,draftView:null});let s=u?f.cutSame.getSegmentByDraftId(u):void 0;if((null==s?void 0:s.sourceTimerange)&&(t.start-=s.sourceTimerange.start),S&&"mutablePoly"===S.type){(0,a.Y2)(S.mutable);let e=S.mutable.children.findIndex(e=>e.id===n);if(-1!==e){let n;let s=v.find(e=>{var t;return(null===(t=e.prevValue)||void 0===t?void 0:t.id)===S.id});s?((0,a.Y2)(s.nextValue),n=s.nextValue):n={...S,mutable:{...S.mutable}};let o=[...n.mutable.children];o[e]=t,n.mutable.children=o,!s&&(i={type:r.P.UPDATE,prevValue:S,nextValue:n,prevIndex:y,prevTrackId:d.pq,nextIndex:y,nextTrackId:d.pq,notifyOperationList:c})}}else{let n=t,s=(0,o.OvQ)(_)?d.pq:d.Q5,l=h(S,n);switch(l){case r.P.ADD:(0,a.Y2)(n),i={type:l,prevValue:null,nextValue:n,prevIndex:-1,nextIndex:e,prevTrackId:null,nextTrackId:s,notifyOperationList:c};break;case r.P.DELETE:(0,a.Y2)(S),i={type:l,prevValue:S,nextValue:null,prevIndex:y,nextIndex:-1,prevTrackId:s,nextTrackId:null,notifyOperationList:c};break;case r.P.UPDATE:(0,a.Y2)(S),(0,a.Y2)(n),i={type:l,prevValue:S,nextValue:n,prevIndex:y,nextIndex:e,prevTrackId:s,nextTrackId:s,notifyOperationList:c};break;default:(0,a.bP)(l)}}}}else S&&"mutableAudio"===S.type&&(i={type:r.P.DELETE,prevValue:S,prevTrackId:d.Q5,prevIndex:y,nextIndex:-1,nextValue:null,nextTrackId:null,notifyOperationList:c});return i}},140599:function(e,t,i){i.d(t,{M:function(){return n}});function n(e,t,i){return!!i.preload.mutableAudios.find(i=>i.id===e&&i.material_name===t)}},821915:function(e,t,i){i.d(t,{Y:function(){return l}});var n=i(857670),r=i(724081),a=i(426336),s=i(800788),o=i(345685);class l{addBeat(e,t,i){var n,r,o;let l=this._dataSdk.draftView.getSegmentById(e);(0,s.Y2)(l&&(0,a.Y9Q)(l)),this._dataSdk.api.audio.addBeat({segmentId:e,addedBeats:t,gear:null===(n=l.beat)||void 0===n?void 0:n.gear,gearCount:null===(r=l.beat)||void 0===r?void 0:r.gearCount,mode:null===(o=l.beat)||void 0===o?void 0:o.mode,beatSpeedInfos:[]})}onEnableBeatsDetection(e){}removeAllBeats(e){(0,o.u)(this._containerService,{method:"right_click_menu",is_auto:0,action:"delete_all"}),this._dataSdk.api.audio.removeBeat({segmentId:e,removeAllBeats:!0,removeAiBeats:!0,removedBeats:[]})}removeBeat(e,t,i,n){if(n){let e=null==n?void 0:n.isAutoBeat;void 0===e&&(e=!t.some(e=>{var t,n;return null===(n=i.audio)||void 0===n?void 0:null===(t=n.userAddBeats)||void 0===t?void 0:t.includes(e)})),(0,o.u)(this._containerService,{method:n.from,is_auto:e?1:0,action:"delete"})}this._dataSdk.api.audio.removeBeat({segmentId:e,removeAllBeats:!1,removeAiBeats:!1,removedBeats:t})}removeDuplicatedAiBeatsWithManual(e){}toggleAudioManualBeat(e,t){var i;let{id:s,sourceTimeRange:o={start:0n,duration:0n},start:l,speed:d=1,duration:c}=null!==(i=null==e?void 0:e[0])&&void 0!==i?i:{},u=this.getAllBeats(s,d,o.start,l,c),h=(0,r.mQ)({progress:t,sourceStart:o.start,targetStart:l,speed:d}),g=u.find(e=>e.formatFrame===Math.round(a.pMA.div(t,n.G8)));return void 0!==g?this.removeBeat(s,[g.originBeat],e[0],{from:"time_line"}):this.addBeat(s,[h],{from:"time_line",isAutoBeat:!1})}updateBeat(e,t,i){let{id:n,speed:r,start:a,sourceTimeRange:s,duration:o}=e,l=this.getAllBeats(n,r,null==s?void 0:s.start,a,o),d=i.formatFrame,c=l.filter(e=>e.formatFrame===d).map(e=>e.originBeat);c.push(t.originBeat);let u=this._dataSdk.api.batch.batchStart(!0);this.removeBeat(n,c,e),this.addBeat(n,[i.originBeat]),this._dataSdk.api.batch.batchEnd(u)}getAllBeats(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0n,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0n,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0n;return this._dataSdk.draftView.getAllAudioBeats(e).map(e=>{let s=(0,n.Wl)(e,t,i,r,a);return{originBeat:e,formatFrame:s}})}getAudioBeatsMap(e){let t=new Map,{id:i,sourceTimeRange:n,speed:r,start:a,duration:s}=e;return i?(this.getAllBeats(i,r,null==n?void 0:n.start,a,s).forEach(e=>{t.set(e.originBeat,e)}),t):t}constructor(e,t){this._dataSdk=e,this._containerService=t}}},394236:function(e,t,i){i.d(t,{Y:function(){return l}});var n=i(860660),r=i(341079),a=i(288154),s=i(426336),o=i(194488);function l(e,t,i,l,d){let{keyframes_infos:c}=i||{},u=(0,n.p8)(t);try{let t=(0,o.Z)(c.reduce((e,t)=>e.concat(t.keyframe_types),[])),i=function(e){let t=e.map(e=>{var t;return null!==(t=r.pW[e])&&void 0!==t?t:{}});return{function_category:t.map(e=>(null==e?void 0:e.function_category)||"none").join(","),function_subcategory:t.map(e=>(null==e?void 0:e.function_subcategory)||"none").join(","),control_type:t.map(e=>(null==e?void 0:e.control_type)||"none").join(",")}}(t);(0,a.P)(e,{...u,...i,action_type:null!=d?d:"click",option_type:l,keyframe_cnt:c.reduce((e,t)=>e.concat(t.keyframe_details.filter(e=>e.type!==s.Eu.KFTypePositionY)),[]).length})}catch(e){console.error(e)}}},521369:function(e,t,i){i.d(t,{L:function(){return d}});var n=i(402655),r=i(800788),a=i(827084),s=i(345299),o=i(425427);class l extends n.JT{register(){this._register(this._draftDataSyncer.onDataDiff(this._handleDataDiff.bind(this))),this._register(this._draftDataSyncer.onFullTracksChange(this._handleFullTrackChange.bind(this))),this._register(this._draftDataSyncer.onFullTracksMutableChange(this._handleFullTracksMutableChange.bind(this)))}_uiSegment2Params(e){var t;let i=(0,o.JY)(this._environmentService)?this._environmentService.currentTemplateId:null,n=null!==(t=e.templateId)&&void 0!==t?t:i;return{segment:e,templateResourceKey:n&&(0,a.Bc)(n)}}_buildResource(e,t){null==t||t.forEach(t=>{let[i]=t;i.segments.forEach(t=>{this._resource[e](this._uiSegment2Params(t))})})}_handleDataDiff(e){e[s.A.SEGMENT].forEach(e=>{e.type===s.P.ADD?this._resource.observe(this._uiSegment2Params(e.nextValue)):e.type===s.P.DELETE?this._resource.disconnect(this._uiSegment2Params(e.prevValue)):e.type===s.P.UPDATE?(this._resource.disconnect(this._uiSegment2Params(e.prevValue)),this._resource.observe(this._uiSegment2Params(e.nextValue))):(0,r.bP)(e)})}_handleFullTrackChange(e,t){this._buildResource("disconnect",t),this._buildResource("observe",e)}_handleFullTracksMutableChange(e,t,i){this._buildResource("disconnect",t),this._buildResource("observe",e)}constructor(e,t,i){super(),this._resource=e,this._draftDataSyncer=t,this._environmentService=i}}function d(e,t,i){let n=new l(e,t,i);return n.register(),n}},895955:function(e,t,i){i.d(t,{I:function(){return r},s:function(){return n}});let n=3e3,r=20},840441:function(e,t,i){i.d(t,{o:function(){return s}});var n=i(789786),r=i(484719),a=i(210823);class s{siderActiveTabSet(e,t){let i=this._workbenchService.getActiveSideMenConfig(),n=(null==i?void 0:i.name)!==e;t?this._workbenchService.activeSiderMenuByName(e,"auto",{extraParams:{panel:t}}):this._workbenchService.activeSiderMenuByName(e,"auto"),n&&this._workbenchService.highlightSiderMenu()}highlightSiderMenu(){this._workbenchService.highlightSiderMenu()}async getTransitionList(e){let{limit:t}=e,i=await this._transitionDataService.getTransition({category:"all",limit:t});if(!i.ok)return[];let{list:n}=i.value.value;return n}constructor(e,t){this._workbenchService=e,this._transitionDataService=t}}s=(0,n.gn)([(0,n.fM)(0,a.e),(0,n.fM)(1,r.T),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===a.e?Object:a.e,void 0===r.T?Object:r.T])],s)},28460:function(e,t,i){i.d(t,{q:function(){return r}});var n=i(260963);class r{get hasKeyframeSelect(){var e;return!!(null===(e=this.keyframeSelectInfo)||void 0===e?void 0:e.keyframes_infos.length)}setKeyframeSelectInfo(e){this.keyframeSelectInfo=e}setKeyframeCopyCacheSegment(e){this.keyframeCopyCacheSegment=e}setCacheKeyframeSelectInfo(e){this.cacheKeyframeSelectInfo=e}constructor(){this.keyframeSelectInfo=void 0,this.keyframeCopyCacheSegment=void 0,this.cacheKeyframeSelectInfo=void 0,(0,n.ky)(this)}}},332097:function(e,t,i){i.d(t,{L:function(){return a}});var n=i(260963),r=i(771255);class a{get uploadMaterialCounts(){return Object.values(this.mutableUploadMaterialMap).reduce((e,t)=>({uploading:Number(r.g.UPLOADING),uploaded:e.uploaded+Number(t.status>r.g.UPLOADING),filled:e.filled+Number(t.status>r.g.REPLACING)}),{uploading:0,uploaded:0,filled:0})}get batchReplaceStatus(){let{uploading:e,uploaded:t,filled:i}=this.uploadMaterialCounts;switch(!0){case e+t+i===0:return r.g.IDLE;case i<t+e:return r.g.UPLOADING;case i>=e+t:return r.g.SUCCESS;default:return r.g.IDLE}}setTemplateInfo(e,t){this.templateIdToInfo[e]=t}setCover(e,t){this.covers[e]=t}setSprites(e,t){this.sprites[e]=t}setWaves(e,t){this.waves[e]=t}setDefaultSprite(e){this.defaultSprite=e}setDefaultCover(e){this.defaultCover=e}setMutableUploadMaterial(e,t){"string"==typeof e&&(e=[e]);let i={...this.mutableUploadMaterialMap};for(let n of e){let e=i[n]||{};i[n]={...e,...t}}return i}setFailSegments(e){this.failSegments=e}constructor(){this.templateIdToInfo={},this.covers={},this.sprites={},this.waves={},this.defaultSprite=void 0,this.defaultCover=void 0,this.failSegments=new Set,this.mutableUploadMaterialMap={},(0,n.ky)(this)}}},371140:function(e,t,i){i.d(t,{$o:function(){return a},AR:function(){return s}});var n,r,a=((n={})[n.ENABLE=0]="ENABLE",n[n.DISABLE=1]="DISABLE",n);var s=((r={})[r.poly=0]="poly",r[r.child=1]="child",r[r.flat=2]="flat",r[r.element=3]="element",r)},67801:function(e,t,i){i.d(t,{B:function(){return l},D:function(){return d}});var n=i(907031),r=i(969242),a=i(801497),s=i(464533),o=i(72127);function l(e,t,i){let a=Math.max(i,n.Xy)/t;return(0,r.Fl)(e,a)}function d(e){var t,i,n;if(!e||!e.length)return 1/0;let l=null,d=null;for(let t of e){if(!!(t.mutable&&!t.mutable.locked))"mutable"===t.type&&(!l||l.duration>t.duration)&&(l=t),"mutablePoly"===t.type&&(!d||d.duration>t.duration)&&(d=t)}if(!l&&!d)return 1/0;let c=l?a.ZP.t("web_replace",{},"Replace"):"",u=d?a.ZP.t("web_add_3_videos",{placeholder0:null===(t=d.mutable)||void 0===t?void 0:t.children.length},"Add {placeholder0} videos"):"",h=s.B4+(0,o.YK)(c),g=s.B4+(0,o.YK)(u),m=(0,r.Fl)(null!==(i=null==l?void 0:l.duration)&&void 0!==i?i:BigInt(Number.MAX_SAFE_INTEGER),h);return Math.min(m,(0,r.Fl)(null!==(n=null==d?void 0:d.duration)&&void 0!==n?n:BigInt(Number.MAX_SAFE_INTEGER),g))}},146114:function(e,t,i){i.d(t,{_:function(){return r}});var n=i(426336);let r=(e,t)=>{switch(e){case"mutablePoly":case"mutable":return t===n.cVg.MetaTypePhoto||t===n.cVg.MetaTypeVideo;case"mutableAudio":return t===n.cVg.MetaTypeMusic;default:return!1}}},858151:function(e,t,i){i.d(t,{EK:function(){return _},Lo:function(){return b},MZ:function(){return M},Oh:function(){return y},WB:function(){return p},gG:function(){return g},hZ:function(){return T},pu:function(){return x},ql:function(){return f},sH:function(){return c},ww:function(){return h}});var n=i(804497),r=i(426336),a=i(404172),s=i(29188);let o=BigInt(Number.MAX_SAFE_INTEGER),l="Placeholder-track";function d(e){e.sort((e,t)=>r.pMA.minus(e.start,t.start))}function c(e){return e.startsWith(l)}let u=0;function h(e){var t;return{id:`${l}-${u++}`,type:e,trackType:["combination","mutable","mutableAudio","dragVideoPlaceholder","dragAudioPlaceholder"].includes(t=e)?r.pNd.TrackTypeNone:t,segments:[]}}function g(e,t,i){let{trackIndex:n}=i,r=h(t);for(e.splice(n,0,[r,n]),++n;n<e.length;++n)++e[n][1]}function m(e){d(e),e.length&&0n!==e[0].start&&(e[0].start=0n);let t=0n;for(let i of e){i.start!==t&&(i.start=t),t+=i.duration;let e=i.slots.find(e=>"transition"===e.type);(null==e?void 0:e.isOverlap)&&(t-=e.duration)}}function f(e,t){let i=[],{type:n,segment:r,trackIndex:a,clipTime:s}=t,o=e.findIndex(e=>e.id===r.id);if(o<0)return i;let l=0n,d=-1,c=-1;if("start"===n&&o>0){let{start:t,duration:i}=e[o-1];l=t+i-s,d=0,c=o-1}else if("duration"===n&&o<e.length-1){let{start:t}=e[o+1];l=s-t,d=o+1,c=e.length-1}if(l>0&&d>=0&&c>=0){let t="start"===n?-l:l;for(let n=d;n<=c;n++){let r=e[n],s=r.start+t;if(s<0)break;i.push({segmentId:r.id,needInsertTargetTrack:!1,isEmptyTrack:!1,targetTrackIndex:a,sourceTrackIndex:a,targetStartTime:s,type:r.type,duration:r.duration})}}return i}function p(e,t){(null==t?void 0:t.length)?t.forEach(t=>{!function(e,t){if(!t)return;m(e);let i=t.start,n=e.findIndex(e=>{let t=e.slots.find(e=>"transition"===e.type),n=(null==t?void 0:t.isOverlap)?t.duration:0n;return e.start+e.duration-n>i}),a=n;if(("video"===t.type||"combination"===t.type)&&n>=0){let{start:s,duration:o}=e[n],l=s+o;if(i<(s+l)/2n){let i=n>0?e[n-1]:null,o=i?i.start+i.duration:0;a=n,t.start=r.pMA.max([s-t.duration,o],"bigint")}else a=n+1,t.start=l}-1===a&&(a=e.length);let s=t.slots.find(e=>"transition"===e.type);for(let i=a;i<e.length;++i)e[i].start+=t.duration+-((null==s?void 0:s.isOverlap)?s.duration:0n);e.splice(a,0,t),m(e)}(e,t)}):m(e)}function v(e,t,i){let n;return i?n=function(e,t){let i;let{type:n,segment:r,segmentIndex:a}=t;if("start"===n&&a>0){let{start:t,duration:n}=e[a-1],s=t+n-r.start;if(s>0){for(let t=0;t<=a-1;t++)e[t].start-=s;i=!0}}else if("duration"===n&&a<e.length-1){let{start:t}=e[a+1],n=r.start+r.duration-t;if(n>0){for(let t=a+1;t<=e.length-1;t++)e[t].start+=n;i=!0}}return i}(e,i):(t.forEach(t=>{(function(e,t){let{start:i,duration:n,id:r}=t,a=e.findIndex(e=>e.start+e.duration>i&&e.id!==r),s=e[a];if(!s)return!1;let o=i+n-s.start;if(o<=0)return!1;for(let t=a;t<=e.length-1;t++)e[t].start+=o;return!0})(e,t)&&(n=!0);let i=t.slots.findIndex(e=>"transition"===e.type);i>-1&&t.slots.splice(i,1),e.push(t)}),e.sort((e,t)=>r.pMA.minus(e.start,t.start))),n}function _(e,t,i){let r=function(e,t){let i=!1;for(let r of t){let t=(0,n.kt)(e,{id:r.segmentId}),a=null==t?void 0:t.slots.findIndex(e=>e.id===r.id);if(void 0!==a&&-1!==a&&!!t)t.slots.splice(a,1),i=!0}return i}(e,i),a=function(e,t){let i=t.map(e=>e.id),r=!1;for(let t of e){let e=0;for(let a of t[0].segments)i.includes(a.id)&&(t[0].segments.splice(e,1).pop(),(0,n.qU)(t)&&(r=!0)),++e}return r}(e,t);(r||a)&&p(e[0][0].segments)}function S(e,t){d(e);let i=e.findIndex(e=>e.id===t.id);if(-1===i)return;let n=e[i],a=e[i-1],s=i+1>=e.length?void 0:e[i+1];if(a){let e=a.slots.find(e=>"transition"===e.type);if(e){let t=r.pMA.min([a.duration,n.duration],"bigint")/2n;e.duration>t&&(e.duration=t)}}let o=n.slots.findIndex(e=>"transition"===e.type);if(o>-1){if(s){let e=r.pMA.min([n.duration,s.duration],"bigint")/2n;n.slots[o].duration>e&&(n.slots[o].duration=e)}else n.slots.splice(o,1)}}function y(e){let t=-1,i=!1;for(let[n,r]of e)if("video"===n.type?i=!0:"none"===n.type&&(t=r),t>-1&&i)break;if(t>-1&&i)for(e.splice(t,1);t<e.length;++t)--e[t][1];let n=[],r=[];for(let[t,i]of e)"video"===t.type||"none"===t.type?0!==i&&!t.segments.length&&n.push(i):!t.segments.length&&r.push(i);for(n.push(...r),n.sort((e,t)=>e-t);n.length;)e.splice(n.pop(),1);for(let t=0;t<e.length;++t)e[t][1]=t}function x(e,t,i){let n=!1;if(i.needInsertTargetTrack){let n=(0,a.t)(t.type);n&&g(e,n,i)}let r=e[i.trackIndex];if(0===i.trackIndex)p(r[0].segments,[{...t,start:BigInt(i.start)}]),S(r[0].segments,t),m(r[0].segments);else if(null==r?void 0:r[0]){var s;n=null!==(s=v(r[0].segments,[{...t,start:BigInt(i.start)}]))&&void 0!==s&&s}return y(e),n}function b(e,t){for(let[i,n]of e)if(i.segments.some(e=>e.id===t.id))return n;return -1}function M(e,t,i){let{type:n,value:a}=i;d(e);let l=e.findIndex(e=>e.id===t.id);if(-1===l)return;let c=e[l];if(c.prolong){if("start"===n){let i;i=c.prolong.total===o?-1/0:c.start-c.prolong.start;let n=c.start+c.duration,s=r.pMA.min([n,r.pMA.max([i,a],"bigint")],"bigint"),l=c.duration+(c.start-s),d=c.prolong.start+s-c.start,u=c.prolong.duration+(c.prolong.start-d);c.prolong.total===o&&0n!==d&&(u=0n,d=0n),c.duration=l,c.prolong.start=d,c.prolong.duration=u,S(e,t),p(e)}else if("duration"===n){let i;let n=c.start+s.CZ,l=c.prolong.total-c.prolong.start+c.start,d=r.pMA.max([n,r.pMA.min([l,a],"bigint")],"bigint")-c.start;i=c.prolong.total===o?d:c.prolong.duration+d-c.duration,c.duration=d,c.prolong.duration=i,S(e,t),p(e)}}}function T(e,t,i){let{type:n,value:a}=i;d(e);let l=e.findIndex(e=>e.id===t.id);if(-1===l)return;let c=e[l];if(c.prolong){if("start"===n){let t=l>0?e[l-1].start+e[l-1].duration-e[0].start:0n;c.prolong.total!==o&&(t=r.pMA.max([t,c.start-c.prolong.start],"bigint"));let i=c.start+c.duration,s=r.pMA.min([i,r.pMA.max([t,a],"bigint")],"bigint"),d=c.duration+(c.start-s),u=c.prolong.start+(s-c.start),h=c.prolong.duration+(c.prolong.start-u);c.prolong.total===o&&0n!==u&&(h=0n,u=0n),c.start=s,c.duration=d,c.prolong.start=u,c.prolong.duration=h,v(e,[],{type:n,segment:c,segmentIndex:l})}else if("duration"===n){let t;let i=c.start+s.CZ,d=c.prolong.total-c.prolong.start+c.start,u=r.pMA.max([i,r.pMA.min([d,a],"bigint")],"bigint")-c.start;t=c.prolong.total===o?u:c.duration+u-c.prolong.duration,c.duration=t,c.prolong.duration=u,v(e,[],{type:n,segment:c,segmentIndex:l})}}}},265409:function(e,t,i){i.d(t,{DM:function(){return s},Fh:function(){return r},hC:function(){return d},wf:function(){return o}});var n,r=((n={}).TOTAL_SPEND="total_spend",n.GENERATE_COLLECTION_MAP="generate_collection_map",n.SYNC_FROM_DATA_SDK="sync_from_data_sdk",n.SYNC_FROM_TRANSIENT_DATA="sync_from_transient_data",n.RENDERER_UPDATE="renderer_update",n.COORDINATE_UPDATE="coordinate_update",n.RESOURCE_UPDATE="resource_update",n);let a=new Map;function s(e){a.set(e,Date.now())}function o(e){let t=a.get(e);a.delete(e),t&&console.log(`\u{300C}timeline-performance\u{300D}: ${e}`,Date.now()-t)}let l=new Map;function d(e){var t;let i=null!==(t=l.get(e))&&void 0!==t?t:0;l.set(e,i+1)}window&&(window.printResourceRenderCount=()=>{var e;console.log("\u300CprintResourceRenderCount\u300D: ",null!==(e=l.get("resource_update"))&&void 0!==e?e:0)})},823404:function(e,t,i){i.d(t,{AU:function(){return r},C0:function(){return o},Mo:function(){return s},Vo:function(){return a}});var n=i(354267);function r(e){return e.startsWith(n.Jy)||e.startsWith(n.k)||e.startsWith(n.dw)||e.startsWith(n.VF)}function a(e){return e.startsWith(n.k)}function s(e){return e.startsWith(n.dw)}function o(e){return e.startsWith(n.Jy)}},65967:function(e,t,i){i.d(t,{L9:function(){return h},NH:function(){return c},NU:function(){return g},Tt:function(){return o},_Y:function(){return f},bS:function(){return v},c2:function(){return y},e4:function(){return u},fH:function(){return d},fW:function(){return x},i:function(){return m},o:function(){return l},pr:function(){return p},tG:function(){return S}});var n=i(140041),r=i(969242),a=i(426336),s=i(632555);function o(e,t){let i=t.find(t=>(0,s.mK)(t.start+t.duration,[e.start,e.start+e.duration]));return[i,t.find(t=>(0,s.mK)(t.start,[e.start,e.start+e.duration]))]}function l(e,t,i){let n=!(arguments.length>3)||void 0===arguments[3]||arguments[3],r=i+e.duration;return!t.some(t=>(!n||t.id!==e.id)&&(i>t.start&&i<t.start+t.duration||r>t.start&&r<t.start+t.duration||i<=t.start&&t.start+t.duration<=r))}function d(e,t){let i=!(arguments.length>2)||void 0===arguments[2]||arguments[2];for(let n of t)if(!l({id:n.id,duration:n.duration},e,n.start,i))return!1;return!0}function c(e,t){return!!e.length&&(t.y<e[0].startY||t.y>e[e.length-1].endY)}function u(e,t,i){var n;let r,a;if(!i)return[];let s=null!==(n=i.style.height)&&void 0!==n?n:0;e.sort((e,t)=>e.startY-t.startY);for(let i=0;i<=e.length-1;i++){let n=e[i];if(n.startY<=t.y&&(r=n,n.endY>t.y+s)){r=i>0?e[i-1]:null,a=i<e.length-1?e[i+1]:null;break}if(n.endY>t.y+s){a=n;break}}return[r,a]}function h(e,t){let[i,n,r,a]=e,[s,o,l,d]=t;return i<s+l&&i+r>s&&n<o+d&&n+a>o}function g(e,t){return e.find(e=>e.startY<=t.y&&e.endY>=t.y)}function m(e,t){let i,n;if(!e.length)return;let r=e.find(e=>e.startY<=t.y&&e.endY>=t.y);if(r)return r;for(let r of e)r.startY>t.y?(!n||n.startY>r.startY)&&(n=r):r.endY<t.y&&(!i||i.endY<r.endY)&&(i=r);if(!i&&!n)return;if(!i)return n;if(!n)return i;let a=(n.startY+i.endY)/2;return t.y>a?n:i}function f(e,t){let i;let n=1/0;for(let r of e){let e=Math.sqrt((t.x-r.centerX)**2+(t.y-r.centerY)**2);e<n&&(n=e,i=r)}return i}function p(e,t){let i;let n=1/0;for(let r of e){let e=Math.sqrt((t.x-r.endX)**2+(t.y-r.endY)**2);e<n&&(n=e,i=r)}return i}function v(e,t){let i=t.find(t=>(0,s.mK)(t.start+t.duration,[e.start,e.start+e.duration]));return[i,t.find(t=>(0,s.mK)(t.start,[e.start,e.start+e.duration]))]}function _(e,t,i){let{main:s,edge:o}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},{start:l}=t,d=t.start+t.duration;if(void 0!==o){if(i<=l+o)return"edge-front";if(d-o<=i)return"edge-rear"}if("mutable"===t.registeredType||"mutableAudio"===t.registeredType||"mutableAudioPlaceHolder"===t.registeredType)return"middle";if(!s)return i>a.pMA.div(d,2,"bigint")?"rear":"front";if(n.Gg>0)return(0,r.vY)(e.zoom,i-l)<=n.Gg?"front":(0,r.vY)(e.zoom,d-i)<=n.Gg?"rear":"middle";{let e=a.pMA.times(n.eP,t.duration,"bigint"),r=d-e;return i<l+e?"front":i>r?"rear":"middle"}}function S(e,t,i){let n=t.find(e=>e.start<=i&&e.start+e.duration>=i);if(!!n)return{segment:n,zone:_(e,n,i),nZone:_(e,n,i,{main:!0})}}function y(e){return e.registry.placeholder.lbs(e.mouse.fixed)}function x(e){return e.registry.tier.lbs(e.mouse.fixed)}},153302:function(e,t,i){i.d(t,{V:function(){return a},X:function(){return s}});var n=i(426336),r=i(68659);function a(e,t){let i;let a=[...e];if((null==t?void 0:t.reverse)&&(a=a.reverse()),t.prolong){if(t.prolong.total===r.E2||t.prolong.total===BigInt(0))i=[...a];else{let e=n.pMA.div(t.prolong.start,t.prolong.total),r=n.pMA.div(t.prolong.duration,t.prolong.total),s=Math.floor(n.pMA.times(e,a.length));s>=a.length-1&&(s=a.length-1);let o=Math.ceil(n.pMA.times(r,a.length));o<1&&(o=1),i=a.slice(s,s+o)}}else i=[...a];return i}function s(e,t){var i;if(!e.prolong||(null===(i=e.prolong)||void 0===i?void 0:i.total)===r.E2)return e.prolong;let n={...e.prolong};if("start"===t.type){let i=t.value-e.start,r=e.prolong.start;n.start=r+i;let a=e.prolong.duration;n.duration=a-i}else{let i=t.value-e.start;n.duration=i}return n}},783750:function(e,t,i){i.d(t,{Z:function(){return s}});var n=i(772322),r=i(105789),a=i.n(r);i(620107);let s=e=>{let{width:t,type:i}=e;return(0,n.jsx)("svg",{className:a()("fade-shadow",i),style:{transform:`scaleX(${("out"===i?-1:1)*t/84})`},width:"84",height:"28",viewBox:"0 0 84 28",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:(0,n.jsx)("path",{d:"M 0,0 H 84 C 84,0 22.5,1.03704 0,28 V 0 Z",fill:"currentColor"})})}},277346:function(e,t,i){i.d(t,{Z:function(){return u}});var n=i(772322),r=i(650248),a=i(218571),s=i(105789),o=i.n(s),l=i(150564);i(772422);var d=i(907031),c=i(969242);let u=a.forwardRef((e,t)=>{let{start:i=0n,transition:s,zoom:u,edgeWidth:h,active:g,className:m,display:{alwaysThin:f,segmentHeight:p}={}}=e;(0,a.useMemo)(()=>Math.max(1,h-d.BC),[h,d.BC]);let v=(0,a.useRef)(null);(0,a.useEffect)(()=>{let e=new ResizeObserver((0,r.Z)(e=>{e.length&&v.current&&(e[0].contentRect.width>32?v.current.classList.remove("thin"):v.current.classList.add("thin"))},100));return(null==v?void 0:v.current)&&e.observe(v.current),()=>{e.disconnect()}},[]);let _=(0,c.vY)(u,s.duration),S=(0,c.vY)(u,i),y=f?12:_,x=f?S+(_-12)/2:S,b=null!=f?f:y<=32;return(0,n.jsxs)("div",{ref:e=>{"function"==typeof t?t(e):t&&(t.current=e),v.current=e},"data-id":s.id,className:o()("segment segment-transition type-transition",m,b?"thin":"",{"always-thin":f}),style:{left:x,width:y,height:p},children:[(0,n.jsxs)("div",{className:o()({"segment-active-box":!0,active:g}),style:{left:-1,right:-1},children:[(0,n.jsx)("div",{id:d.Qm,className:"segment-active-box-edge front cursor-segment-front"}),(0,n.jsx)("div",{id:d.aL,className:"segment-active-box-edge rear cursor-segment-rear"})]}),b?(0,n.jsx)("div",{className:o()("thin-icon",{"thin-icon-pure":f})}):(0,n.jsx)("div",{className:"broad-icon",children:(0,n.jsx)(l.$cv,{className:"iconpark-icon"})})]})})},589259:function(e,t,i){i.d(t,{M:function(){return d}});var n=i(260963),r=i(402655),a=i(690674),s=i(563890),o=i(257296),l=i(271564);class d extends r.JT{bindDataChangeListeners(e){let t=(0,n.U5)(()=>({processingSegIds:this._timelineManagerStore[a.U_].intelligentStore.processingSegIds,errorSegIds:this._timelineManagerStore[a.U_].intelligentStore.errorSegIds,finishSegIds:this._timelineManagerStore[a.U_].intelligentStore.finishSegIds}),()=>{for(let t of(0,s.Mq)(e.children,[o.KX.Segment])){let e=this._modules.draftOperation.getSegmentById(t.data.segment.id);if(t.destroyed||!(0,l.Bj)(e))continue;let{data:{segment:i}}=t;t.updateData(this.getProps(i),!0)}});this._register({dispose:t})}getProps(e){let t;let{processingSegIds:i,errorSegIds:n,finishSegIds:r}=this._timelineManagerStore.timelineStore.intelligentStore;return i.includes(e.id)?t="loading":n.includes(e.id)?t="failed":r.includes(e.id)&&(t=""),void 0===t?{}:{status:t,loadingCancelable:"loading"===t,gamePlayProcessing:"loading"===t}}constructor(e,t){super(),this._timelineManagerStore=e,this._modules=t}}},952959:function(e,t,i){i.d(t,{J:function(){return l}});var n=i(402655),r=i(563890),a=i(690674),s=i(260963),o=i(928261);class l extends n.JT{bindDataChangeListeners(e){this._onKeyframeSelectInfoChange(e),this._onSegmentSelectedChange()}_onKeyframeSelectInfoChange(e){let t=(0,s.U5)(()=>({keyframeSelectInfo:this._timelineManagerStore[a.U_].keyframeStore.keyframeSelectInfo}),t=>{var i;let{keyframeSelectInfo:n}=t,r=null===(i=this._preKeyframeSelectInfo)||void 0===i?void 0:i.seg_id;if(n){let t=n.seg_id;r&&r!==t&&this._updateKeyframeView(r,{keyframeSelectInfo:void 0},e),this._updateKeyframeView(t,{keyframeSelectInfo:n},e)}else r&&this._updateKeyframeView(r,{keyframeSelectInfo:void 0},e);this._preKeyframeSelectInfo=n});this._register({dispose:t})}_onSegmentSelectedChange(){let e=(0,s.U5)(()=>({segmentSelected:this._timelineManagerStore[a.qk].segmentSelected}),e=>{let{segmentSelected:t}=e,{draftOperation:i}=this._modules,{hasKeyframeSelect:n,keyframeSelectInfo:r}=this._timelineManagerStore[a.U_].keyframeStore;if(n){let{seg_id:e,keyframes_infos:n,draggedKeyframeIndex:a}=r,s=t.find(t=>t.id===e);if(s&&(0,o.IM)(s)){let{keyframesMap:t}=s;if(void 0!==a){let n=Array.from(t.values()).find(e=>e.currentKeyframeIndex===a);i.keyframe.setKeyframeSelectInfo(n?{seg_id:e,keyframes_infos:[n],draggedKeyframeIndex:void 0}:void 0);return}let r=n.filter(e=>t.has(e.offset)).map(e=>t.get(e.offset));r.length!==n.length&&i.keyframe.setKeyframeSelectInfo({seg_id:e,keyframes_infos:r})}else i.keyframe.setKeyframeSelectInfo(void 0)}});this._register({dispose:e})}_updateKeyframeView(e,t,i){if(i){let a=(0,r.JP)(i.children,e);if(a){var n;null===(n=a.updateKeyframeGroupData)||void 0===n||n.call(a,t,!0)}}}constructor(e,t){super(),this._timelineManagerStore=e,this._modules=t}}},397542:function(e,t,i){i.d(t,{k:function(){return h}});var n=i(402655),r=i(690674),a=i(260963),s=i(823404),o=i(215179),l=i(153107),d=i(909034),c=i(563890),u=i(257296);class h extends n.JT{bindDataChangeListeners(e){let t=(0,a.U5)(()=>this._timelineManagerStore[r.jU].failSegments,()=>{this._refreshProps(e)});this._register({dispose:t});let i=this._modules.resource.resourceErrorManager.onResourceErrorChange(()=>this._refreshProps(e));this._register(i)}getProps(e){var t,i;if("mutable"===e.type||"mutablePoly"===e.type||(0,s.AU)(e.id)||(null===(t=e.path)||void 0===t?void 0:t.startsWith(d.C_)))return{isLost:!1};let n=this._modules.draftOperation.dataSdk.draftView.getSegmentById(e.id);if(!n)return{isLost:!0};let{failSegments:r}=this._timelineManagerStore.resourceStore,a=r.has(e.id);return{isLost:a=(a=a||((0,l.yN)(n)&&n.material.path?this._modules.resource.resourceErrorManager.hasInvalidUserMaterial(n.material.path):this._modules.resource.resourceErrorManager.hasInvalidOnlineResources((0,o.d0)(n))))||(null===(i=n.material)||void 0===i?void 0:i.path)&&this._modules.resource.resourceErrorManager.isInvalidStreamSegmentPath(n.material.path)}}_refreshProps(e){for(let t of(0,c.Mq)(e.children,[u.KX.Segment])){if(t.destroyed)continue;let{data:{segment:e}}=t;t.updateData(this.getProps(e),!0)}}constructor(e,t){super(),this._timelineManagerStore=e,this._modules=t}}},451694:function(e,t,i){i.d(t,{P:function(){return d}});var n=i(260963),r=i(402655),a=i(690674),s=i(609962),o=i(563890),l=i(257296);class d extends r.JT{bindDataChangeListeners(e){this._register({dispose:(0,n.U5)(()=>({changed:this._timelineManagerStore[a.qk].isEditingTemplate&&Object.entries(this._timelineManagerStore[a.gC].mutableIdToStatusInfo).map(e=>{let[t,i]=e;return[t,i.status]}).flat(2).join(":"),processingSegIds:this._timelineManagerStore[a.U_].intelligentStore.processingSegIds,errorSegIds:this._timelineManagerStore[a.U_].intelligentStore.errorSegIds}),()=>{if(!!this._timelineManagerStore[a.qk].isEditingTemplate)for(let t of(0,o.Mq)(e.children,[l.KX.Segment])){let{data:{segment:e}}=t;if(!t.destroyed)t.updateData(this.getProps(e),!0)}})}),this._register({dispose:(0,n.EH)(()=>{let{mutableAudioSegments:t}=this._timelineManagerStore[a.U_],i=(0,o.Mq)(e.children,[l.KX.Segment]),n={};i.forEach(e=>{n[e.id]=e}),t.forEach(e=>{var t;let i;i=e.loading?"loading":"";let r=n[e.id];if(!!r)(null==r?void 0:null===(t=r.data)||void 0===t?void 0:t.status)!==i&&r.updateData({status:i},!0)})})})}getProps(e){var t,i;let n=null===(t=e.mutable)||void 0===t?void 0:t.mutableId,{timelineStore:{intelligentStore:r},timelineMutableStatusStore:{mutableIdToStatusInfo:a}}=this._timelineManagerStore,{processingSegIds:o,errorSegIds:l}=r;if(!a||!n||(null==o?void 0:o.includes(e.id)))return{};if(l.includes(e.id))return{status:"failed",loadingCancelable:void 0};let{status:d,cancelable:c}=null!==(i=a[n])&&void 0!==i?i:{};return{status:[s.a.UPLOADING,s.a.REPLACING].includes(d)?"loading":d===s.a.FAILED?"failed":"",loadingCancelable:c}}constructor(e){super(),this._timelineManagerStore=e}}},615697:function(e,t,i){i.d(t,{o:function(){return l}});var n=i(218571),r=i(257296),a=i(563890),s=i(422404),o=i(112825);function l(e,t){(0,n.useEffect)(()=>{e.current&&e.current.getStage().on("contextmenu",e=>{e.evt.preventDefault();let{name:i,originBeat:n}=e.target.attrs,{id:l,subType:d}=(0,a.tI)(i);if(d===r.CD.Beat){let e={contextmenuMode:s.D.BEAT,data:{beat:n}};t.coordinate.context.event.emit(o.B.contextmenuVisible,!0,e)}else if(d===r.CD.MutableAudio){let e={contextmenuMode:s.D.MUTABLE_AUDIO,data:{id:l}};t.coordinate.context.event.emit(o.B.contextmenuVisible,!0,e)}else if(d===r.CD.Keyframe){let e={contextmenuMode:s.D.KEYFRAME,data:{}};t.coordinate.context.event.emit(o.B.contextmenuVisible,!0,e)}else{let e={contextmenuMode:s.D.NORMAL,data:{}};t.coordinate.context.event.emit(o.B.contextmenuVisible,!0,e)}})},[])}},938262:function(e,t,i){i.d(t,{k:function(){return a}});var n=i(650248),r=i(218571);function a(e,t,i,a){let{timelineStore:s}=i;(0,r.useEffect)(()=>{let i,r;let o=e.current,l=t.current,d=(0,n.Z)(()=>{i&&clearTimeout(i),i=setTimeout(()=>{a(!1),s.setIsTimelineScrolling({horizontal:!1})},100),a(!0),s.setIsTimelineScrolling({horizontal:!0})}),c=(0,n.Z)(()=>{r&&clearTimeout(r),r=setTimeout(()=>{a(!1),s.setIsTimelineScrolling({vertical:!1})},100),a(!0),s.setIsTimelineScrolling({vertical:!0})});if(o&&l)return o.addEventListener("scroll",d),l.addEventListener("scroll",c),()=>{o.removeEventListener("scroll",d),l.removeEventListener("scroll",c)}},[])}},655158:function(e,t,i){i.d(t,{q:function(){return d}});var n=i(1297),r=i(218571),a=i(690674),s=i(874641),o=i(144690),l=i(202426);function d(e,t){let{isTemplatePost:i,isTemplate:d,relationGroupColorMap:c}=t[a.U_],{inputPreference:u}=(0,s.c)();(0,r.useEffect)(()=>{let t=e.current;if(!!t)t.updateContext({mode:d?"template":"default"})},[e.current,d]),(0,r.useEffect)(()=>{let t=e.current;if(!!t&&!!d)t.updateContext({templateType:(0,o.Z)(c)?"default":"auto-replace"}),t.layout(),t.render()},[e.current,d,c]),(0,r.useEffect)(()=>{var t;let i=e.current;if(!i)return;let n=null!==(t=null==u?void 0:u.toLowerCase())&&void 0!==t?t:"ltr";i.updateContext({direction:n}),i.batchDraw()},[e.current,u]),(0,n.default)(()=>{let t=e.current;if(!!t)t.updateContext({mode:i?"template-post":"default"}),t.layout(),t.render(),t.events.view.emit(l.H2.segmentsHeightChange)},[i])}},800609:function(e,t,i){i.d(t,{B:function(){return g}});var n=i(218571),r=i(979732),a=i(556249),s=i(15371),o=i(202426),l=i(907031),d=i(690674),c=i(426336),u=i(969242),h=i(260963);function g(e,t,i,g,m){let f=(0,n.useRef)(null);(0,n.useLayoutEffect)(()=>{if(!e.current||!t.current)return()=>{};let{width:n,height:o}=t.current.getBoundingClientRect(),l=new r.Stage({container:e.current,width:n,height:o});return f.current=new a.d(l,i,g),(0,s.O2)(),()=>{var e;l.destroy(),null===(e=f.current)||void 0===e||e.destroy()}},[]);let{zoomStore:p}=i[d.U_];return(0,n.useEffect)(()=>{let e=f.current;if(!e)return;let t=(e,t)=>{var i;let n=m?l.E9:l.Kr,r=(0,u.vY)(e,c.pMA.times(t,n,"bigint"))+(m?l.gD:l.$3);null===(i=f.current)||void 0===i||i.events.view.emit(o.H2.totalWidthChange,r)},n=(0,h.U5)(()=>p.value,n=>{t(n,i[d.U_].duration),e.events.store.emit(o.ML.zoomChange,n)},{fireImmediately:!0}),r=(0,h.U5)(()=>i[d.U_].duration,e=>{t(p.value,e)},{fireImmediately:!0});return()=>{n(),r()}},[p]),(0,n.useEffect)(()=>{let e=f.current;if(!e)return;let t=(0,h.U5)(()=>({isBatchReplacePanelVisible:i.timelineStore.isBatchReplacePanelVisible,isCollapseTimeline:i.timelineStore.isCollapseTimeline}),t=>{let{isBatchReplacePanelVisible:i,isCollapseTimeline:n}=t;e.events.store.emit(o.ML.viewportVisibleChange,!(n||i))},{fireImmediately:!0});return()=>{t()}},[i.timelineStore]),{sequencesRendererRef:f}}},123634:function(e,t,i){i.d(t,{G:function(){return c}});var n=i(218571),r=i(257296),a=i(202426),s=i(563890),o=i(690674),l=i(260963),d=i(490620);let c=(e,t,i)=>{let{[o.Y4]:c}=t,{templatePostChangeableSegment:u,templatePostSegments:h,templatePostMutableSegments:g}=c,{templatePost:m,coordinate:f}=i;(0,n.useEffect)(()=>{let t=e.current;if(t)for(let e of(0,s.Mq)(t.children,r.KX.Segment)){let t=!g.find(t=>t.id===e.data.segment.id),i=!!u.find(t=>t.id===e.data.segment.id);e.updateData({isLocked:t,changeable:i},!0)}},[h]),(0,n.useEffect)(()=>(0,l.U5)(()=>h.reduce((e,t)=>(e[t.id]=t.mutable,e),{}),(t,i)=>{let n=e.current;if(!!n)for(let e of(0,s.Mq)(n.children,r.KX.Segment)){let{id:n}=e.data.segment;if(t[n]===i[n])continue;let r=!m.isTemplatePostMutableSegment(e.data.segment);e.updateData({isLocked:r},!0)}},{equals:l.p6.default}),[h]),(0,n.useEffect)(()=>{let t=e.current,i=(e,t)=>{if(!!(0,d.QT)(e))f.context.flyover.setSkipHandleTimelineUp(!0),m.setTemplatePostSegmentMutableStatus(e,t)};return null==t||t.events.interact.on(a.TY.clickSegmentLock,i),()=>{null==t||t.events.interact.off(a.TY.clickSegmentLock,i)}},[e.current])}},356429:function(e,t,i){i.d(t,{Z:function(){return L}});var n=i(772322);i(818938),i(17435),i(837510),i(55041),i(931598),i(225572);var r=i(1297),a=i(255276),s=i(629913),o=i(948747),l=i(519065),d=i(16464),c=i(97257),u=i(928261),h=i(690674),g=i(70366),m=i(202426),f=i(251976),p=i(781566),v=i(426336),_=i(801497),S=i(150564),y=i(260963),x=i(670933),b=i(218571),M=i(609962),T=i(719162),I=i(956626),k=i(937802),D=i(347477),C=i(230689),w=i(108692),E=i(425427),A=i(27193),R=i(259525),P=i(309906);let L=(0,x.f3)("store","modules")((0,x.Pi)(e=>{var t;let{store:i,modules:x,renderer:L,disabled:N,scrollWrapRef:B}=e,O=(0,k.G)(C.t),j=(0,k.G)(w.n),U=(0,k.G)(E.rO),V=(0,E.JY)(U),{modal:F,draftOperation:z,intelligent:W,subjectCrop:Y}=x,[K,Z]=(0,b.useState)(!1),[G,H]=(0,b.useState)(0),{[h.U_]:{isTimelineVScrolling:X,isBatchReplacePanelVisible:Q},[h.qk]:{segmentSelected:q}}=i,{errorSegIds:J}=W.intelligentStore,{store:$}=Y,{processingSegIds:ee}=$,[et,ei]=(0,b.useState)(),[en,er]=(0,b.useState)(0),[ea,es]=(0,b.useState)(!1),eo=(0,R.y)(B),el=(0,b.useMemo)(()=>ea&&!eo&&!X&&!!q.find(e=>(null==e?void 0:e.id)===(null==et?void 0:et.id))&&!(0,u._n)(null==et?void 0:et.mutable)&&!Q,[et,q,ea,eo,X]),ed=(0,b.useRef)(null),ec=(0,b.useRef)(null),eu=(0,b.useCallback)(()=>K&&ec.current?ec.current.getBoundingClientRect():el&&ed.current?ed.current.getBoundingClientRect():null,[el,K,ed.current,ec.current]),eh=(0,b.useRef)({getBoundingClientRect:()=>eu()});eh.current={getBoundingClientRect:()=>eu()};let[eg,em,ef,ep]=(0,g.w)({setModalLeft:er,segment:et,bubbleRef:eh,modules:x,store:i,useMarginEdge:!1,isScrollWrapResizing:eo,isTimelineVScrolling:X});(0,b.useEffect)(()=>(0,y.U5)(()=>!!(!i[h.qk].segmentSelected.length||i[h.qk].segmentSelected.every(e=>e.id!==(null==et?void 0:et.id)))||!1,e=>{ea&&e&&es(!1)},{fireImmediately:!0}),[null==et?void 0:et.id]);let ev=null==et?void 0:null===(t=et.mutable)||void 0===t?void 0:t.mutableId,[e_,eS]=(0,b.useState)(!1);(0,b.useEffect)(()=>(0,y.U5)(()=>{for(let[t]of i[h.U_].tracksMutable)for(let i of t.segments)if(i.id===(null==et?void 0:et.id)){var e;return null===(e=i.mutable)||void 0===e?void 0:e.filled}return e_},e=>{eS(e)},{fireImmediately:!0}),[et]);let[ey,ex]=(0,b.useState)(),[eb,eM]=(0,b.useState)(!1),[eT,eI]=(0,b.useState)(!1),[ek,eD]=(0,b.useState)(!0);(0,b.useEffect)(()=>(0,y.U5)(()=>{for(let[n]of i[h.U_].tracksMutable)for(let r of n.segments)if(r.id===(null==et?void 0:et.id)){var e,t;let n=null===(e=r.mutable)||void 0===e?void 0:e.mutableId,{status:a}=null!==(t=i[h.gC].mutableIdToStatusInfo[n])&&void 0!==t?t:{};return{newStatus:[M.a.UPLOADING,M.a.REPLACING].includes(a)||ee.includes(et.id)?"loading":a===M.a.FAILED?"failed":"",newVisible:r.visible}}return{newStatus:ey,newVisible:ek}},e=>{let{newStatus:t,newVisible:i}=e;ex(t),void 0!==i&&eD(i)},{fireImmediately:!0}),[et,ee]);let eC=(e,t)=>{var n,r,a;(0,I.SH)(O,{action_type:I.kO.CLICK,option_type:e,action_position:t,clip_type:I.U4.TRACK,position_type:i[h.U_].isBatchReplacePanelVisible?I.o7.BATCH_REPLACE:I.o7.TIMELINE,clip_duration:Math.ceil(v.pMA.div(null!==(a=null===(n=j.dataSdk.draftView.getSegmentById(null!==(r=i[h.qk].segmentId)&&void 0!==r?r:""))||void 0===n?void 0:n.targetTimerange.duration)&&void 0!==a?a:0,1e6))})};(0,b.useEffect)(()=>{let e=(e,t,i)=>{let{x:n,y:r}=e;if(!J.includes(t.id))eC(I.Ds.EDIT,I.X3.VIDEO),H(r-6),ep({current:{getBoundingClientRect:()=>eu()}},t),Z(!0),ei(t),eM(void 0!==i&&i)};return null==L||L.events.interact.on(m.TY.popupMenu,e),()=>{null==L||L.events.interact.off(m.TY.popupMenu,e)}},[L,J]),(0,b.useEffect)(()=>{let e=(e,t)=>{let{x:i,y:n}=e;H(n-6),ep(eh,t),es(!0),ei(t)};return null==L||L.events.interact.on(m.TY.popupButton,e),()=>{null==L||L.events.interact.off(m.TY.popupButton,e)}},[L]),(0,r.default)(()=>{es(!1)},[i[h.U_].zoomStore.value]);let{uploadFileAndReplaceMutable:ew,cancelUpload:eE}=(0,P.x)({modules:x,mutableVideos:i[h.U_].mutableVideos,isTemplate:V,templateId:U.currentTemplateId||""}),eA=(0,b.useRef)(!1);(0,b.useEffect)(()=>{let e=e=>{eC(I.Ds.CANCEL,I.X3.VIDEO),eA.current=!0,ei(e)};return null==L||L.events.interact.on(m.TY.cancelUploadMaterialToMutable,e),()=>{null==L||L.events.interact.off(m.TY.cancelUploadMaterialToMutable,e)}},[L]),(0,b.useEffect)(()=>{eA.current&&(eA.current=!1,eE(ev))},[eA.current]);let eR=(0,b.useCallback)(e=>{var t;let i=e.target;(null==i?void 0:null===(t=i.files)||void 0===t?void 0:t.length)&&ew(ev,Array.from(i.files)),e.target.value=null,e.stopPropagation(),Z(!1)},[ew,ev]),eP=(0,b.useMemo)(()=>{var e;let t=x.intelligent.getIntelligentUploadAccept({segmentId:null==et?void 0:et.id});return t?t:null!==(e=(0,T.O)({acceptType:["image","video"]}))&&void 0!==e?e:""},[T.O,et]),eL=(0,b.useCallback)(e=>{let t=document.createElement("input");t.style.display="none",t.type="file",t.accept=eP,t.multiple=!0;let i=n=>{e(n),t.removeEventListener("change",i)};t.addEventListener("change",i),t.click()},[eP]),eN=(0,b.useCallback)(async()=>{if(!ev)return;let e=await (0,D.IL)(eP);if(!!e)eE(ev),ew(ev,e)},[ev,eP,eE,ew]),eB=(0,b.useCallback)((e,t)=>{z.mutable.setMutableVisible({segmentId:e,visible:t}),eC(t?I.Ds.UNHIDE_MATERIAL:I.Ds.HIDE_MATERIAL,I.X3.VIDEO)},[j.dataSdk]),eO=(0,b.useRef)(!1);(0,b.useEffect)(()=>{eO.current&&(eL(eR),eO.current=!1)},[et]),(0,b.useEffect)(()=>{let e=e=>{eC(I.Ds.REPLACE,I.X3.VIDEO),ei({...e}),eO.current=!0};return null==L||L.events.interact.on(m.TY.uploadMaterialToMutable,e),null==L||L.events.interact.on(m.TY.clickHideMutableSegment,eB),()=>{null==L||L.events.interact.off(m.TY.uploadMaterialToMutable,e),null==L||L.events.interact.off(m.TY.clickHideMutableSegment,eB)}},[L]),(0,b.useEffect)(()=>{ed.current&&et&&ed.current.setAttribute("data-segment-id",et.id),ec.current&&et&&ec.current.setAttribute("data-segment-id",et.id)},[el,K,null==et?void 0:et.id]);let ej=(0,n.jsxs)(l.Z.Item,{onClick:()=>{Z(!1),et&&(z.mutable.setMutableVisible({segmentId:et.id,visible:void 0===et.visible||!et.visible}),eC(et.visible?I.Ds.HIDE_MATERIAL:I.Ds.UNHIDE_MATERIAL,I.X3.DROP_OFF))},children:[(0,n.jsx)(S.Sto,{className:"iconpark-icon"}),(0,n.jsx)("div",{className:"content",children:_.ZP.t("web_material_button_hide",{},"Hide Media")})]},"hide");return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(a.Z,{popupVisible:el,style:{position:"fixed",left:en},className:"trigger-responsive-hot-area",position:"top",popup:()=>(0,n.jsx)("div",{ref:ed,className:"popup-segment-button",children:ek?"failed"===ey?(0,n.jsxs)(c.Z,{type:"secondary",className:["warning-button-hover"],onClick:e=>{e.stopPropagation(),es(!1),Z(!0)},children:[(0,n.jsx)(S.v3j,{className:"iconpark-icon",size:20}),(0,n.jsx)("div",{className:"button-content",children:_.ZP.t("web_failed",{},"Failed")})]},ey):"loading"===ey?(0,n.jsxs)(c.Z,{type:"secondary",onClick:e=>{e.stopPropagation(),es(!1),Z(!0)},className:"loading-button",children:[(0,n.jsx)(o.Z,{className:"loading-button-icon__hover",icon:(0,n.jsx)(S.kt0,{className:"iconpark-icon",color:f.wL.lvvColorMainDefault,size:20})}),(0,n.jsx)("div",{className:"button-content",children:_.ZP.t("web_the_material_is_loading",{},"Loading...")})]},ey):(0,n.jsx)(c.Z,{type:"secondary",onClick:e=>{e.stopPropagation(),e_?(eC(I.Ds.EDIT,I.X3.VIDEO),es(!1),setTimeout(()=>{Z(!0)})):(eC(I.Ds.REPLACE,I.X3.VIDEO),eL(eR))},children:e_?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(S.TvC,{className:"iconpark-icon",size:20}),(0,n.jsx)("div",{className:"button-content",children:_.ZP.t("web_edit",{},"Edit")})]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(S.S31,{className:"iconpark-icon",size:20}),(0,n.jsx)("div",{className:"button-content",children:_.ZP.t("web_replace",{},"Replace")})]})},ey):(0,n.jsx)(c.Z,{type:"secondary",className:["warning-button-hover"],onClick:e=>{e.stopPropagation(),es(!1),et&&eB(et.id,!ek)},children:(0,n.jsx)(S.Sto,{className:"iconpark-icon",size:20})},"unHide")}),children:(0,n.jsx)("div",{className:A.Z.fakeModal,style:{transform:`translate(0px, ${G}px)`}})}),(0,n.jsx)(d.Z,{position:"top",popupVisible:K,getPopupContainer:()=>document.body,triggerProps:{onClickOutside:()=>{es(!1),Z(!1)},style:{position:"fixed",left:en}},droplist:(0,n.jsx)(l.Z,{className:"menu-mutable",ref:ec,style:{opacity:eg?0:1},children:"failed"===ey?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(l.Z.Item,{onClick:e=>{e.stopPropagation(),Z(!1),setTimeout(()=>{eC(I.Ds.RETRY,I.X3.DROP_OFF),eN()},300)},children:[(0,n.jsx)(S.S31,{className:"iconpark-icon"}),(0,n.jsx)("div",{className:"content",children:_.ZP.t("web_reupload",{},"Reupload")})]},"reupload"),(0,n.jsxs)(l.Z.Item,{onClick:e=>{e.stopPropagation(),Z(!1),setTimeout(()=>{eC(I.Ds.CANCEL,I.X3.DROP_OFF),z.mutable.resetSegmentMutable(I.kO.CLICK)},300)},children:[(0,n.jsx)(S.TdK,{className:"iconpark-icon"}),(0,n.jsx)("div",{className:"content",children:_.ZP.t("web_resume",{},"Resume")})]},"reverse"),ej]}):"loading"===ey||eb?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(l.Z.Item,{onClick:e=>{e.stopPropagation(),Z(!1),setTimeout(()=>{eC(I.Ds.RETRY,I.X3.DROP_OFF),eb&&et&&W.mutableCancelIntelligent(et.id),et&&ee.includes(et.id)&&Y.cancelSubjectCrop(et.id),eN()},300)},children:[(0,n.jsx)(S.S31,{className:"iconpark-icon"}),(0,n.jsx)("div",{className:"content",children:_.ZP.t("web_reupload",{},"Reupload")})]},"reupload"),(0,n.jsxs)(l.Z.Item,{onClick:e=>{e.stopPropagation(),Z(!1),setTimeout(()=>{eC(I.Ds.CANCEL,I.X3.DROP_OFF),eb&&et&&W.mutableCancelIntelligent(et.id),et&&ee.includes(et.id)&&Y.cancelSubjectCrop(et.id),eE(ev)},300)},children:[(0,n.jsx)(S.TdK,{className:"iconpark-icon"}),(0,n.jsx)("div",{className:"content",children:_.ZP.t("web_resume",{},"Resume")})]},"reverse"),ej]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(l.Z.Item,{children:[(0,n.jsx)(S.S31,{className:"iconpark-icon"}),(0,n.jsxs)("div",{className:"content",children:[(0,n.jsx)(p.b,{className:"mutable-file-uploader",onChange:eR,accept:eP,onClick:e=>{e.stopPropagation(),eC(I.Ds.REPLACE,I.X3.DROP_OFF)}}),_.ZP.t("web_replace",{},"Replace")]})]},"replace"),(0,n.jsxs)(l.Z.Item,{onClick:()=>{if(Z(!1),et){var e;F.openMutableSegmentCropModal(et.id,null!==(e=i[h.qk].subDraftId)&&void 0!==e?e:void 0)}eC(I.Ds.CROP,I.X3.DROP_OFF)},children:[(0,n.jsx)(S.kcA,{className:"iconpark-icon"}),(0,n.jsx)("div",{className:"content",children:_.ZP.t("web_crop",{},"Crop")})]},"crop"),(null==et?void 0:et.metaType)===v.cVg.MetaTypeVideo?(0,n.jsxs)(l.Z.Item,{onClick:()=>{var e;Z(!1),F.openMutableSegmentTrimModal(et.id,null!==(e=i[h.qk].subDraftId)&&void 0!==e?e:void 0),eC(I.Ds.TRIM,I.X3.DROP_OFF)},children:[(0,n.jsx)(S.qhl,{className:"iconpark-icon"}),(0,n.jsx)("div",{className:"content",children:_.ZP.t("web_trim",{},"Trim")})]},"trim"):(0,n.jsx)(l.Z.Item,{disabled:!0,children:(0,n.jsxs)(s.Z,{position:"left",trigger:"hover",content:_.ZP.t("web_image_cannot_be_time_cropped",{},"Couldn\u2019t trim"),children:[(0,n.jsx)(S.qhl,{className:"iconpark-icon"}),(0,n.jsx)("div",{className:"content",children:_.ZP.t("web_trim",{},"Trim")})]})},"trim"),ej,(0,n.jsxs)(l.Z.Item,{onClick:()=>{es(!1),Z(!1),z.mutable.resetSegmentMutable(I.kO.CLICK)},children:[(0,n.jsx)(S.TdK,{className:"iconpark-icon"}),(0,n.jsx)("div",{className:"content",children:_.ZP.t("web_resume",{},"Resume")})]},"delete")]})}),children:(0,n.jsx)("div",{className:A.Z.fakeModal,style:{transform:`translate(0, ${G}px)`}})})]})}))},238605:function(e,t,i){i.d(t,{e:function(){return g}});var n=i(345299),r=i(183797),a=i(396493),s=i(853418),o=i(718540),l=i(257296),d=i(879098),c=i(426336),u=i(473920);let h=["trackRenderIndex","transition.duration","sourceTimerange","targetTimerange","reverse","speed"];class g{getRenderActions(e,t){let i=[],r={[n.P.ADD]:this._generateAddRenderAction,[n.P.DELETE]:this._generateDeleteRenderAction,[n.P.UPDATE]:this._generateUpdateRenderAction};for(let n of e){var a;let e=(0,o.j)(t,n.nextTrackId),s=null===(a=r[n.type])||void 0===a?void 0:a.call(r,n,e);s&&i.push(s);let l=this._generateUpdatePrevTransitionRenderAction(n,e);l&&i.push(l)}return i}_shouldUpdatePrevTransition(e){return e.type===n.P.UPDATE&&e.notifyOperationList.some(e=>e.type===c.C8.UPDATE&&e.item.segment.targetTimerange)}_generateUpdatePrevTransitionRenderAction(e,t){if(this._shouldUpdatePrevTransition(e)&&t&&e.nextValue){let[i]=t,n=i.segments.findIndex(t=>t.id===e.nextValue.id),a=(0,r.fQ)(i.segments[n-1]);if(a)return new d.Cp(l.KX.Transition,a.id,{params:{track:i,transition:a,segment:i.segments[n-1],nextSegment:e.nextValue},needRender:!1})}}_shouldUpdateStyle(e){for(let t of h)if((0,u.h)(e.notifyOperationList,t))return!0;return!1}constructor(e){this._store=e,this._generateAddRenderAction=(e,t)=>{let{nextValue:i}=e,n=(0,r.fQ)(i);if(!t||!n||!i)return;let[s]=t,o=s.segments.findIndex(e=>e.id===i.id),d={track:s,transition:n,segment:i,nextSegment:s.segments[o+1],isActive:this._store.timelineSelectionStore.canvasUISelectedSegmentIds.includes(n.id)};return new a.tO(l.KX.Transition,n.id,{params:d})},this._generateDeleteRenderAction=e=>{let t=(0,r.fQ)(e.prevValue);if(!!t)return new s.x(l.KX.Transition,t.id,void 0)},this._generateUpdateRenderAction=(e,t)=>{let{prevValue:i,nextValue:n}=e,o=(0,r.fQ)(i),c=(0,r.fQ)(n);if(o&&!c)return new s.x(l.KX.Transition,o.id,void 0);if(!o&&c&&t&&n){let[e]=t,i=e.segments.findIndex(e=>e.id===n.id),r={track:e,transition:c,segment:n,nextSegment:e.segments[i+1],isActive:this._store.timelineSelectionStore.canvasUISelectedSegmentIds.includes(c.id)};return new a.tO(l.KX.Transition,c.id,{params:r})}if(o&&c&&n&&t){let[i]=t;return new d.Cp(l.KX.Transition,c.id,{params:{track:i,transition:c,segment:n},needUpdateStyle:this._shouldUpdateStyle(e)})}}}}},879098:function(e,t,i){i.d(t,{Cp:function(){return d},Pj:function(){return o},TL:function(){return l}});var n=i(202426),r=i(75535),a=i(563890),s=i(404161);class o extends r.V{run(e){let t=(0,a.JP)(e.children,this.key);if(!!t)this._updateData(t,this.actionInfo.params,this.actionInfo.needRender),this._updateStyle(this.actionInfo,e)}_updateData(e,t,i){let n=!(arguments.length>3)||void 0===arguments[3]||arguments[3];e.updateData(t,i,n)}_updateStyle(e,t){if(!!e.needUpdateStyle)t.updateStyleById(this.key,this._calcStyle(t,e))}_calcStyle(e,t){}constructor(...e){super(...e),this.actionType="update"}}class l extends o{run(e){super.run(e),this.actionInfo.needResetThumbnail&&(this._resetThumbnail(this.key,e),e.updateThumbnailById(this.key,!1))}_resetThumbnail(e,t){t.events.store.emit(n.ML.onResetSegmentThumbnail,[e])}_calcStyle(e,t){let{params:i}=t,n=(0,a.JP)(e.children,i.track.id);return(0,s.RD)(i.segment,e.camera.zoom,e.context.mode,null==n?void 0:n.style)}}class d extends o{_calcStyle(e,t){let{params:i}=t,n=(0,a.JP)(e.children,i.track.id);return(0,s.wm)(i.segment,i.transition,e.camera.zoom,e.context.mode,null==n?void 0:n.style)}}},251976:function(e,t,i){i.d(t,{SU:function(){return h},Uf:function(){return u},ey:function(){return g},pr:function(){return c},wL:function(){return l}});var n,r=i(907031),a=i(343828),s=i(499845);let o={lvvColorLine1:"--lvv-color-line-1",lvvColorLine2:"--lvv-color-line-2",lvvColorLine3:"--lvv-color-line-3",lvvColorFillTransparencyBlock:"--lvv-color-fill-transparency-block",lvvColorFillTransparencyHover:"--lvv-color-fill-transparency-hover",lvvColorFillTransparencyPressed:"--lvv-color-fill-transparency-pressed",lvvColorTrackGreen:"--lvv-color-track-green",lvvColorTrackOrange:"--lvv-color-track-orange",lvvColorTrackBlueviolet:"--lvv-color-track-blueviolet",lvvColorTrackPurple:"--lvv-color-track-purple",lvvColorTrackPink:"--lvv-color-track-pink",lvvColorTrackBlue:"--lvv-color-track-blue",lvvColorTextPrimary:"--lvv-color-text-primary",lvvColorTextContentPrimary:"--lvv-color-text-content-primary",lvvColorTextContentTertiary:"--lvv-color-text-content-tertiary",lvvColorTextSecondary:"--lvv-color-text-secondary",lvvColorFillBg2:"--lvv-color-fill-bg-2",lvvColorMainDefault:"--lvv-color-main-default",lvvColorMainHover:"--lvv-color-main-hover",lvvColorMain02:"--lvv-color-main-02",lvvColorBlackStationary:"--lvv-color-black-stationary",lvvColorScenesPanel:"--lvv-color-scenes-panel",colorFill7:"--color-fill-7",lvvColorWhite02:"--lvv-color-white-02",lvvColorWhite04:"--lvv-color-white-04",lvvColorWhite06:"--lvv-color-white-06",lvvColorWhite08:"--lvv-color-white-08",lvvColorWhite012:"--lvv-color-white-012",lvvColorBlack012:"--lvv-color-black-012",lvvColorBlack02:"--lvv-color-black-02",lvvColorBlack04:"--lvv-color-black-04",lvvColorBlack004:"--lvv-color-black-004",lvvColorBlack06:"--lvv-color-black-06",lvvColorBlack08:"--lvv-color-black-08",lvvColorBlack006:"--lvv-color-black-006",lvvColorBlack025:"--lvv-color-black-025",lvvColorNegativePrimary:"--lvv-color-negative-primary",lvvColorWhiteStationary:"--lvv-color-white-stationary",lvvColorBlockStationary:"--lvv-color-black-stationary",lvvColorMain04:"--lvv-color-main-04",lvvColorMain06:"--lvv-color-main-06",lvvColorMain006:"--lvv-color-main-006",lvvColorMain08:"--lvv-color-main-08",lvvColorNegativeActive:"--lvv-color-negative-active",lvvColorNegativeBg:"--lvv-color-negative-bg"},l={segmentVideoBgColor:"#8c8c99",segmentAudioEmptyTextColor:"rgba(24,51,78,.4)",segmentAudioWavesBackgroundColor:"#bbc1ce",segmentAudioReplaceHoverColor:"rgba(0, 202, 224)",segmentAudioLostColor:"#337460",editorTlSegFade:"#202023b2",segmentLostTipsBackgroundColor:"rgba(219, 35, 63, 0.80)",segmentVipProColor:"#000",failedSegmentBgColor:"rgba(255, 48, 61, 0.4)",failedSegmentBgHoverColor:"rgba(255, 48, 61, 0.6)",trackingTargetColor:"rgba(255, 122, 0, 1)",templateMusicNoCopyright:"rgba(219, 35, 63, 0.80)"};a.h.Dark,r.pi,r.mP,r.Mf,a.h.Light,r.ay,r.Tv,r.wu,a.h.Light;let d={[a.h.Dark]:{maskBackground:"lvvColorBlack08",invisibleMaskBackground:"lvvColorBlack06"},[a.h.Light]:{maskBackground:"lvvColorWhite08",invisibleMaskBackground:"lvvColorWhite06"}},c={maskBackground:l[d[a.h.Dark].maskBackground],invisibleMaskBackground:l[d[a.h.Dark].invisibleMaskBackground]},u=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.h.Light,t=getComputedStyle(document.body);for(let e in o){let i=o[e],n=t.getPropertyValue(i);!n&&console.warn(`js var ${e}'s css var ${i} does not exist.`),l[e]=n}for(let t of Object.keys(c))c[t]=l[d[e][t]]};"node"!==s.env.JUPITER_TARGET&&u((null===(n=localStorage)||void 0===n?void 0:n.getItem("CAPCUT_THEME"))||a.h.Light);let h={get video(){return l.segmentVideoBgColor},get combination(){return l.segmentVideoBgColor},get audio(){return l.lvvColorTrackGreen},get tailLeader(){return l.segmentVideoBgColor},get text(){return l.lvvColorTrackOrange},get textTemplate(){return l.lvvColorTrackOrange},get videoEffect(){return l.lvvColorTrackBlueviolet},get effect(){return l.lvvColorTrackBlueviolet},get filter(){return l.lvvColorTrackPurple},get pictureAdjust(){return l.lvvColorTrackBlue},get sticker(){return l.lvvColorTrackPink},get imageSticker(){return l.lvvColorTrackPink},get mutable(){return l.lvvColorFillTransparencyBlock},get mutablePoly(){return l.lvvColorFillTransparencyBlock},none:"#444"},g={get video(){return"#606269"},get audio(){return"#35705f"},get tailLeader(){return l.segmentVideoBgColor},get text(){return"#88583a"},get textTemplate(){return"#88583a"},get videoEffect(){return"#53498b"},get effect(){return"#53498b"},get filter(){return"#6b4a8b"},get pictureAdjust(){return"#5281E6"},get sticker(){return"#854962"},get imageSticker(){return"#854962"},none:"#444"}},810866:function(e,t,i){i.d(t,{R:function(){return S}});var n=i(789786),r=i(756024),a=i(587892),s=i(402655),o=i(800788),l=i(965033),d=i(879098),c=i(563890),u=i(257296),h=i(354267),g=i(183797),m=i(639773),f=i(139367),p=i(230689),v=i(265409);class _ extends s.JT{get onAfterRun(){return this._onAfterRun.event}onUITimelineDataChangeDiff(e){(0,v.DM)(v.Fh.RENDERER_UPDATE);let t=(0,g.ug)(this._timelineManagerStore.timelineStore),i=(0,g.Y_)(this._timelineManagerStore,t),n=this._renderActionCollection.getRenderActionMap(e,t,i);this.run(n)}run(e){let t=new Map(e);this._beforeRun(t);let i=t.get(u.KX.Track);null==i||i.forEach(e=>{e.run(this._renderer)});let n=t.get(u.KX.Segment);null==n||n.forEach(e=>{e.run(this._renderer)});let r=t.get(u.KX.Transition);if(null==r||r.forEach(e=>{e.run(this._renderer)}),this._layoutActions.length){this._layoutActions.forEach(e=>e.run(this._renderer));let e=this._reGenerateRenderActionByLayout(u.KX.Track,t.get(u.KX.Track));t.set(u.KX.Track,e);let i=this._reGenerateRenderActionByLayout(u.KX.Segment,t.get(u.KX.Segment));t.set(u.KX.Segment,i);let n=this._reGenerateRenderActionByLayout(u.KX.Transition,t.get(u.KX.Transition));t.set(u.KX.Transition,n)}this._afterRun(t)}_reGenerateRenderActionByLayout(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=(0,c.Mq)(this._renderer.children,e),n=[...t];for(let e of i){if(!t.some(t=>t.key===e.id))n.push(new d.Pj(e.type,e.id,{params:{}}))}return n}_updateCoordinate(e){let{coordinate:t}=this._modules,{controllerManager:i}=t;if(!i){r.t.error("[RenderActionRunner] you should not call _updateCoordinate before controllerManager initialization");return}for(let[n,r]of e.entries())switch(n){case u.KX.Segment:r.forEach(e=>{let{actionType:n,key:r}=e,a=r.startsWith(h.k);if("delete"===n)return a?t.registry.placeholder.unregister(r):t.registry.segment.unregister([r]);let s=(0,c.JP)(this._renderer.children,r);s&&(a?t.registry.placeholder["add"===n?"register":"update"](f.y.audioPlaceholderInfo({segmentCO:s,controllerManager:i})):t.registry.segment.replace(f.y.segmentInfo({segmentCO:s,controllerManager:i})))});break;case u.KX.Track:r.forEach(e=>{let{actionType:n,key:r}=e;if("delete"===n)return t.registry.track.unregister([r]);let a=(0,c.JP)(this._renderer.children,r);a&&t.registry.track.replace(f.y.trackInfo({trackCO:a,controllerManager:i}))});break;case u.KX.Transition:r.forEach(e=>{let{actionType:n,key:r}=e;if("delete"===n)return t.registry.transition.unregister([r]);let a=(0,c.JP)(this._renderer.children,r);a&&t.registry.transition.replace(f.y.transitionInfo({transitionCO:a,controllerManager:i}))});break;case u.KX.MutableButton:case u.KX.CoverGroup:case u.KX.Default:case u.KX.Keyframe:case u.KX.KeyframeGroup:case u.KX.SubSequenceMask:case u.KX.TimeRuler:case u.KX.MutableTrimMask:break;default:(0,o.bP)(n)}t.registry.deferRefreshReference()}_beforeRun(e){if(e.has(u.KX.Track)){let t=e.get(u.KX.Track);(null==t?void 0:t.some(e=>["add","delete"].includes(e.actionType)))&&this._layoutActions.push(new l.Q)}}_afterRun(e){this._checkAndRender(e);let t=e.get(u.KX.Segment);this._updateAddedSegmentsThumbnail(t),(0,v.wf)(v.Fh.RENDERER_UPDATE),(0,v.DM)(v.Fh.COORDINATE_UPDATE),this._updateCoordinate(e),this._layoutActions.length=0,(0,v.wf)(v.Fh.COORDINATE_UPDATE),this._onAfterRun.fire()}_checkAndRender(e){let t=this._renderer.camera.getBounds();for(let i of e.values())for(let e of i)if("delete"!==e.actionType){let i=(0,c.JP)(this._renderer.children,e.key);null==i||i.checkWillRender(t),null==i||i.render()}}_updateAddedSegmentsThumbnail(e){null==e||e.forEach(e=>{"add"===e.actionType&&this._renderer.updateThumbnailById(e.key,!1)})}constructor(e,t,i,n,r){super(),this._renderer=t,this._timelineManagerStore=i,this._modules=n,this._containerService=r,this._layoutActions=[],this._onAfterRun=new a.Q,this._renderActionCollection=this._containerService.createInstance(m.l,this._timelineManagerStore,this._modules),this._register(e.onDataDiff(this.onUITimelineDataChangeDiff.bind(this)))}}function S(e,t,i,n,r){return r.createInstance(_,e,t,i,n)}_=(0,n.gn)([(0,n.fM)(4,p.t),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",["undefined"==typeof IDraftDataSynchronizer?Object:IDraftDataSynchronizer,"undefined"==typeof SequencesRenderer?Object:SequencesRenderer,"undefined"==typeof TimelineManagerStore?Object:TimelineManagerStore,"undefined"==typeof TimelineManagerModules?Object:TimelineManagerModules,void 0===p.t?Object:p.t])],_)},739801:function(e,t,i){i.d(t,{Y:function(){return r}});var n=i(251976);let r=[{shadowColor:n.wL.lvvColorBlack006,shadowOffsetX:0,shadowOffsetY:2,shadowBlur:12},{shadowColor:n.wL.lvvColorBlack025,shadowOffsetX:0,shadowOffsetY:0,shadowBlur:4}]},629818:function(e,t,i){i.d(t,{Z:function(){return v}});var n=i(251976),r=i(257296),a=i(932919),s=i(620183),o=i(288712),l=i(597210),d=i(559408),c=i(857458),u=i(628499),h=i(384971),g=i(125780);let m="Group",f="Background",p="Text";class v extends u.G{mount(){var e;if(!this.data.isLoading)return;let t=new a.Group({listening:!1});this._flatNodeMap.set(m,t);let{height:i}=this.style,u=new s.Rect({fill:n.wL.lvvColorBlack06,listening:!1});this._flatNodeMap.set(f,u),t.add(u);let h=new o.Image({image:g.J.Loading,width:this.iconSize,height:this.iconSize,listening:!1,x:this.iconX,y:(i-this.iconSize)/2+this.offsetX,offsetX:this.offsetX,offsetY:this.offsetX});t.add(h);try{let e=new l.Animation(e=>{if(!e)return;let t=320*e.timeDiff/1e3;h.rotate(t)});this._anims.push(e)}catch(e){}let v=new d.Text({text:null!==(e=this.data.loadingText)&&void 0!==e?e:c.F.t("load_web_ing",{},"loading"),fontSize:13,fill:"#fff",height:this.iconSize,verticalAlign:"middle",x:this.marginLeft+this.iconSize+4,y:i/2-this.iconSize/2,listening:!1,fontFamily:r.I8});return this._flatNodeMap.set(p,v),t.add(v),this.update(),t}update(){let{style:e,data:t,_anims:i}=this,{x:n,y:a,height:s,width:o}=e,{isLoading:l,loadingText:d}=t,u=i[0];if(!l){this.clear();return}let g=this._flatNodeMap.get(m),v=this._flatNodeMap.get(f),_=this._flatNodeMap.get(p),S=(0,h.C5)(o);null==g||g.setAttrs({x:n+r.iX,y:a}),null==g||g.clip({x:0,y:0,width:S,height:s}),null==v||v.setAttrs({width:S,height:s,cornerRadius:(0,h.yW)(S)}),null==_||_.setAttrs({text:null!=d?d:c.F.t("load_web_ing",{},"loading")}),o>19?!(null==u?void 0:u.isRunning())&&(null==u||u.start()):null==u||u.stop()}constructor(...e){super(...e),this.dataPropertyNames=["segment","isLoading","loadingText"],this.iconSize=22,this.marginLeft=8,this.offsetX=this.iconSize/2,this.iconX=this.marginLeft+this.offsetX}}},257315:function(e,t,i){i.d(t,{Z:function(){return c}});var n=i(931774),r=i(77665),a=i(257296),s=i(628499),o=i(932919);let l={Group:"Group",Background:"Background"};class d extends s.G{mount(){var e;if((null===(e=this.context)||void 0===e?void 0:e.mode)==="template")return;let t=new o.Group({listening:!1});return this._flatNodeMap.set(l.Group,t),this.update(),t}update(){let e=this._flatNodeMap.get(l.Group),t=this.getContainer();if(!t)return;let{tag:i}=this.data;if(!i){null==e||e.visible(!1);return}let r="template-post"===this.context.mode?16:14,s=this._flatNodeMap.get(l.Background);!s&&(s=(0,n.eN)({height:r}),this._flatNodeMap.set(l.Background,s),e.add(s));let o=(0,n.cx)(t,e,a.Kp);e.x(o);let d=(0,n.Ny)({text:i,x:a.ZT,height:r-2});e.add(d),s.width(d.x()+d.getTextWidth()+a.ZT)}}class c extends s.G{_initChildren(){var e;let{extraTags:t}=this.data;this._children=null!==(e=null==t?void 0:t.map(e=>new d({layer:this._layer,data:{tag:e},style:this.style,context:this.context,container:()=>this._flatNodeMap.get(l.Group),type:a.KX.Default})))&&void 0!==e?e:[]}mount(){var e;if((null===(e=this.context)||void 0===e?void 0:e.mode)==="template"||!(0,r.I)(this.data,this.context))return;let t=new o.Group({listening:!1});return this._flatNodeMap.set(l.Group,t),this.update(),t}update(){this._children.forEach(e=>e.remove()),this._initChildren();let e=this._flatNodeMap.get(l.Group),t=this.getContainer();if(!(0,r.I)(this.data,this.context)||!t){null==e||e.visible(!1);return}e.visible(!0)}constructor(e){super(e),this._initChildren()}}},154708:function(e,t,i){i.d(t,{Z:function(){return u}});var n=i(932919),r=i(628499),a=i(257296),s=i(931774),o=i(77665),l=i(680145),d=i(125682);let c={Group:"ProTag",Icon:"Icon"};class u extends r.G{mount(){let e=new n.Group({listening:!1,x:a.z6,y:this.marginY,name:c.Group});return this._flatNodeMap.set(c.Group,e),this.update(),e}update(){let e=this._flatNodeMap.get(c.Group),t=this.getContainer(),{isVip:i,segment:n,vipBadgeType:r}=this.data,u="video"===n.type,h=(0,o.I)(this.data,this.context);if(!i||!t||!u&&!h){e.visible(!1);return}let g=this._flatNodeMap.get(c.Icon),m="template-post"===this.context.mode?16:14,f=(0,d.V)(r),p=r&&"legacy-vip"!==r?a.Q3:a.pq;!g&&(g=(0,s.Hk)(this,f,l.N[f],{listening:!1,image:a.PM,height:m,width:p}),this._flatNodeMap.set(c.Icon,g),e.add(g),e.width(p+2*a.Kp)),"template-post"===this.context.mode?e.setAttrs({y:(this.style.height-m)/2}):e.setAttrs({y:this.marginY});let v=(0,s.Re)(t,e,a.Kp,a.ao)||a.z6;e.x(v),e.visible(!0)}constructor(...e){super(...e),this.marginY=5}}},5996:function(e,t,i){i.d(t,{S:function(){return g}});var n=i(932919),r=i(288712),a=i(628499),s=i(257296),o=i(251976),l=i(125780),d=i(931774),c=i(857458);let u="TemplateMusicCopyrightTag",h="TemplateMusicCopyrightText";class g extends a.G{mount(){let{data:e,context:t}=this,{segment:i}=e,{type:a}=i;if((null==t?void 0:t.mode)==="template"||"combination"!==a)return;let g=new n.Group({listening:!1,x:s.z6,y:this.marginY,name:u});this._flatNodeMap.set(u,g);let m="template-post"===t.mode?16:14,f=(0,d.eN)({fill:o.wL.templateMusicNoCopyright,height:m});g.add(f);let p=s.ZT,v=new r.Image({x:p,y:(m-12)/2,width:12,height:12,image:l.J.Warning,listening:!1});g.add(v);let _=(0,d.Ny)({name:h,height:m,text:c.F.t("cc4b_editor_template_muted_tag",{},"Music muted due to copyright restrictions"),x:p+12+2});return g.add(_),f.width(_.x()+_.getTextWidth()+s.ZT),this.update(),g}update(){var e;let t=this._flatNodeMap.get(u),{isHover:i,isActive:n,isTemplateMusicNoCopyright:r}=this.data;if(i&&n||!r){t.visible(!1);return}let a=null!==(e=t.getParent())&&void 0!==e?e:this.getContainer(),o=(0,d.Re)(a,t,s.Kp,s.ao)||4;t.x(o),t.visible(!0)}constructor(...e){super(...e),this.dataPropertyNames=["segment","isActive","isHover","isTemplateMusicNoCopyright"],this.marginX=6,this.marginY=5}}},522590:function(e,t,i){i.d(t,{Z:function(){return m}});var n=i(251976),r=i(202426),a=i(257296),s=i(563890),o=i(620183),l=i(628499),d=i(907031),c=i(969242),u=i(426336);let h="Mask",g="HighlightedArea";class m extends l.G{checkWillRender(){return this.getVisible()}mount(){let e=new o.Rect({x:-this._layer.x(),y:-this._layer.y(),width:this._layer.width(),height:this._layer.height(),fill:n.pr.maskBackground});this._flatNodeMap.set(h,e);let t=new o.Rect({x:this.style.x,width:this.style.width,height:this._layer.height(),fill:n.wL.lvvColorMain006});return this._flatNodeMap.set(g,t),this._bindEvents(e),[e,t]}update(){let e=this._flatNodeMap.get(h);null==e||e.setAttrs({x:-this._layer.x(),y:-this._layer.y(),width:this._layer.width(),height:this._layer.height()});let t=this._flatNodeMap.get(g);null==t||t.setAttrs({x:this.style.x,width:this.style.width,height:this._layer.height()})}layout(){let{start:e,duration:t}=this.data.expandedSegment,{zoom:i}=this.context.camera;this.style.x=(0,c.vY)(i,e),this.style.width=Math.max(d.vm,(0,c.vY)(i,u.pMA.max([1n,t],"bigint")))}_bindEvents(e){e.on("mousedown",()=>{var e;null===(e=this.context)||void 0===e||e.events.interact.emit(r.TY.exitEditSubSequence)})}constructor(e){let{layer:t,id:i,data:n,context:r}=e;super({layer:t,type:a.KX.SubSequenceMask,id:i}),this.data=n,this.context=r,this._container=(0,s.dX)(t,a.PB.MaskGroup),this._inViewport=!0,this.layout()}}},200058:function(e,t,i){i.d(t,{Z:function(){return S}});var n=i(801497),r=i(125780),a=i(628499),s=i(563890),o=i(257296),l=i(251976),d=i(559408),c=i(612350),u=i(597210),h=i(932919),g=i(620183),m=i(288712),f=i(721244),p=i(700933),v=i(202426),_=i(831858);class S extends a.G{_getConstants(e){let{width:t,height:i}=this.style,{bgState:a,display:s,replaceHover:c,isReadonlyMode:u}=this.data,h=0,g=0,m="",p=[f.j.Empty,f.j.Placeholder].includes(s),v=[f.j.Loading].includes(s),_={},S=o.me,y=o.RB;if(p||v){if(p&&(u?(_.iconUrl=null,m=n.ZP.t("web_collaborate_share_empty_timeline",{},"Nothing on the timeline yet.")):"template"!==this.context.mode?(_.iconUrl=r.J.LvIconStocks,m=n.ZP.t("web_textvideo_text_drag_add_videos",{},"Drag videos or images here to create videos !")):(_.iconUrl=r.J.LvIconTemplate,m=n.ZP.t("web_editor_text_click_template",{},"Click a template from the left to start"))),v&&(_.iconUrl=r.J.Uploading,S*=1.5,y*=1.5,m=n.ZP.t("web_track_export_loading_loading",{},"Loading...")),e&&0!==e.width())h=e.width(),g=e.height();else{let e=new d.Text({text:m,padding:8,fontSize:12,lineHeight:1.1});h=e.width(),g=e.height(),e.destroy()}}let x={hover:l.wL.lvvColorFillTransparencyHover,selected:l.wL.lvvColorFillTransparencyPressed,default:l.wL.lvvColorFillTransparencyBlock},b=x.default;!p&&a&&(b=x[a]);let M=h+S+24;return{padding:8,textContent:m,rectFill:b,rectStroke:s===f.j.Empty?l.wL.lvvColorLine3:void 0,iconX:s===f.j.Placeholder?8:t/2-M/2+8,iconY:i/2-y/2,textX:s===f.j.Placeholder?8+o.me:t/2-M/2+8+o.me,textY:i/2-g/2,visible:p||"template"!==this.context.mode&&v,groupVisible:p&&c?0:1,display:s,buttonWidth:M,textWidth:h,..._}}_initChildren(){this._children=[_.Z].map(e=>new e({layer:this._layer,trackId:this.id,data:this.data,style:this.style,context:this.context}))}active(e,t){this.updateData({bgState:e?"selected":"default"});let i=this._isActive!==e;this._isActive=e,t&&i&&this.render()}_updateFill(e,t){let i=e.fill();if(!!t&&i!==t)if(void 0===i)e.setAttrs({fill:t});else{var n;null===(n=e.tween)||void 0===n||n.finish();try{let i=new c.Tween({node:e,easing:c.Easings.EaseInOut,fill:t,duration:.2});i.play(),this._tweens.push(i),e.tween=i}catch(e){}}}_updateLoading(e,t,i){let n=this._anims,r=this._layer,a=1.5*o.me,s=1.5*o.me,d=a/2,c=s/2,{width:h,x:g}=this.context.camera.getViewport(),{buttonWidth:m,iconY:f,visible:p,textY:v,textContent:_}=i,S=h/2-m/2+g+8;if(null==e||e.setAttrs({x:S+d,y:f+c,width:a,height:s,visible:p,offsetX:d,offsetY:c}),null==t||t.setAttrs({x:S+o.me,y:v,text:_,padding:8,fontSize:12,lineHeight:1.1,fill:l.wL.lvvColorTextSecondary,visible:p}),!(null==n?void 0:n.length)){let t=new u.Animation(function(t){if(t){let i=180*t.timeDiff/1e3;null==e||e.rotate(i)}},r);t.start(),null==n||n.push(t)}}_updateGeneral(e,t,i){var n;let r=this._anims,{iconX:a,iconY:s,visible:d,textX:c,textY:u,textContent:h}=i;null==e||e.setAttrs({x:a,y:s,width:o.me,height:o.me,visible:d,offsetX:0,offsetY:0}),null==r||null===(n=r[0])||void 0===n||n.stop(),null==e||e.rotation(0),null==r||r.shift(),null==t||t.setAttrs({x:c,y:u,text:h,padding:8,fontSize:12,lineHeight:1.1,fill:l.wL.lvvColorTextSecondary,visible:d})}_updateNodes(e){let{group:t,rect:i,icon:n,text:r}=e,{style:a}=this,{x:s,y:o,width:l,height:d}=a,c=this._getConstants(r),{rectFill:u,rectStroke:h,groupVisible:g,iconUrl:m,display:p}=c;t.setAttrs({x:s,y:o,width:l,height:d,opacity:g}),i.setAttrs({width:l,height:d,stroke:h,strokeWidth:1,cornerRadius:6}),this._updateFill(i,u),m&&(null==n||n.image(m)),p===f.j.Loading?n&&r&&this._updateLoading(n,r,c):n&&r&&this._updateGeneral(n,r,c)}mount(){let e,t;let{data:i,context:n}=this,{events:a}=n,{cTrack:l}=i,[{id:c}]=l,u=(0,p.MD)(l),f=new h.Group({name:(0,s.Vo)(c,o.KX.Track,o.V_.Background)}),_=new g.Rect({name:(0,s.Vo)(c,o.KX.Track)});return(u||"dragVideoPlaceholder"===l[0].type||"dragAudioPlaceholder"===l[0].type)&&(e=new m.Image({image:"template"===n.mode?r.J.LvIconTemplate:r.J.LvIconStocks,listening:!1}),t=new d.Text({listening:!1,fontFamily:o.I8})),this._updateNodes({group:f,rect:_,icon:e,text:t}),f.add(...[_,e,t].filter(Boolean)),f.on("mouseenter",()=>{if("selected"!==this.data.bgState&&!this.context.isCursorDrag)this.updateData({bgState:"hover"},!0)}),f.on("mouseleave",()=>{if("selected"!==this.data.bgState)this.updateData({bgState:"default"},!0)}),f.on("click",()=>{let[{segments:e=[]}]=this.data.cTrack;(0,p.MD)(this.data.cTrack)&&e.length<=0&&a.interact.emit(v.TY.clickEmptyTrack)}),f}update(){let e=this._konvaNodes[0],[t,i,n]=e.children;this._updateNodes({group:e,rect:t,icon:i,text:n})}constructor(e){let{layer:t,id:i,data:n,context:r,style:a}=e;super({layer:t,type:o.KX.Track,id:i,style:a}),this.data=n,this.context=r,this._isActive=!1,this._container=(0,s.dX)(t,o.PB.TrackGroup),this._inViewport=!1,this._initChildren()}}},401790:function(e,t,i){i.d(t,{Z:function(){return r}});var n=i(202426);class r{boot(){}destroy(){this._removeListeners()}_addListeners(){let{events:e}=this._renderer;e.store.on(n.ML.zoomChange,this._onZoomChange),e.view.on(n.H2.totalWidthChange,this._onTotalWidthChange)}_removeListeners(){let{events:e}=this._renderer;e.store.off(n.ML.zoomChange,this._onZoomChange),e.view.off(n.H2.totalWidthChange,this._onTotalWidthChange)}constructor(e){this._onZoomChange=e=>{this._renderer.camera.setZoom(e)},this._onTotalWidthChange=e=>{this._renderer.camera.setRealWidth(e)},this.selectedSegmentCOs=[],this._renderer=e,this._addListeners()}}},298136:function(e,t,i){i.d(t,{Z:function(){return c}});var n=i(257296),r=i(202426),a=i(563890),s=i(722169),o=i(690674),l=i(741720),d=i(907031);class c{get _scrollManager(){return this._renderer.scrollManager}boot(){}destroy(){this._removeListeners(),this._container=void 0,this._largeContainer=void 0}_updateViewportPosition(e){let{width:t,height:i,x:n,y:r}=this._renderer.camera.getViewport(),{width:a,height:s}=this._renderer.camera.getWorldBounds();void 0===e.left&&(e.left=n),void 0===e.top&&(e.top=r);let o=Math.max(0,Math.min(e.left,a-t)-this._layerOffsetX),l=Math.max(0,Math.min(e.top,s-i)),{camera:d}=this._renderer;d.setPosition(o,l)}_setPositionTop(e){this._largeContainer&&this._largeContainer.style.top!==e&&(this._largeContainer.style.top=e)}_restorePositionTop(){this._largeContainer&&(0,l.Z0)(this._largeContainer)}_keepViewport(e,t,i){let n=(0,l.W8)(e,(t-e)/2);e>t?this._setPositionTop(n):i<e?this._restorePositionTop():this._setPositionTop(n)}_setResizeInfo(e){this._store[o.U_].setResizeInfo(e)}_addListeners(){let{events:e}=this._renderer;e.store.on(r.ML.onOperationWidthInnerChange,this._updateLayerOffset),e.store.on(r.ML.viewportVisibleChange,this._onViewportVisibleChange),e.view.on(r.H2.scrollPrimaryTrackToViewBox,this._scrollPrimaryTrackToViewBox),e.view.on(r.H2.worldSizeChange,this._onWorldSizeChange),this._resizeObserver=new ResizeObserver(this._onResize),this._resizeObserver.observe(this._scrollManager.horizontalContainer,{box:"border-box"}),this._scrollManager.addEventListener("scroll",this._onScroll)}_removeListeners(){var e,t;let{events:i}=this._renderer;i.store.off(r.ML.onOperationWidthInnerChange,this._updateLayerOffset),i.store.off(r.ML.viewportVisibleChange,this._onViewportVisibleChange),i.view.on(r.H2.worldSizeChange,this._onWorldSizeChange),null===(e=this._scrollManager)||void 0===e||e.removeEventListener("scroll",this._onScroll),i.view.off(r.H2.scrollPrimaryTrackToViewBox,this._scrollPrimaryTrackToViewBox),null===(t=this._resizeObserver)||void 0===t||t.disconnect()}constructor(e,t,i){this._layerOffsetX=0,this._resizeDebounceWait=150,this._resizeThrottleWait=16,this._visible=!0,this._scrollPrimaryTrackToViewBox=()=>{let{children:e,camera:t}=this._renderer,{height:i}=t.getViewport(),{height:r}=t.getWorldBounds();if(i===r)return;let s=(0,a.Mq)(e,n.KX.Track).find(e=>0===e.data.cTrack[1]||!1);if(!s)return;let{y:o,height:l}=s.style;this._scrollManager.scrollTo({top:o-i+l+10})},this._onScroll=()=>{if(!!this._largeContainer)this._updateViewportPosition({left:this._scrollManager.scrollLeft,top:this._scrollManager.scrollTop})},this._updateLayerOffset=e=>{this._layerOffsetX=e;let{clientWidth:t,clientHeight:i}=this._scrollManager.horizontalContainer,{camera:n}=this._renderer;n.resize(t-d.w0-this._layerOffsetX,this._scrollManager.getHeight(i))},this._onViewportVisibleChange=e=>{this._visible=e;let{camera:t}=this._renderer;if(e){let{clientWidth:e,clientHeight:i}=this._scrollManager.horizontalContainer;t.resize(e-d.w0-this._layerOffsetX,this._scrollManager.getHeight(i))}else t.resize(0,0)},this._onResize=(0,s.throttle)(e=>{if(!this._largeContainer||!this._visible)return;let{isManualResizing:t}=this._store[o.U_];for(let i of e)if(i.borderBoxSize){let{inlineSize:e,blockSize:n}=i.borderBoxSize[0],{camera:r}=this._renderer,{height:a}=r.getRealBounds(),{height:s}=r.getWorldBounds();t&&this._keepViewport(s,a,n),this._setResizeInfo({isResizing:!0,worldHeight:s,contentHeight:a,containerHeight:n});this._cameraResize(e-d.w0-this._layerOffsetX,this._scrollManager.getHeight(n),{isResizing:!1,worldHeight:s,contentHeight:a,containerHeight:n},t)}},this._resizeThrottleWait),this._cameraResizeDirect=(e,t,i)=>{let{camera:n}=this._renderer;n.resize(e,t),this._setResizeInfo(i),this._restorePositionTop()},this._cameraResizeDebounced=(0,s.debounce)(this._cameraResizeDirect,this._resizeDebounceWait),this._cameraResize=(e,t,i,n)=>{n?this._cameraResizeDebounced(e,t,i):this._cameraResizeDirect(e,t,i)},this._onWorldSizeChange=(e,t)=>{let{width:i,height:n,y:r,x:a}=this._renderer.camera.getViewport(),{width:s,height:o}=e,l={};e.height!==t.height&&n<=o&&r+n>o&&(l.top=o),e.width<t.width&&(i>s&&this._renderer.camera.updateCameraBounds(),i<=s&&a+i>s&&(l.left=Math.min(s,this._scrollManager.scrollLeft||s))),e.width>t.width&&void 0!==this._scrollManager.scrollLeft&&(l.left=this._scrollManager.scrollLeft),Object.keys(l).length&&this._scrollManager.scrollTo(l)},this._renderer=e,this._layer=t,this._store=i,this._container=this._layer.getStage().content,this._largeContainer=this._container.parentElement,this._addListeners()}}},45783:function(e,t,i){i.d(t,{Z:function(){return g}});var n=i(563890),r=i(257296),a=i(202426),s=i(721244),o=i(426336),l=i(892230),d=i(153302),c=i(969242),u=i(5240),h=i(728631);class g{boot(){}destroy(){this._removeListeners()}setActive(e){if(this._active!==e)this._active=e,e?this._addListeners():this._removeListeners()}_addListeners(){let{events:e}=this._renderer;e.interact.on(a.TY.onAudioEnterTrim,this._enterTrimAudio),e.interact.on(a.TY.onAudioExitTrim,this._exitTrimAudio),e.store.on(a.ML.zoomChange,this._regenerateFullWavesImage),e.interact.on(a.TY.onSegmentCropping,this._onAudioCropping),e.store.on(a.ML.wavesChange,this._regenerateFullWavesImage),e.interact.on(a.TY.onAudioPlaceholderClick,this._onPlaceholderClick),e.interact.on(a.TY.onAudioTrimming,this._onSegmentTrimming),document.body.addEventListener("mousedown",this._clickExitTrimCheck)}_removeListeners(){let{events:e}=this._renderer;e.interact.off(a.TY.onAudioEnterTrim,this._enterTrimAudio),e.interact.off(a.TY.onAudioExitTrim,this._exitTrimAudio),e.store.off(a.ML.zoomChange,this._regenerateFullWavesImage),e.interact.off(a.TY.onSegmentCropping,this._onAudioCropping),e.store.off(a.ML.wavesChange,this._regenerateFullWavesImage),e.interact.off(a.TY.onAudioPlaceholderClick,this._onPlaceholderClick),e.interact.off(a.TY.onAudioTrimming,this._onSegmentTrimming),document.body.removeEventListener("mousedown",this._clickExitTrimCheck)}constructor(e,t,i){this._renderer=e,this._store=t,this._modules=i,this._segmentId2TrimDragStart=new Map,this._editId=null,this._getSourceWaves=e=>{if(!this._store)return[];let t=this._modules.resource.getSourceWaves(e);return(0,d.V)(null!=t?t:[],e)},this._generateFullWavesImage=e=>{var t;let i=(0,n.JP)(this._renderer.children,e);if(void 0===i)return;let{duration:a,prolong:s}=i.data.segment,l=null==s?void 0:s.total,d=this._getSourceWaves(i.data.segment),h=(0,c.vY)(this._renderer.camera.zoom,o.pMA.max([1n,null!=l?l:a],"bigint")),g=Math.min(h,1e4),m=(0,u.Gv)({waveforms:d||[],range:[0,(null==d?void 0:d.length)||0]},g,i.style.height,r.Ue),f=(0,u.Kw)(m||[],g,i.style.height*r.Ue,0,"transparent");i.updateData({audio:{...null!==(t=i.data.audio)&&void 0!==t?t:{},wavesImage:f,realWidth:h}},!0)},this._regenerateFullWavesImage=()=>{if(!!this._editId)this._generateFullWavesImage(this._editId)},this._enterTrimAudio=e=>{this._modules.player.pause(),this._editId&&this._exitTrimAudio(s.o.NORMAL),this._editId=e,(0,n.Mq)(this._renderer.children,r.KX.Segment).forEach(t=>{var i,n,r,a,o,l;if((null===(i=t.data)||void 0===i?void 0:i.segment.type)==="mutableAudio"){let{id:i,data:d}=t,{start:u=0n}=null!==(r=null==d?void 0:null===(n=d.segment)||void 0===n?void 0:n.prolong)&&void 0!==r?r:{};e===i?(t.updateData({audio:{...null!==(l=t.data.audio)&&void 0!==l?l:{},status:s.o.EDIT}},!0),this._segmentId2TrimDragStart.set(d.segment.id,-(0,c.vY)(null===(o=this._renderer)||void 0===o?void 0:null===(a=o.camera)||void 0===a?void 0:a.zoom,u))):t.setVisible(!1,!0)}}),this._generateFullWavesImage(e)},this._exitTrimAudio=e=>{if(!!this._editId)(0,n.Mq)(this._renderer.children,r.KX.Segment).forEach(t=>{var i,n,r,s;if((null===(i=t.data)||void 0===i?void 0:i.segment.type)==="mutableAudio"){if(this._editId===(null===(n=t.data)||void 0===n?void 0:n.segment.id)){let{data:i}=t;t.updateData({audio:{...null!==(r=t.data.audio)&&void 0!==r?r:{},status:e}},!0),this._renderer.events.interact.emit(a.TY.onAudioTrim,i.segment,Math.abs(null!==(s=this._segmentId2TrimDragStart.get(i.segment.id))&&void 0!==s?s:0))}else t.setVisible(!0,!0)}}),this._segmentId2TrimDragStart.delete(this._editId),this._editId=null},this._onAudioCropping=e=>{let{segment:t,type:i,value:a}=e,{zoom:s}=this._renderer.camera;if("start"===i){let e=function(e,t){let i=(0,n.JP)(t.children,e);if(!i||i.type!==r.KX.Segment)return null;let{segments:a}=i.data.track,s=a.findIndex(t=>t.id===e)-1;if(s>=0&&a[s]){let e=(0,n.JP)(t.children,a[s].id),i=null==e?void 0:e.data.segment;if((null==i?void 0:i.type)==="mutableAudio"&&(null==i?void 0:i.metaType)===o.cVg.MetaTypeNone)return e}return null}(t.id,this._renderer);if(e){let t=(a||0n)-e.data.segment.start,i=(0,c.vY)(s,t);e.updateStyle({width:i},!0)}}else if("duration"===i){let e=function(e,t){let i=(0,n.JP)(t.children,e);if(!i||i.type!==r.KX.Segment)return null;let{segments:a}=i.data.track,s=a.findIndex(t=>t.id===e)+1;if(s>0&&a[s]){let e=(0,n.JP)(t.children,a[s].id),i=null==e?void 0:e.data.segment;if((null==i?void 0:i.type)==="mutableAudio"&&(null==i?void 0:i.metaType)===o.cVg.MetaTypeNone)return e}return null}(t.id,this._renderer);if(e){let t=e.data.segment,i=a||0n,n=t.start+t.duration-i,r=(0,c.vY)(s,i),o=(0,c.vY)(s,n);e.updateStyle({width:o,x:r},!0)}}},this._onPlaceholderClick=e=>{if(!!this._store)e.metaType===o.cVg.MetaTypeNone&&(this._modules.selection.updateSelectData({segmentIds:[e.id]}),this._modules.sider.siderActiveTabSet(h.j.SiderMenuAudio))},this._onSegmentTrimming=(e,t)=>{this._segmentId2TrimDragStart.set(e,t)},this._clickExitTrimCheck=e=>{if(!this._editId)return;let{clientX:t,clientY:i}=e,o=this._renderer;if(o){var d,c,u,h,g;let e;for(let t of(0,n.Mq)(o.children,r.KX.Segment)){let{data:i}=t;if((null==i?void 0:null===(c=i.audio)||void 0===c?void 0:c.status)===s.o.EDIT&&(null==i?void 0:null===(u=i.segment)||void 0===u?void 0:u.type)==="mutableAudio"){e=t;break}}if(!e)return;let m=document.querySelector(".timeline-large-container");if(!m)return;let{x:f,y:p}=m.getBoundingClientRect(),{x:v,y:_,width:S,height:y}=o.camera.getViewport(),{data:x,style:b}=e,{x:M,y:T,height:I}=b,k=Math.abs(null!==(h=this._segmentId2TrimDragStart.get(x.segment.id))&&void 0!==h?h:0),D=null!==(g=null===(d=e.data.audio)||void 0===d?void 0:d.realWidth)&&void 0!==g?g:0,C=f+M-k,w=p+T,E={x:C,y:w},A={x:C+D,y:w+I},R={x:f+v,y:p+_},P={x:f+v+S,y:p+_+y},L={x:Math.max(E.x,R.x),y:Math.max(E.y,R.y)},N={x:Math.min(A.x,P.x),y:Math.min(A.y,P.y)};!((0,l.vX)(t,[L.x,N.x])&&(0,l.vX)(i,[L.y,N.y]))&&o.events.interact.emit(a.TY.onAudioExitTrim,s.o.NORMAL)}},this.setActive(!0)}}},721244:function(e,t,i){i.d(t,{j:function(){return s},o:function(){return a}});var n,r,a=((n={}).NORMAL="normal",n.FOCUS="focus",n.EDIT="edit",n);var s=((r={}).None="None",r.Empty="Empty",r.Placeholder="Placeholder",r.Loading="Loading",r)},96124:function(e,t,i){i.d(t,{Z:()=>k});var n=i("772322");i("17435");var r=i("629913"),a=i("218571"),s=i("801497"),o=i("105789"),l=i.n(o),d=i("150564"),c=i("112825"),u=i("670933"),h=i("728631"),g=i("202426"),m=i("937802"),f=i("230689"),p=i("690674"),v=i("574132"),_=i("589630"),S=i("695324"),y=i("177813");let x=(0,y.h)({Name:"Black Fade",Hint:"",SdkVersion:"1.1.0",AppVersion:"",FileUrl:{Uri:"13968cfcb6ace0ddd6d347b149f85289",UrlList:["https://lf16-effectcdn.byteeffecttos-g.com/obj/ies-fe-effect-va/13968cfcb6ace0ddd6d347b149f85289","https://lf19-effectcdn.byteeffecttos-g.com/obj/ies-fe-effect-va/13968cfcb6ace0ddd6d347b149f85289"]},IconUrl:{Uri:"f87a8fb1b06a7fb9e9faf1af41010e6d",UrlList:["https://lf16-effectcdn.byteeffecttos-g.com/obj/ies-fe-effect-va/f87a8fb1b06a7fb9e9faf1af41010e6d","https://lf19-effectcdn.byteeffecttos-g.com/obj/ies-fe-effect-va/f87a8fb1b06a7fb9e9faf1af41010e6d"]},Id:"13968cfcb6ace0ddd6d347b149f85289",EffectId:"670879",DevicePlatform:"all",Types:["GeneralEffect"],Tags:[],TagsUpdatedAt:"1585651929000",EffectType:0,Parent:"",Children:[],HintIcon:{Uri:"",UrlList:[]},Music:[],Source:0,Schema:"",Description:"",OriginalEffectId:"",IsFavorite:!1,Subtype:0,Requirements:[],Extra:'{"hover_icon":"f26e4f8ff31f9dbe40ef3fba52795ecf","is_business":true}',IsBusiness:!1,Countrys:[],PoiId:"0",IsPoi:!1,DesignerEncryptedId:"",SdkExtra:'{"transition":{"defaultDura":0.5,"isOverlap":false}}',SyncId:321492,ResourceId:"6724239388189921806",AdRawData:"",Channel:1,BindIds:[],PublishStatus:1,Ptime:158593335e4,GradeKey:"",ComposerParams:"",Panel:"transitions",ChallengeId:0,ModelNames:"",HintFileFormat:0,HintFile:{Uri:"",UrlList:[]},IsEst:!1,AppID:1124,OriginalExtra:"",HasProfileInfo:!1});var b=i("578350"),M=i("426336"),T=i("108692");let I="visibility 0.2s, opacity 0.2s",k=(0,u.f3)("store","modules")((0,u.Pi)(e=>{let{renderer:t,store:i,modules:o}=e,u=(0,m.G)(T.n),{loading:y,operationWidthInner:k=0}=i[p.U_],{coordinate:D,draftOperation:C,sider:w,resource:E}=o,[A,R]=(0,a.useState)({x:0,y:0}),[P,L]=(0,a.useState)(!1),[N,B]=(0,a.useState)(!1),O=(0,a.useRef)(!1),j=(0,a.useRef)(""),U=(0,a.useRef)(null),V=(0,a.useRef)(!1),F=(0,a.useRef)(0),z=(0,a.useRef)(!1),W=(0,a.useRef)(x),Y=(0,m.G)(f.t),K=(0,a.useCallback)(async()=>{let e=await w.getTransitionList({limit:1});e.length&&(W.current=e[0])},[w]),Z=(0,a.useCallback)(async()=>{if(!z.current)z.current=!0,B(!0),!await E.checkTransitionResource(x)&&await K(),B(!1)},[K,E]),G=(0,a.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];e&&U.current&&(U.current.style.transition="none",setTimeout(()=>{U.current&&(U.current.style.transition=I)},300)),F.current&&clearTimeout(F.current),O.current=!1,j.current="",V.current=!1,R({x:-20,y:-20}),L(!1)},[]),H=(0,a.useCallback)(e=>{if(!1===e)return;let{preSegId:t,segmentRegisterInfo:i}=e,{id:n,refEl:r}=i,a=0,s=r.y+r.height/2-10;R({x:a=t===n?r.x+k+r.width-10:r.x+k-10,y:s}),L(!0),j.current=t},[k]),X=(0,a.useCallback)(e=>{if(!O.current)if(!1===e)G();else{F.current&&clearTimeout(F.current);let t=setTimeout(()=>{H(e)},10);F.current=Number(t)}},[G,H]),Q=(0,a.useCallback)(e=>{let{status:t,waitTime:i,segmentId:n,segment:r,nextSegment:a}=e,{isVip:s,isBusiness:o,name:l}=W.current,d=C.getTrackIndexBySegmentId(n),c=[r,a].filter(e=>!!e).map(e=>(0,M.duj)(e)?e.templateId:"").filter(e=>!!e).join(",");(0,v.NR)(Y,{actionType:"click",addFrom:"add_track",isVip:s,optionType:"add",isCommercial:o,materialCategory:"trans",materialName:l,scene:"category",rank:0,batchCnt:1,status:t,waitTime:i,trackIndex:d,trackType:0===d?"main":"minor",templateId:c})},[Y,C]);return(0,a.useEffect)(()=>{var e,t,i,n,r;function a(){O.current=!0}function s(){G()}function o(e){e.stopPropagation()}function l(e){e.stopPropagation(),V.current=!0}async function d(){V.current&&!y&&((0,_.q)(Y),w.siderActiveTabSet(h.j.SiderMenuTransition),j.current&&((0,S.b)(Y,{relatedEvent:S.Z.AddMaterialToTrack,actionType:"click",optionType:"add"}),await Z(),C.transition.addTransitionByTransitionSource(W.current,j.current).then(e=>{let{ok:t}=e.result,{draftView:i}=u.dataSdk;Q({status:t?"success":"fail",waitTime:e.performanceDuration,segmentId:j.current,segment:t?e.result.value.segment:i.getSegmentById(j.current),nextSegment:t?e.result.value.nextSegment:i.findNextSegment(j.current)}),G(!0)}))),V.current=!1}return null===(e=U.current)||void 0===e||e.addEventListener("mouseenter",a),null===(t=U.current)||void 0===t||t.addEventListener("mouseleave",s),null===(i=U.current)||void 0===i||i.addEventListener("mousedown",l),null===(n=U.current)||void 0===n||n.addEventListener("mouseup",d),null===(r=U.current)||void 0===r||r.addEventListener("dblclick",o),()=>{var e,t,i,n,r;null===(e=U.current)||void 0===e||e.removeEventListener("mouseenter",a),null===(t=U.current)||void 0===t||t.removeEventListener("mouseleave",s),null===(i=U.current)||void 0===i||i.removeEventListener("mousedown",l),null===(n=U.current)||void 0===n||n.removeEventListener("mouseup",d),null===(r=U.current)||void 0===r||r.removeEventListener("dblclick",o)}},[G,y,C.transition,Z,Y,w,Q]),(0,a.useEffect)(()=>(D.on(c.B.showTransitionAddBtn,X),()=>{D.off(c.B.showTransitionAddBtn,X)}),[D,X]),(0,a.useEffect)(()=>{function e(){G()}return null==t||t.events.view.on(g.H2.viewportZoomChange,e),()=>{null==t||t.events.view.off(g.H2.viewportZoomChange,e)}},[t,G]),(0,n.jsx)(r.Z,{content:P?s.oc.t("web_transition_hover_add_transition",{},"Add transition"):"",disabled:!P,children:(0,n.jsx)("div",{className:l()(b.Z.transitionAddIcon,{[b.Z.showIcon]:P,[b.Z.hiddenIcon]:!P,[b.Z.disableIcon]:y||N}),ref:U,style:{transform:`translate(${A.x}px, ${A.y}px)`,width:"20px",height:"20px",transition:I},children:(0,n.jsx)(d.$cv,{fontSize:12})})})}))},195202:function(e,t,i){i.d(t,{d:function(){return o}});var n=i(218571),r=i(161247),a=i(907500),s=i(6409);function o(e,t,i,o){let{coordinate:l}=o,d=(0,n.useMemo)(()=>l.makeController(o),[]);(0,n.useEffect)(()=>{t.current&&d.crop.setRenderer(t.current)},[t.current]);let c=(0,r.U)();(0,n.useEffect)(()=>{if(t.current&&e.current){if(c)return e.current&&l.establish(e.current),()=>{l.relinquish()}}else throw Error("coordinate establish failed")},[c]),(0,a.t)(t,l,i,o,d),(0,s.$)(t,l)}},171495:function(e,t,i){i.d(t,{$:function(){return o}});var n=i(218571),r=i(432092),a=i(797637),s=i.n(a);function o(e){let[t,i,a]=s()(0),[o,l]=(0,n.useState)(0),d=(0,n.useCallback)(()=>{let e=document.querySelector(".timeline-bd-vertical-scroll");l(a.current-((null==e?void 0:e.scrollTop)||0))},[]);return(0,n.useLayoutEffect)(()=>{let t=document.querySelector(".timeline-bd-vertical-scroll"),n=e=>{var t;i(null!==(t=null==e?void 0:e.y)&&void 0!==t?t:0),d()};e.uiEvents.on(r.W.MAIN_TRACK_POSITION_CHANGE,n);let a=()=>{d()};return null==t||t.addEventListener("scroll",a),()=>{null==t||t.removeEventListener("scroll",a),e.uiEvents.off(r.W.MAIN_TRACK_POSITION_CHANGE,n)}},[]),{mainTrackY:t,mainTrackTop:o}}},357940:function(e,t,i){i.d(t,{Gk:function(){return h},M9:function(){return l},OX:function(){return m},V$:function(){return v},j9:function(){return u},uQ:function(){return f},yX:function(){return p}});var n=i(492662),r=i(426336),a=i(68659),s=i(969242);let o=["video","mutable","mutablePoly","combination"];function l(e){return e&&o.includes(e)}let d=e=>{var t;return e?(null===(t=e.prolong)||void 0===t?void 0:t.total)&&e.prolong.total!==a.E2?e.prolong.total:e.duration||0n:0n},c=(e,t)=>{if(t.some(e=>e.timestamp)||0===t.length)return t;let i=0n,n=d(e);return n&&(i=n/BigInt(t.length)),t.map((e,t)=>({...e,timestamp:i*BigInt(t)}))},u=(e,t,i,n,r,o)=>{let{thumbnails:l,range:d}=e,c=l.slice(d[0],d[1]);if(!c.length||!t||!i||!o)return[];let{width:u,height:h}=function(e){if(!e)return{width:0,height:1};if("imageData"in e){let{width:t,height:i}=e.imageData;return{width:t,height:i}}let{width:t=0,height:i=1}=e;return{width:t,height:i}}(l[0]),g=i*n,m=g*u/h,f=Math.floor(m);if(0===f)return[];let p=(0,s.TF)(r,o*n*u/h)/BigInt(n),v=c[0].timestamp,_=0,S=(t*n-(m-f))/f,y=Math.min(Math.max(0,S),d[1]-d[0]),x=[],b=v,M=0,T=e=>Math.max(0,Math.floor(Number(c[e].timestamp-b)/Number(p))),I=e=>{let t=Math.min(c.length-1,M+1),i=Math.max(1,T(M));return function(e,t,i,n){if(i+n<e[t[0]].timestamp)return t[0];let r=a.E2,s=t[0];for(let a=t[0];a<t[1];a++){let t=i>=e[a].timestamp?i-e[a].timestamp:e[a].timestamp-i;if(t>r)break;i+n>e[a].timestamp&&(r=t,s=a)}return s}(c,[t,Math.max(t,c.length-Math.max(0,Math.floor(y-e)))],b+BigInt(i)*p,p)};for(let e=0;e<y;e++){let t=I(e),i=Math.max(1,T(t));if(b+=BigInt(i)*p,e>0&&(_+=f*x[x.length-1].repeatCount),x.push(function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=m,r=g,a=0;if("image"in e[t]){let i=e[t].width,s=e[t].height;(Math.abs(n-i)>2||Math.abs(r-s)>2)&&(n>r?a=(g-(r=s/i*n))/2:_=Math.max(0,Math.floor((m-(n=i/s*r))/2))+_)}return{source:e[t],dx:_,dy:a,dWidth:n,dHeight:r,repeatCount:i}}(c,M,i)),e+1>=y){x[x.length-1].repeatCount=Math.max(0,Math.ceil(S-_/f));continue}M=t}return x};function h(e,t,i){return Math.min(Math.abs(i)/t*e.length,e.length-1)}function g(e,t){let{dx:i,dWidth:n,repeatCount:r}=e;return Math.min(Math.max(0,Math.floor((t-i)/n)),r-1)}function m(e,t,i,r,a,s,o,l,d,c,u,h){let m=o||(0,n.o)(t,i),f=m.getContext("2d");if(!f)return m;if(f.clearRect(0,0,t,i),a<0||s<a||0===t||0===i)return m;let p=[];for(let i=a;i<=s;i++){let{source:n}=e[i];if(!n)continue;let o=e[i];if(i===a){let t=g(e[a],r);o={...o,startIndex:t}}else if(i===s){let i=g(e[s],r+t);o={...o,endIndex:i}}let l=i+1;l>=e.length&&(l=e.length-1);let c=function(e,t,i,n,r){let{source:a,dx:s,dy:o=0,dWidth:l,dHeight:d,repeatCount:c,startIndex:u=0,endIndex:h=c-1}=e,g=[],m=BigInt(h)-BigInt(u)+1n,f=(t-a.timestamp)/(m<=0n?1n:m),p=0n;for(let e=u;e<=h;e++)if("imageData"in a)n.putImageData(a.imageData,s+Math.floor(l)*e-i,0,0,0,l,d);else if("image"in a){let{image:t,x:c=0,y:h=0,width:m,height:v}=a;if(n.drawImage(t,c,h,m,v,s+Math.floor(l)*e-i,o,l,d),e>u){let t=a.timestamp+f*p,c=Number(t)/1e6,u=null;if(r){for(let e of r.cache.keys())if(.1>=Math.abs(c-e)){u=r.get(e);break}}null!=u&&(n.fillStyle="#000000",n.fillRect(s+Math.floor(l)*e-i,o,l,d),n.drawImage(u.snapshot,s+Math.floor(l)*e-i,o)),null==u&&g.push(t)}p++}return g}(o,e[l].source.timestamp,r,f,d);for(let e=0;e<c.length;e++)p.push(c[e])}if(u&&c&&h&&l){if((p=[...new Set(p)]).length>0){let t=[];for(let e=0;e<p.length;e++){let i=Number(p[e])/1e6;t.push(i)}l.genSnapshotFrame(u,c,p[0],p[p.length-1],t,!1,[e[0].dWidth,e[0].dHeight])}}return m}function f(e,t){let i=0,n=e.length;if(t.prolong){let{total:s,start:o,duration:l}=t.prolong;if(s!==a.E2&&0n!==s){let t=r.pMA.div(o,s),a=r.pMA.div(l,s);(i=Math.floor(t*e.length))>=e.length-1&&(i=e.length-1),i=Math.max(0,i);let d=Math.ceil(a*e.length);d<1&&(d=1),n=Math.min(i+d,e.length)}}return[i,n]}function p(e,t){let i=[...e];t.reverse&&(i=i.reverse());let n=i.some(e=>e.timestamp>0)?function(e,t){let i=0,n=e.length;e.sort((e,t)=>Number(e.timestamp-t.timestamp));let{start:r,duration:a}=t,s=0n===r?e=>e:e=>e-e%1000000n,o=e.findIndex(e=>s(r)===e.timestamp);i=-1===o?i:o;let l=e.findIndex(e=>s(r+a)<=e.timestamp);return[i,n=-1===l?n:l+1]}(i,t):f(i,t);return{thumbnails:c(t,i),range:n}}function v(e){if(!e)return;let t=e.getContext("2d");if(!!t)t.clearRect(0,0,e.width,e.height)}},977201:function(e,t,i){i.d(t,{W:function(){return n}});let n=(e,t)=>{let i={};for(let n in t){if(!("object"==typeof t[n]&&("categories"===n||"metrics"===n))){i[`${e}_${n}`]=t[n];continue}for(let r in t[n])i[`${e}_${r}`]=t[n][r]}return i}}}]);